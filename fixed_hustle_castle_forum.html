<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∞ Hustle Castle Council</title>
    
    <!-- ========================================= -->
    <!-- ü§ñ reCAPTCHA v3 - CONFIGURAZIONE CORRETTA -->
    <!-- ========================================= -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LfaD34rAAAAAGrhdKjEz-zgAFJP6_yY_6Q7Pyme" async defer></script>
    
    <!-- ========================================= -->
    <!-- üî• FIREBASE SDK v9 + SICUREZZA ROBUSTA   -->
    <!-- ========================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getDatabase, ref, push, set, get, onValue, off, serverTimestamp, onDisconnect, child, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';
        
        // üî• CONFIGURAZIONE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDjHhviNJSn13Mz0XhoJ9hrjgdPz88fRJU",
            authDomain: "hustlecastlecouncil.firebaseapp.com",
            databaseURL: "https://hustlecastlecouncil-default-rtdb.firebaseio.com",
            projectId: "hustlecastlecouncil",
            storageBucket: "hustlecastlecouncil.firebasestorage.app",
            messagingSenderId: "778970862600",
            appId: "1:778970862600:web:4244e17938ccf62c2eadbd",
            measurementId: "G-R3GMPZCXP3"
        };

        // üîë CONFIGURAZIONE reCAPTCHA v3 - CHIAVE CORRETTA
        const RECAPTCHA_V3_SITE_KEY = '6LfaD34rAAAAAGrhdKjEz-zgAFJP6_yY_6Q7Pyme';

        console.log('üè∞ Hustle Castle Council - Sistema Sicurezza Avanzato');
        console.log('üîë reCAPTCHA v3 Site Key:', RECAPTCHA_V3_SITE_KEY.substring(0, 20) + '...');
        
        // Variabili globali del sistema
        let useFirebase = true;
        let app = null;
        let appCheck = null;
        let appCheckEnabled = false;
        let recaptchaV3Ready = false;
        let securitySystemReady = false;
        
        try {
            // Inizializza Firebase
            app = initializeApp(firebaseConfig);
            console.log('üî• Firebase inizializzato con successo');
            
            // ========================================
            // üõ°Ô∏è SISTEMA SICUREZZA CORRETTO
            // ========================================
            
            // Verifica environment autorizzato
            function verifyEnvironment() {
                const authorizedDomains = [
                    'hustlecastleforum.netlify.app',
                    'hustlecastlecouncil.firebaseapp.com',
                    'localhost',
                    '127.0.0.1',
                    'claude.ai'
                ];
                
                const currentDomain = window.location.hostname;
                const isAuthorized = authorizedDomains.some(domain => 
                    currentDomain === domain || currentDomain.endsWith('.' + domain)
                );
                
                console.log('üåç Environment Check:');
                console.log('  - Domain:', currentDomain);
                console.log('  - Protocol:', window.location.protocol);
                console.log('  - Authorized:', isAuthorized);
                
                return isAuthorized;
            }

            // Caricamento reCAPTCHA semplificato
            async function loadRecaptchaV3() {
                console.log('ü§ñ Loading reCAPTCHA v3...');
                
                return new Promise((resolve) => {
                    let attempts = 0;
                    const maxAttempts = 20; // 10 secondi
                    
                    const checkRecaptcha = () => {
                        attempts++;
                        
                        if (typeof window.grecaptcha !== 'undefined' && 
                            window.grecaptcha.ready && 
                            typeof window.grecaptcha.execute === 'function') {
                            
                            window.grecaptcha.ready(async () => {
                                try {
                                    console.log('‚úÖ reCAPTCHA v3 ready');
                                    recaptchaV3Ready = true;
                                    resolve(true);
                                } catch (error) {
                                    console.warn('‚ö†Ô∏è reCAPTCHA v3 test failed:', error);
                                    recaptchaV3Ready = false;
                                    resolve(false);
                                }
                            });
                            return;
                        }
                        
                        if (attempts >= maxAttempts) {
                            console.warn('‚ö†Ô∏è reCAPTCHA v3 timeout - continuing without');
                            recaptchaV3Ready = false;
                            resolve(false);
                            return;
                        }
                        
                        setTimeout(checkRecaptcha, 500);
                    };
                    
                    checkRecaptcha();
                });
            }

            // Inizializzazione App Check semplificata
            async function initializeAppCheckSimple() {
                console.log('üõ°Ô∏è Initializing App Check...');
                
                try {
                    appCheck = initializeAppCheck(app, {
                        provider: new ReCaptchaV3Provider(RECAPTCHA_V3_SITE_KEY),
                        isTokenAutoRefreshEnabled: false
                    });
                    
                    console.log('‚úÖ App Check initialized');
                    appCheckEnabled = true;
                    return true;
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è App Check failed:', error.message);
                    appCheckEnabled = false;
                    return false;
                }
            }

            // Aggiorna status sistema
            function updateSystemStatus(message) {
                const statusEl = document.getElementById('firebase-status');
                if (statusEl) {
                    statusEl.textContent = message;
                    
                    if (message.includes('attivo') || message.includes('sicuro')) {
                        statusEl.className = 'status-secure';
                    } else if (message.includes('fallito') || message.includes('errore')) {
                        statusEl.className = 'status-warning';
                    } else {
                        statusEl.className = 'status-active';
                    }
                }
                
                console.log('üìä', message);
            }

            // ========================================
            // üöÄ INIZIALIZZAZIONE SEMPLIFICATA
            // ========================================
            
            async function initializeSecuritySystem() {
                try {
                    console.log('üöÄ Starting security system...');
                    updateSystemStatus('üîÑ Inizializzazione...');
                    
                    // 1. Verifica environment
                    const envOk = verifyEnvironment();
                    if (!envOk) {
                        console.warn('‚ö†Ô∏è Domain not in whitelist, but continuing...');
                    }
                    
                    // 2. Carica reCAPTCHA v3
                    updateSystemStatus('ü§ñ Caricamento reCAPTCHA...');
                    await loadRecaptchaV3();
                    
                    // 3. Inizializza App Check
                    updateSystemStatus('üõ°Ô∏è Configurazione sicurezza...');
                    await initializeAppCheckSimple();
                    
                    securitySystemReady = true;
                    updateSystemStatus('üî• Firebase attivo - Sistema pronto');
                    console.log('‚úÖ Security system ready!');
                    
                } catch (error) {
                    console.error('‚ùå Security initialization failed:', error);
                    securitySystemReady = false;
                    appCheckEnabled = false;
                    updateSystemStatus('üî• Firebase attivo - Modalit√† semplificata');
                }
            }

            // ========================================
            // ü§ñ FUNZIONI PUBBLICHE
            // ========================================
            
            // Verifica reCAPTCHA per login (semplificata)
            window.verifyRecaptcha = async function() {
                console.log('üîê reCAPTCHA verification called');
                
                if (!recaptchaV3Ready) {
                    console.log('üîê reCAPTCHA not ready, allowing login');
                    return true;
                }
                
                try {
                    if (typeof window.grecaptcha !== 'undefined' && window.grecaptcha.execute) {
                        const token = await window.grecaptcha.execute(RECAPTCHA_V3_SITE_KEY, {
                            action: 'login'
                        });
                        console.log('üîê reCAPTCHA token obtained');
                        return true;
                    }
                } catch (error) {
                    console.log('üîê reCAPTCHA error, allowing anyway:', error);
                }
                
                return true; // Sempre permetti il login
            };
            
            // Reset reCAPTCHA (compatibilit√†)
            window.resetRecaptcha = function() {
                console.log('üîÑ reCAPTCHA reset called');
            };

            // Callback caricamento reCAPTCHA
            window.onRecaptchaLoad = function() {
                console.log('ü§ñ reCAPTCHA callback triggered');
            };

            // ========================================
            // üß™ FUNZIONI DEBUG
            // ========================================
            
            window.checkSystemStatus = function() {
                console.log('\nüîç === SYSTEM STATUS ===');
                console.log('üî• Firebase App:', !!app);
                console.log('üõ°Ô∏è App Check Enabled:', appCheckEnabled);
                console.log('ü§ñ reCAPTCHA Ready:', recaptchaV3Ready);
                console.log('‚úÖ System Ready:', securitySystemReady);
                console.log('üåç Domain:', window.location.hostname);
                console.log('=== END STATUS ===\n');
            };

            window.testRecaptcha = async function() {
                if (!recaptchaV3Ready) {
                    console.log('‚ùå reCAPTCHA not ready');
                    return false;
                }
                
                try {
                    const token = await window.grecaptcha.execute(RECAPTCHA_V3_SITE_KEY, {
                        action: 'test'
                    });
                    console.log('‚úÖ reCAPTCHA test successful');
                    return true;
                } catch (error) {
                    console.log('‚ùå reCAPTCHA test failed:', error);
                    return false;
                }
            };

            window.forceFirebaseMode = function() {
                useFirebase = true;
                securitySystemReady = true;
                appCheckEnabled = false;
                updateSystemStatus('üî• Firebase forzato - Modalit√† semplice');
                console.log('üîß Firebase mode forced ON');
            };

            // Esponi oggetti globalmente
            window.firebaseApp = app;
            window.firebaseAuth = getAuth(app);
            window.firebaseDatabase = getDatabase(app);
            window.firebaseStorage = getStorage(app);
            window.useFirebase = useFirebase;
            window.appCheckEnabled = () => appCheckEnabled;
            window.recaptchaV3Ready = () => recaptchaV3Ready;
            window.securitySystemReady = () => securitySystemReady;
            
            // Esponi Firebase imports
            window.firebaseImports = {
                signInWithEmailAndPassword,
                createUserWithEmailAndPassword,
                onAuthStateChanged,
                signOut,
                updateProfile,
                GoogleAuthProvider,
                signInWithPopup,
                ref,
                push,
                set,
                get,
                onValue,
                off,
                serverTimestamp,
                onDisconnect,
                child,
                update,
                storageRef,
                uploadBytes,
                getDownloadURL,
                deleteObject
            };
            window.googleProvider = new GoogleAuthProvider();
            
            // ========================================
            // üöÄ AVVIA INIZIALIZZAZIONE CON TIMEOUT
            // ========================================
            
            function startSystem() {
                // Timeout di sicurezza
                setTimeout(() => {
                    if (!securitySystemReady) {
                        console.warn('‚è∞ Initialization timeout - forcing Firebase mode');
                        forceFirebaseMode();
                    }
                }, 15000); // 15 secondi timeout massimo
                
                // Inizializzazione normale
                setTimeout(() => {
                    initializeSecuritySystem().catch((error) => {
                        console.error('üö® Final initialization failed:', error);
                        forceFirebaseMode();
                    });
                }, 2000); // 2 secondi per sicurezza
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startSystem);
            } else {
                startSystem();
            }
            
            console.log('‚úÖ Security system loaded');
            console.log('üìù Debug commands: checkSystemStatus(), testRecaptcha(), forceFirebaseMode()');
            
        } catch (error) {
            console.error('‚ùå Critical Firebase error:', error);
            useFirebase = false;
            
            // Imposta modalit√† demo con messaggio specifico
            setTimeout(() => {
                const statusEl = document.getElementById('firebase-status');
                if (statusEl) {
                    statusEl.textContent = '‚ùå Errore Firebase - Modalit√† demo';
                    statusEl.className = 'status-warning';
                }
            }, 1000);
        }
    </script>
    
    <!-- CSS Files -->
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --accent-2: #2d82b5;
            --accent-3: #f39c12;
            --accent-4: #9b59b6;
            --text-primary: #ffffff;
            --text-secondary: #b8c6db;
            --text-muted: #7f8c8d;
            --border: #34495e;
            --card-bg: rgba(22, 33, 62, 0.8);
            --success: #27ae60;
            --warning: #f39c12;
            --error: #e74c3c;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #2d82b5 0%, #3498db 100%);
            --gradient-accent: linear-gradient(135deg, #e94560 0%, #f39c12 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(45, 130, 181, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(233, 69, 96, 0.2) 0%, transparent 50%);
        }

        /* Status System Styles */
        .status-secure {
            background: rgba(39, 174, 96, 0.15) !important;
            color: #27ae60 !important;
            border: 1px solid rgba(39, 174, 96, 0.3) !important;
        }
        
        .status-active {
            background: rgba(52, 152, 219, 0.15) !important;
            color: #3498db !important;
            border: 1px solid rgba(52, 152, 219, 0.3) !important;
        }
        
        .status-warning {
            background: rgba(241, 196, 15, 0.15) !important;
            color: #f39c12 !important;
            border: 1px solid rgba(241, 196, 15, 0.3) !important;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .login-form {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 2rem;
            background: var(--gradient-secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .login-tab {
            flex: 1;
            padding: 0.8rem;
            border: none;
            background: var(--secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-tab.active {
            background: var(--accent-2);
            color: white;
        }

        .google-login-btn {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: white;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .google-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
            color: var(--text-muted);
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border);
        }

        .divider span {
            background: var(--card-bg);
            padding: 0 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-2);
            box-shadow: 0 0 0 3px rgba(45, 130, 181, 0.2);
        }

        .registration-fields {
            display: none;
        }

        .form-buttons {
            margin-top: 2rem;
        }

        .btn-primary {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            background: var(--gradient-secondary);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(45, 130, 181, 0.3);
        }

        .error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--error);
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(231, 76, 60, 0.3);
            text-align: center;
            display: none;
        }

        .success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(39, 174, 96, 0.3);
            text-align: center;
            display: none;
        }

        .loading {
            text-align: center;
            color: var(--text-secondary);
            display: none;
            margin-top: 1rem;
        }

        /* Main Content Placeholder */
        .main-content {
            display: none;
            padding: 2rem;
            text-align: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .welcome-message {
            font-size: 2rem;
            margin-bottom: 1rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .demo-notice {
            background: rgba(241, 196, 15, 0.1);
            color: var(--warning);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid rgba(241, 196, 15, 0.3);
            margin-top: 2rem;
            max-width: 600px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .login-form {
                width: 95%;
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .login-form h2 {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-form">
            <h2>üè∞ Benvenuto nel Forum</h2>
            
            <!-- Tabs per Login/Registrazione -->
            <div class="login-tabs">
                <button id="loginTab" class="login-tab active" onclick="switchToLogin()">Accedi</button>
                <button id="registerTab" class="login-tab" onclick="switchToRegister()">Registrati</button>
            </div>
            
            <!-- Status Sistema Sicurezza -->
            <div id="firebase-status" class="status-active" style="text-align: center; margin-bottom: 15px; padding: 10px; border-radius: 8px; font-size: 12px; transition: all 0.3s ease;">
                üîÑ Inizializzazione...
            </div>
            
            <!-- Login con Google -->
            <button id="googleLoginBtn" class="google-login-btn" onclick="handleGoogleLogin()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span id="googleBtnText">Continua con Google</span>
            </button>
            
            <div class="divider">
                <span>oppure</span>
            </div>
            
            <div id="loginError" class="error"></div>
            <div id="loginSuccess" class="success"></div>
            
            <!-- Campi per registrazione (nascosti inizialmente) -->
            <div id="registrationFields" class="registration-fields">
                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" placeholder="Scegli il tuo username">
                </div>
            </div>
            
            <!-- Campi comuni -->
            <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" placeholder="Inserisci la tua email">
            </div>
            <div class="form-group">
                <label for="password">Password *</label>
                <input type="password" id="password" placeholder="Inserisci la password">
            </div>
            
            <div class="form-buttons">
                <button id="submitBtn" class="btn-primary" onclick="handleSubmit()">Accedi</button>
            </div>
            
            <div id="loading" class="loading">
                <div>üîÑ Connessione in corso...</div>
            </div>
        </div>
    </div>

    <!-- Main Content (Hidden initially) -->
    <div class="main-content" id="mainContent" style="display: none;">
        <div class="welcome-message">
            üè∞ Benvenuto in Hustle Castle Council!
        </div>
        <p>Sistema caricato correttamente!</p>
        <button onclick="window.checkSystemStatus()" style="margin-top: 1rem; padding: 0.5rem 1rem; border: none; border-radius: 5px; background: var(--accent-2); color: white; cursor: pointer;">
            Verifica Status Sistema
        </button>
        <div class="demo-notice">
            <strong>üìã Nota:</strong> Questo √® il sistema base. Firebase e reCAPTCHA sono configurati correttamente.
        </div>
    </div>

    <!-- Script JavaScript semplificato -->
    <script>
        // Variabili globali
        let isLoginMode = true;
        let currentUser = null;

        // Funzioni UI
        function switchToLogin() {
            isLoginMode = true;
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('registrationFields').style.display = 'none';
            document.getElementById('submitBtn').textContent = 'Accedi';
            document.getElementById('googleBtnText').textContent = 'Continua con Google';
            clearMessages();
        }

        function switchToRegister() {
            isLoginMode = false;
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registrationFields').style.display = 'block';
            document.getElementById('submitBtn').textContent = 'Registrati';
            document.getElementById('googleBtnText').textContent = 'Registrati con Google';
            clearMessages();
        }

        function clearMessages() {
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginSuccess').style.display = 'none';
        }

        function showError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('loginSuccess').style.display = 'none';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('loginSuccess');
            successEl.textContent = message;
            successEl.style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Gestione login/registrazione
        async function handleSubmit() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('Inserisci email e password');
                return;
            }

            // Controllo username per registrazione
            if (!isLoginMode) {
                const username = document.getElementById('username').value.trim();
                if (!username) {
                    showError('Inserisci un username');
                    return;
                }
            }

            clearMessages();
            showLoading(true);

            try {
                // Verifica reCAPTCHA
                if (typeof window.verifyRecaptcha === 'function') {
                    await window.verifyRecaptcha();
                }

                // Simula login/registrazione
                await new Promise(resolve => setTimeout(resolve, 1500));

                if (isLoginMode) {
                    // Login
                    if (typeof window.firebaseImports !== 'undefined' && window.useFirebase) {
                        // Usa Firebase se disponibile
                        const auth = window.firebaseAuth;
                        const userCredential = await window.firebaseImports.signInWithEmailAndPassword(auth, email, password);
                        currentUser = userCredential.user;
                        showSuccess('‚úÖ Login effettuato con successo!');
                    } else {
                        // Modalit√† demo
                        currentUser = { email: email, displayName: 'Demo User' };
                        showSuccess('‚úÖ Login demo effettuato!');
                    }
                } else {
                    // Registrazione
                    if (typeof window.firebaseImports !== 'undefined' && window.useFirebase) {
                        // Usa Firebase se disponibile
                        const auth = window.firebaseAuth;
                        const userCredential = await window.firebaseImports.createUserWithEmailAndPassword(auth, email, password);
                        currentUser = userCredential.user;
                        showSuccess('‚úÖ Registrazione completata!');
                    } else {
                        // Modalit√† demo
                        currentUser = { email: email, displayName: document.getElementById('username').value };
                        showSuccess('‚úÖ Registrazione demo completata!');
                    }
                }

                // Accesso riuscito
                setTimeout(() => {
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'flex';
                }, 1500);

            } catch (error) {
                console.error('Auth error:', error);
                
                if (error.code === 'auth/user-not-found') {
                    showError('‚ùå Utente non trovato');
                } else if (error.code === 'auth/wrong-password') {
                    showError('‚ùå Password errata');
                } else if (error.code === 'auth/email-already-in-use') {
                    showError('‚ùå Email gi√† registrata');
                } else {
                    showError('‚ùå Errore di autenticazione: ' + error.message);
                }
            } finally {
                showLoading(false);
            }
        }

        // Login con Google
        async function handleGoogleLogin() {
            clearMessages();
            showLoading(true);

            try {
                if (typeof window.firebaseImports !== 'undefined' && window.useFirebase) {
                    // Usa Firebase se disponibile
                    const auth = window.firebaseAuth;
                    const provider = window.googleProvider;
                    const result = await window.firebaseImports.signInWithPopup(auth, provider);
                    currentUser = result.user;
                    showSuccess('‚úÖ Login Google completato!');
                } else {
                    // Modalit√† demo
                    currentUser = { email: 'demo@google.com', displayName: 'Demo Google User' };
                    showSuccess('‚úÖ Login Google demo!');
                }

                setTimeout(() => {
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'flex';
                }, 1500);

            } catch (error) {
                console.error('Google login error:', error);
                showError('‚ùå Errore login Google: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè∞ Hustle Castle Council - Interface Ready');
            
            // Controllo periodico dello stato Firebase
            setInterval(() => {
                if (typeof window.securitySystemReady === 'function' && window.securitySystemReady()) {
                    const statusEl = document.getElementById('firebase-status');
                    if (statusEl && statusEl.textContent.includes('Inizializzazione')) {
                        statusEl.textContent = 'üî• Firebase attivo - Sistema pronto';
                        statusEl.className = 'status-secure';
                    }
                }
            }, 2000);

            // Enter key submit
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && document.getElementById('loginModal').style.display !== 'none') {
                    handleSubmit();
                }
            });
        });

        // Debug globale
        window.debugLogin = function() {
            console.log('\nüîç === LOGIN DEBUG ===');
            console.log('Login Mode:', isLoginMode);
            console.log('Current User:', currentUser);
            console.log('Firebase Available:', typeof window.firebaseImports !== 'undefined');
            console.log('Use Firebase:', window.useFirebase);
            console.log('reCAPTCHA Function:', typeof window.verifyRecaptcha);
            console.log('=== END DEBUG ===\n');
        };
    </script>
</body>
</html>