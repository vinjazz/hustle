<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏰 Hustle Castle Council</title>
    <!-- reCAPTCHA con callback personalizzato -->
    <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getDatabase, ref, push, set, get, onValue, off, serverTimestamp, onDisconnect, child, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';
        
        // 🔥 CONFIGURAZIONE FIREBASE - INIZIALIZZAZIONE SINGOLA
        const firebaseConfig = {
            apiKey: "AIzaSyDjHhviNJSn13Mz0XhoJ9hrjgdPz88fRJU",
            authDomain: "hustlecastlecouncil.firebaseapp.com",
            projectId: "hustlecastlecouncil",
            storageBucket: "hustlecastlecouncil.firebasestorage.app",
            messagingSenderId: "778970862600",
            appId: "1:778970862600:web:ba81f607bb6792362eadbd",
            measurementId: "G-N6XQ6W4PN7"
        };
        
        // Inizializza Firebase UNA SOLA VOLTA
        let useFirebase = true;
        let app = null;
        let appCheckEnabled = false;
        
        try {
            app = initializeApp(firebaseConfig);
            console.log('🔥 Firebase inizializzato con successo');
            
            // Prova ad inizializzare App Check, ma non bloccare se fallisce
            try {
                const appCheck = initializeAppCheck(app, {
                    provider: new ReCaptchaV3Provider('6LcMsncrAAAAAFOZQIAsv3oJBVs3-MfeTjDU9rSw'),
                    isTokenAutoRefreshEnabled: true
                });
                appCheckEnabled = true;
                console.log('🛡️ App Check inizializzato');
            } catch (appCheckError) {
                console.warn('⚠️ App Check non disponibile:', appCheckError.message);
                console.log('📝 Il forum funzionerà senza App Check');
            }
            
        } catch (error) {
            console.error('❌ Errore inizializzazione Firebase:', error);
            useFirebase = false;
            alert('⚠️ Firebase non configurato. Il forum funzionerà in modalità demo locale.');
        }
        
        const auth = useFirebase ? getAuth(app) : null;
        const database = useFirebase ? getDatabase(app) : null;
        const storage = useFirebase ? getStorage(app) : null;
        const googleProvider = useFirebase ? new GoogleAuthProvider() : null;
        
        // Esponi Firebase globalmente per compatibilità
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseStorage = storage;
        window.useFirebase = useFirebase;
        window.appCheckEnabled = appCheckEnabled;
        window.firebaseImports = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            signOut,
            updateProfile,
            GoogleAuthProvider,
            signInWithPopup,
            ref,
            push,
            set,
            get,
            onValue,
            off,
            serverTimestamp,
            onDisconnect,
            child,
            update,
            storageRef,
            uploadBytes,
            getDownloadURL,
            deleteObject
        };
        window.googleProvider = googleProvider;
        
        // 🤖 FUNZIONI reCAPTCHA - GESTIONE MIGLIORATA
        let recaptchaRendered = false;
        
        window.verifyRecaptcha = function() {
            if (!recaptchaRendered || typeof grecaptcha === 'undefined') {
                return true; // Permetti se reCAPTCHA non disponibile
            }
            const recaptchaResponse = grecaptcha.getResponse();
            return recaptchaResponse && recaptchaResponse.length > 0;
        };
        
        window.resetRecaptcha = function() {
            if (recaptchaRendered && typeof grecaptcha !== 'undefined') {
                try {
                    grecaptcha.reset();
                } catch (error) {
                    console.log('Reset reCAPTCHA ignorato:', error.message);
                }
            }
        };

        // Render reCAPTCHA quando è pronto - CON CONTROLLO DOPPIO RENDERING
        window.onRecaptchaLoad = function() {
            if (!window.useFirebase || !appCheckEnabled) {
                console.log('🤖 reCAPTCHA disabilitato - App Check non attivo');
                return;
            }
            
            if (recaptchaRendered) {
                console.log('🤖 reCAPTCHA già renderizzato, skip');
                return;
            }
            
            if (typeof grecaptcha !== 'undefined' && grecaptcha.render) {
                try {
                    const container = document.getElementById('recaptcha-container');
                    if (container && container.innerHTML === '') {
                        grecaptcha.render('recaptcha-container', {
                            'sitekey': '6LcMsncrAAAAAFOZQIAsv3oJBVs3-MfeTjDU9rSw',
                            'theme': 'dark',
                            'size': 'normal'
                        });
                        recaptchaRendered = true;
                        console.log('✅ reCAPTCHA renderizzato');
                    }
                } catch (error) {
                    console.log('⚠️ reCAPTCHA già presente o errore:', error.message);
                }
            }
        };
        
        // Carica reCAPTCHA quando Google reCAPTCHA è pronto - SOLO SE NECESSARIO
        window.addEventListener('load', () => {
            if (!window.useFirebase || !appCheckEnabled) {
                // Nascondi reCAPTCHA se App Check non è attivo
                const container = document.getElementById('recaptcha-container');
                if (container) {
                    container.parentElement.style.display = 'none';
                }
                return;
            }
            
            // Controlla periodicamente se reCAPTCHA è disponibile
            const checkRecaptcha = () => {
                if (typeof grecaptcha !== 'undefined' && grecaptcha.render && !recaptchaRendered) {
                    setTimeout(window.onRecaptchaLoad, 100);
                } else if (!recaptchaRendered) {
                    setTimeout(checkRecaptcha, 500);
                }
            };
            checkRecaptcha();
        });
    </script>
</head>
<link href="style.css" rel="stylesheet">
<body>
    <!-- Mobile Menu Toggle -->
    <button id="mobileMenuToggle" class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    
    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay" onclick="closeMobileMenu()"></div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status offline">🔴 Disconnesso</div>
    
    <!-- Message Counter -->
    <div id="messageCounter" class="message-counter">💬 0 messaggi</div>

    <!-- Notifications Bell -->
    <button id="notificationsBell" class="notifications-bell" onclick="toggleNotifications()">
        🔔
        <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
    </button>

    <!-- Notifications Panel -->
    <div id="notificationsPanel" class="notifications-panel">
        <div class="notifications-header">
            <span>🔔 Notifiche</span>
            <button class="clear-all-btn" onclick="clearAllNotifications()">Pulisci tutto</button>
        </div>
        <div id="notificationsList" class="notifications-list">
            <div class="notification-empty">
                <div class="empty-icon">🔕</div>
                <div>Nessuna notifica</div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-form">
            <h2>🏰 Benvenuto nel Forum</h2>
            
            <!-- Tabs per Login/Registrazione -->
            <div class="login-tabs">
                <button id="loginTab" class="login-tab active" onclick="switchToLogin()">Accedi</button>
                <button id="registerTab" class="login-tab" onclick="switchToRegister()">Registrati</button>
            </div>
            
            <div id="firebase-status" style="text-align: center; margin-bottom: 15px; padding: 10px; border-radius: 8px; font-size: 12px;">
                <!-- Status will be updated by JavaScript -->
            </div>
            
            <!-- Login con Google -->
            <button id="googleLoginBtn" class="google-login-btn" onclick="handleGoogleLogin()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span id="googleBtnText">Continua con Google</span>
            </button>
            
            <div class="divider">
                <span>oppure</span>
            </div>
            
            <div id="loginError" class="error"></div>
            <div id="loginSuccess" class="success"></div>
            
            <!-- Campi per registrazione (nascosti inizialmente) -->
            <div id="registrationFields" class="registration-fields">
                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" placeholder="Scegli il tuo username">
                </div>
            </div>
            
            <!-- Campi comuni -->
            <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" placeholder="Inserisci la tua email">
            </div>
            <div class="form-group">
                <label for="password">Password *</label>
                <input type="password" id="password" placeholder="Inserisci la password">
            </div>
            
            <!-- 🤖 reCAPTCHA Widget -->
            <div class="form-group" style="display: flex; justify-content: center; margin: 20px 0;">
                <div id="recaptcha-container"></div>
            </div>
            
            <div class="form-buttons">
                <button id="submitBtn" class="btn-primary" onclick="handleSubmit()">Accedi</button>
            </div>
            
            <div id="loading" class="loading">
                <div>🔄 Connessione in corso...</div>
            </div>
            
            <div style="text-align: center; margin-top: 15px; font-size: 11px; color: #666;">
                <p id="demo-hint">💡 Per testare: usa qualsiasi email/password per registrarti</p>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo">
            <h1>🏰 Hustle Castle Council</h1>
        </div>
        
        <div class="user-info" onclick="openUserProfile()">
            <div class="user-avatar" id="sidebarAvatar"></div>
            <div style="display: inline-block; vertical-align: middle;">
                <div class="user-name">
                    <span id="currentUsername">Ospite</span>
                    <span id="userStatus" class="offline-indicator"></span>
                </div>
                <div class="user-clan">Clan: <span id="currentClan">Nessuno</span></div>
                <button id="logoutBtn" class="logout-btn" style="display: none;" onclick="event.stopPropagation(); handleLogout()">Logout</button>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">🏠 Home</div>
            <div class="nav-item active" data-section="home">
                <span> Dashboard</span>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">🌍 Generale</div>
            <div class="nav-item" data-section="eventi">
                <span>📅 Eventi</span>
            </div>
            <div class="nav-item" data-section="oggetti">
                <span>⚔️ Oggetti</span>
            </div>
            <div class="nav-item" data-section="novita">
                <span>🆕 Novità</span>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">💬 Comunicazione</div>
            <div class="nav-item" data-section="chat-generale">
                <span>💬 Chat Generale</span>
            </div>
            <div class="nav-item" data-section="private-messages">
                <span>📨 Messaggi Privati</span>
            </div>
			<div class="nav-item" data-section="associa-clan">
                <span>🏠 Associa Clan</span>
            </div>
        </div>

        <div class="nav-section" id="adminSection" style="display: none;">
            <div class="nav-title">⚙️ Amministrazione</div>
            <div class="nav-item" data-section="admin-users">
                <span>👥 Gestione Utenti</span>
            </div>
            <div class="nav-item" data-section="admin-clans">
                <span>🏰 Gestione Clan</span>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">🛡️ Clan: <span id="sidebarClan">Nessuno</span></div>
            <div class="nav-item clan-only" data-section="clan-moderation" id="clanModerationItem" style="display: none;">
                <span>🛡️ Moderazione</span>
            </div>
            <div class="nav-item clan-only" data-section="clan-chat">
                <span>💬 Chat Clan</span>
            </div>
            <div class="nav-item clan-only" data-section="clan-war">
                <span>⚔️ Guerra</span>
            </div>
            <div class="nav-item clan-only" data-section="clan-premi">
                <span>🏆 Premi</span>
            </div>
            <div class="nav-item clan-only" data-section="clan-consigli">
                <span>💡 Consigli</span>
            </div>
			<div class="nav-item clan-only" data-section="clan-bacheca">
                <span>🏰 Bacheca</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Banner Hero -->
        <div class="banner">
            <div class="banner-content">
                <div class="banner-title">⚔️ Hustle Castle Council ⚔️</div>
                <div class="banner-subtitle">Il Forum Ufficiale della Community</div>
            </div>
        </div>

        <div class="header">
            <h2 id="section-title">🏠 Dashboard</h2>
            <p id="section-description">Benvenuto nel Forum di Hustle Castle Council! Ecco le ultime novità</p>
        </div>

        <div class="content-area">
            <!-- Forum Layout -->
            <div class="forum-layout" id="forum-content">
                <div class="thread-list" id="thread-list">
                    <!-- I thread verranno generati dinamicamente -->
                </div>
            </div>

            <!-- Chat Layout -->
            <div class="chat-mode" id="chat-content">
                <div class="chat-messages" id="chat-messages">
                    <!-- I messaggi verranno generati dinamicamente -->
                </div>
                <div id="typingIndicator" class="typing-indicator"></div>
                <div class="chat-input">
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <div style="flex: 1;">
                            <input type="text" id="message-input" placeholder="Scrivi un messaggio..." />
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <div class="emoticon-picker">
                                <button class="emoticon-btn" onclick="toggleEmoticonPicker('chat')">😊</button>
                                <div class="emoticon-panel" id="chat-emoticon-panel">
                                    <div class="emoticon-grid">
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '😊')">😊</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '😂')">😂</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '🎉')">🎉</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '❤️')">❤️</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '👍')">👍</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '👎')">👎</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '🔥')">🔥</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '💪')">💪</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '🎯')">🎯</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '⚔️')">⚔️</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '🏰')">🏰</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '🛡️')">🛡️</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '🏆')">🏆</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '💎')">💎</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '⭐')">⭐</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '🚀')">🚀</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '💯')">💯</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '🤔')">🤔</button>
                                    </div>
                                </div>
                            </div>
                            <button id="send-message-btn" onclick="sendMessage()">Invia</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thread View -->
            <div class="thread-view" id="thread-view">
                <div style="width: 100%; display: flex; flex-direction: column; height: 100%;">
                    <button class="back-btn" onclick="backToForum()">← Torna al Forum</button>
                    
                    <div class="thread-header">
                        <h1 id="thread-title">Titolo Thread</h1>
                        <div class="thread-meta">
                            <span id="thread-author">Autore</span> • 
                            <span id="thread-date">Data</span> • 
                            <span id="thread-views">0 visualizzazioni</span>
                        </div>
                        <div class="thread-content" id="thread-content">
                            Contenuto del thread...
                        </div>
                    </div>
                    
                    <div class="thread-comments" id="thread-comments">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Nessun commento ancora. Sii il primo a commentare!
                        </div>
                    </div>
                    
                    <div class="comment-input">
                        <div class="comment-input-container">
                            <div class="comment-input-main">
                                <div class="comment-textarea-container">
                                    <textarea id="comment-text" placeholder="Scrivi un commento..."></textarea>
                                </div>
                                <div class="comment-controls">
                                    <div class="comment-buttons-row">
                                        <button class="small-upload-btn" onclick="toggleCommentImageUpload()" title="Aggiungi immagine">📷</button>
                                        <div class="emoticon-picker">
                                            <button class="emoticon-btn" onclick="toggleEmoticonPicker('comment')">😊</button>
                                            <div class="emoticon-panel" id="comment-emoticon-panel">
                                                <div class="emoticon-grid">
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '😊')">😊</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '😂')">😂</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '🎉')">🎉</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '❤️')">❤️</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '👍')">👍</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '👎')">👎</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '🔥')">🔥</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '💪')">💪</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '🎯')">🎯</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '⚔️')">⚔️</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '🏰')">🏰</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '🛡️')">🛡️</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '🏆')">🏆</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '💎')">💎</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '⭐')">⭐</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '🚀')">🚀</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '💯')">💯</button>
                                                    <button class="emoticon-item" onclick="addEmoticon('comment', '🤔')">🤔</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button id="submit-comment-btn" onclick="addComment()" class="submit-comment-btn">Commenta</button>
                                </div>
                            </div>
                            
                            <!-- Image Upload Section for Comments -->
                            <div id="comment-image-upload" class="comment-image-upload">
                                <label for="comment-image-input" class="image-upload-label">
                                    📷 Seleziona Immagine
                                </label>
                                <input type="file" id="comment-image-input" accept="image/*" class="image-upload-input" />
                                <div id="comment-image-preview" class="image-preview"></div>
                                <div id="comment-upload-progress" class="upload-progress"></div>
                            </div>
                        </div>
                    </div>
				</div>
            </div>
        </div>
    </div>

    <button id="new-thread-btn" class="new-thread-btn" onclick="showThreadCreationModal()">+ Nuovo Thread</button>

    <!-- Thread Creation Modal -->
    <div id="threadCreationModal" class="thread-creation-modal">
        <div class="thread-creation-form">
            <h3>🏰 Crea Nuovo Thread</h3>
            
            <input type="text" id="thread-title-input" placeholder="Titolo del thread *" />
            <textarea id="thread-content-input" placeholder="Contenuto del thread *"></textarea>
            
            <!-- Image Upload Section -->
            <div class="image-upload-section">
                <label for="thread-image-input" class="image-upload-label">
                    📷 Aggiungi Immagine (opzionale)
                </label>
                <input type="file" id="thread-image-input" accept="image/*" class="image-upload-input" />
                <div id="image-preview" class="image-preview"></div>
                <div id="upload-progress" class="upload-progress"></div>
            </div>
            
            <div class="thread-creation-buttons">
                <button class="btn-create-thread" onclick="createThread()">Crea Thread</button>
                <button class="btn-cancel-thread" onclick="hideThreadCreationModal()">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Image Modal for fullscreen view -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="close-modal">&times;</span>
        <img id="modalImage" src="" alt="Immagine a schermo intero">
    </div>

    <!-- User Profile Modal -->
    <div id="userProfileModal" class="user-profile-modal">
        <div class="user-profile-container">
            <div class="user-profile-header">
                <button class="close-profile-btn" onclick="closeUserProfile()">&times;</button>
                <div class="profile-avatar-container">
                    <div class="profile-avatar" id="profileAvatar">
                        <img id="profileAvatarImg" style="display: none;" />
                    </div>
                    <button class="change-avatar-btn" onclick="changeAvatar()" title="Cambia avatar">📷</button>
                    <input type="file" id="avatarUpload" class="avatar-upload-input" accept="image/*" />
                </div>
                <div class="profile-username" id="profileUsername">Username</div>
                <div class="profile-clan-badge" id="profileClanBadge">Nessun Clan</div>
            </div>
            <div class="user-profile-body">
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="userThreadsCount">0</div>
                        <div class="profile-stat-label">Thread</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="userCommentsCount">0</div>
                        <div class="profile-stat-label">Commenti</div>
                    </div>
                </div>
                <div class="profile-field">
                    <label for="profileNickname">Nickname</label>
                    <input type="text" id="profileNickname" placeholder="Il tuo nickname" />
                </div>
                <div class="profile-field">
                    <label for="profileBio">Biografia</label>
                    <textarea id="profileBio" placeholder="Racconta qualcosa di te..."></textarea>
                </div>
                <div class="profile-field">
                    <label for="profileLocation">Posizione</label>
                    <input type="text" id="profileLocation" placeholder="Da dove scrivi?" />
                </div>
                <div class="profile-buttons">
                    <button class="btn-save-profile" onclick="saveUserProfile()">Salva</button>
                    <button class="btn-cancel-profile" onclick="closeUserProfile()">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Private Messages Modal -->
    <div id="privateMessagesModal" class="private-messages-modal">
        <div class="private-messages-container">
            <div class="private-messages-header">
                <h3>📨 Messaggi Privati</h3>
                <button class="close-messages-btn" onclick="closePrivateMessages()">&times;</button>
            </div>
            <div class="private-messages-body">
                <div class="conversations-list">
                    <div class="conversations-header">
                        <span style="font-weight: 600;">Conversazioni</span>
                        <button class="new-message-btn" onclick="showNewConversationModal()">+ Nuovo</button>
                    </div>
                    <div class="conversations-list-container" id="conversationsList">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Nessuna conversazione
                        </div>
                    </div>
                </div>
                <div class="conversation-view" id="conversationView">
                    <div class="conversation-empty">
                        <div class="conversation-empty-icon">💬</div>
                        <h3>Seleziona una conversazione</h3>
                        <p>Scegli una conversazione dalla lista o iniziane una nuova</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Conversation Modal -->
    <div id="newConversationModal" class="new-conversation-modal">
        <div class="new-conversation-form">
            <h3>💬 Nuova Conversazione</h3>
            <input type="text" id="userSearchInput" class="user-search-input" placeholder="Cerca un utente..." />
            <div id="userSearchResults" class="user-search-results"></div>
            <div class="new-conversation-buttons">
                <button class="btn-start-conversation" onclick="startConversation()" disabled>Inizia Chat</button>
                <button class="btn-cancel-conversation" onclick="closeNewConversationModal()">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Mention Suggestion Box (will be positioned dynamically) -->
    <div id="mentionSuggestionBox" class="mention-suggestion-box" style="display: none;"></div>

    <script>
        // Aspetta che Firebase sia caricato
        window.addEventListener('load', async () => {
            // Attendi che i moduli Firebase siano pronti
            await new Promise(resolve => {
                const checkFirebase = () => {
                    if (window.firebaseApp && window.firebaseAuth && window.firebaseDatabase) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });

            // Inizializza l'app
            initializeApp();
        });

        // Variabili globali
        let currentUser = null;
        let currentSection = 'home';
        let messageListeners = {};
        let threadListeners = {};
        let messageCount = 0;
        let isConnected = false;
        let firebaseReady = false;
        let isLoginMode = true; // true = login, false = register
        let currentUserData = null; // Dati completi dell'utente corrente
        let currentThread = null;
        let currentThreadId = null;
        let currentThreadSection = null;
		// Flag per evitare listener multipli
		let commentImageUploadInitialized = false;
        
        // Nuove variabili per le funzionalità aggiunte
        let userNotifications = [];
        let currentConversation = null;
        let selectedUserForConversation = null;
        let mentionSuggestionBox = null;
        let currentMentionInput = null;
        let availableUsers = [];
        let userProfiles = {};

        // Ruoli utente - DEVE essere definito prima di tutto
        const USER_ROLES = {
            SUPERUSER: 'superuser',
            CLAN_MOD: 'clan_mod',
            USER: 'user'
        };

        // Funzioni Firebase (saranno assegnate quando Firebase è pronto)
        let signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, 
            signOut, updateProfile, GoogleAuthProvider, signInWithPopup, ref, push, set, get, onValue, off, serverTimestamp, 
            onDisconnect, child, update, storageRef, uploadBytes, getDownloadURL, deleteObject;

        // Rendi le funzioni globali per gli onclick
        window.switchToLogin = switchToLogin;
        window.switchToRegister = switchToRegister;
        window.handleSubmit = handleSubmit;
        window.handleGoogleLogin = handleGoogleLogin;
        window.sendMessage = sendMessage;
        window.showThreadCreationModal = showThreadCreationModal;
        window.hideThreadCreationModal = hideThreadCreationModal;
        window.createThread = createThread;
        window.openThread = openThread;
        window.backToForum = backToForum;
        window.addComment = addComment;
        window.toggleEmoticonPicker = toggleEmoticonPicker;
        window.addEmoticon = addEmoticon;
        window.toggleMobileMenu = toggleMobileMenu;
        window.closeMobileMenu = closeMobileMenu;
        window.approveThread = approveThread;
        window.rejectThread = rejectThread;
        window.assignClan = assignClan;
        window.changeUserRole = changeUserRole;
        window.removFromClan = removFromClan;
        window.createNewClan = createNewClan;
        window.deleteClan = deleteClan;
        window.switchSection = switchSection;
        window.handleImageSelect = handleImageSelect;
        window.removeSelectedImage = removeSelectedImage;
        window.openImageModal = openImageModal;
        window.closeImageModal = closeImageModal;
		window.toggleCommentImageUpload = toggleCommentImageUpload;
		window.handleCommentImageSelect = handleCommentImageSelect;
		window.removeCommentSelectedImage = removeCommentSelectedImage;
		window.cleanupCommentImageUpload = cleanupCommentImageUpload;
        
        // Nuove funzioni globali
        window.toggleNotifications = toggleNotifications;
        window.clearAllNotifications = clearAllNotifications;
        window.openUserProfile = openUserProfile;
        window.closeUserProfile = closeUserProfile;
        window.changeAvatar = changeAvatar;
        window.saveUserProfile = saveUserProfile;
        window.openPrivateMessages = openPrivateMessages;
        window.closePrivateMessages = closePrivateMessages;
        window.showNewConversationModal = showNewConversationModal;
        window.closeNewConversationModal = closeNewConversationModal;
        window.startConversation = startConversation;
        window.selectConversation = selectConversation;
        window.sendPrivateMessage = sendPrivateMessage;

        // Funzioni per la gestione dei ruoli
        function getCurrentUserRole() {
            return currentUserData?.role || USER_ROLES.USER;
        }

        function getCurrentUserClan() {
            const clanElement = document.getElementById('currentClan');
            return clanElement ? clanElement.textContent : 'Nessuno';
        }

        function hasRole(requiredRole) {
            const currentRole = getCurrentUserRole();
            if (currentRole === USER_ROLES.SUPERUSER) return true;
            if (requiredRole === USER_ROLES.CLAN_MOD && currentRole === USER_ROLES.CLAN_MOD) return true;
            if (requiredRole === USER_ROLES.USER) return true;
            return false;
        }

        function isClanModerator() {
            const currentRole = getCurrentUserRole();
            const userClan = getCurrentUserClan();
            return (currentRole === USER_ROLES.CLAN_MOD || currentRole === USER_ROLES.SUPERUSER) && userClan !== 'Nessuno';
        }

        function canModerateSection(sectionKey) {
            const currentRole = getCurrentUserRole();
            const userClan = getCurrentUserClan();
            
            if (currentRole === USER_ROLES.SUPERUSER) return true;
            
            if (sectionKey.startsWith('clan-') && currentRole === USER_ROLES.CLAN_MOD) {
                return userClan !== 'Nessuno';
            }
            
            return false;
        }

        function canAccessSection(sectionKey) {
            const section = sectionConfig[sectionKey];
            if (!section) return false;
            
            // Controllo accesso clan
            if (sectionKey.startsWith('clan-') && getCurrentUserClan() === 'Nessuno') {
                return false;
            }
            
            // Controllo accesso admin (solo superuser)
            if (section.requiredRole === USER_ROLES.SUPERUSER && getCurrentUserRole() !== USER_ROLES.SUPERUSER) {
                return false;
            }
            
            return true;
        }

        // Configurazione sezioni - DEVE essere definito dopo USER_ROLES
        const sectionConfig = {
            'home': {
                title: '🏠 Dashboard',
                description: 'Benvenuto nel Forum di Hustle Castle Council! Ecco le ultime novità',
                type: 'dashboard'
            },
            'eventi': {
                title: '📅 Eventi',
                description: 'Scopri tutti gli eventi in corso e futuri di Hustle Castle Council',
                type: 'forum'
            },
            'oggetti': {
                title: '⚔️ Oggetti',
                description: 'Discussioni su armi, armature e oggetti del gioco',
                type: 'forum'
            },
            'novita': {
                title: '🆕 Novità',
                description: 'Ultime notizie e aggiornamenti del gioco',
                type: 'forum'
            },
            'chat-generale': {
                title: '💬 Chat Generale',
                description: 'Chiacchiere libere tra tutti i giocatori',
                type: 'chat'
            },
            'private-messages': {
                title: '📨 Messaggi Privati',
                description: 'Conversazioni private con altri utenti',
                type: 'private-messages'
            },
			'associa-clan': {
                title: '🏠 Associa Clan',
                description: 'Richiedi di essere associato ad un clan',
                type: 'forum'
            },
            'admin-users': {
                title: '👥 Gestione Utenti',
                description: 'Pannello amministrativo per gestire utenti e clan',
                type: 'admin',
                requiredRole: USER_ROLES.SUPERUSER
            },
            'admin-clans': {
                title: '🏰 Gestione Clan',
                description: 'Creazione e gestione dei clan',
                type: 'admin',
                requiredRole: USER_ROLES.SUPERUSER
            },
            'clan-moderation': {
                title: '🛡️ Moderazione Clan',
                description: 'Gestione e approvazione contenuti del clan',
                type: 'clan-admin'
            },
            'clan-chat': {
                title: '💬 Chat Clan',
                description: 'Chat privata del tuo clan',
                type: 'chat'
            },
            'clan-war': {
                title: '⚔️ Guerra Clan',
                description: 'Strategie e coordinamento per le guerre tra clan',
                type: 'forum'
            },
            'clan-premi': {
                title: '🏆 Premi Clan',
                description: 'Ricompense e achievement del clan',
                type: 'forum'
            },
            'clan-consigli': {
                title: '💡 Consigli Clan',
                description: 'Suggerimenti e guide per i membri del clan',
                type: 'forum'
            },
			'clan-bacheca': {
                title: '🏰 Bacheca Clan',
                description: 'Messaggi importanti per i membri del clan',
                type: 'forum'
            }
        };

        // Inizializza l'applicazione
        function initializeApp() {
            console.log('🔥 Inizializzazione applicazione...');
            
            // Assegna funzioni Firebase se disponibili
            if (window.firebaseImports) {
                ({
                    signInWithEmailAndPassword,
                    createUserWithEmailAndPassword,
                    onAuthStateChanged,
                    signOut,
                    updateProfile,
                    GoogleAuthProvider,
                    signInWithPopup,
                    ref,
                    push,
                    set,
                    get,
                    onValue,
                    off,
                    serverTimestamp,
                    onDisconnect,
                    child,
                    update,
                    storageRef,
                    uploadBytes,
                    getDownloadURL,
                    deleteObject
                } = window.firebaseImports);
                firebaseReady = true;
            }
            
            // Aggiorna status Firebase nella modal
            const statusEl = document.getElementById('firebase-status');
            const hintEl = document.getElementById('demo-hint');
            
            if (window.useFirebase && window.firebaseAuth && firebaseReady) {
                console.log('✅ Modalità Firebase attiva');
                statusEl.style.background = 'rgba(0, 255, 0, 0.1)';
                statusEl.style.color = '#008800';
                
                if (window.appCheckEnabled) {
                    statusEl.textContent = '🔥 Firebase + App Check attivi - Sistema completo';
                } else {
                    statusEl.textContent = '🔥 Firebase attivo - App Check disabilitato (funzionalità ridotte)';
                }
                
                hintEl.innerHTML = `🔐 <strong>Primo accesso?</strong><br>
                    1. Registrati normalmente (sarai USER)<br>
                    2. Configura regole Firebase o usa admin@hustlecastle.com / admin123 (SUPER)<br>
                    3. Usa il pannello admin per promuovere il tuo account`;
                
                // Monitora stato autenticazione
                onAuthStateChanged(window.firebaseAuth, (user) => {
                    if (user) {
                        currentUser = user;
                        handleUserLogin(user);
                    } else {
                        currentUser = null;
                        handleUserLogout();
                    }
                });

                // Monitora connessione
                const connectedRef = ref(window.firebaseDatabase, '.info/connected');
                onValue(connectedRef, (snapshot) => {
                    isConnected = snapshot.val() === true;
                    updateConnectionStatus();
                });
            } else {
                console.log('⚠️ Modalità locale attiva');
                statusEl.style.background = 'rgba(255, 165, 0, 0.1)';
                statusEl.style.color = '#ff8800';
                statusEl.textContent = '⚠️ Modalità Demo - Login Google non disponibile';
                hintEl.textContent = '💡 Demo: SuperUser (admin@hustlecastle.com / admin123), Clan Mod (mod@draghi.com / mod123), User (player@leoni.com / player123)';
                
                // Nascondi pulsante Google e reCAPTCHA in modalità demo
                document.getElementById('googleLoginBtn').style.display = 'none';
                document.getElementById('recaptcha-container').style.display = 'none';
                
                // Inizializza dati di esempio per la demo
                initializeLocalData();
                // In modalità locale, mostra sempre il login
                handleUserLogout();
                // Simula connessione locale
                isConnected = true;
                updateConnectionStatus();
            }

            // Setup UI
            setupEventListeners();
            switchSection('home');
        }

        // Gestione login utente con notifiche
        function handleUserLogin(user) {
            console.log('👤 Utente loggato:', user.email);
            
            // Nascondi modal login
            document.getElementById('loginModal').style.display = 'none';
            
            // Aggiorna UI
            updateUserInterface();
            
            // Setup presenza utente
            setupUserPresence();
            
            // Carica dati utente
            loadUserProfile();
            
            // Setup controllo notifiche periodico
            setupNotificationPolling();
            
            // Aggiorna dashboard se è la sezione corrente
            if (currentSection === 'home') {
                setTimeout(() => {
                    loadDashboard();
                }, 500); // Piccolo delay per permettere il caricamento dei dati utente
            }
        }

        // Setup polling notifiche
        function setupNotificationPolling() {
            // Carica notifiche iniziali
            setTimeout(() => {
                loadNotifications();
            }, 2000);
            
            // Controlla nuove notifiche ogni 30 secondi
            setInterval(() => {
                if (currentUser) {
                    checkForNewNotifications();
                }
            }, 30000);
        }

        // Controlla nuove notifiche
        async function checkForNewNotifications() {
            if (!currentUser) return;
            
            try {
                let unreadCount = 0;
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const notificationsRef = ref(window.firebaseDatabase, `notifications/${currentUser.uid}`);
                    const snapshot = await get(notificationsRef);
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const notification = childSnapshot.val();
                            if (!notification.read) {
                                unreadCount++;
                            }
                        });
                    }
                } else {
                    // Modalità locale
                    const notifications = JSON.parse(localStorage.getItem(`hc_notifications_${currentUser.uid}`) || '[]');
                    unreadCount = notifications.filter(n => !n.read).length;
                }
                
                updateNotificationBadge(unreadCount);
                
            } catch (error) {
                console.error('Errore controllo notifiche:', error);
            }
        }

        // Gestione logout utente
        function handleUserLogout() {
            console.log('👤 Utente disconnesso');
            
            // Pulisci listeners
            cleanupListeners();
            
            // Reset dati utente
            currentUserData = null;
            
            // Reset UI
            document.getElementById('currentUsername').textContent = 'Ospite';
            document.getElementById('currentClan').textContent = 'Nessuno';
            document.getElementById('sidebarClan').textContent = 'Nessuno';
            document.getElementById('userStatus').className = 'offline-indicator';
            document.getElementById('logoutBtn').style.display = 'none';
            
            // Reset avatar
            updateSidebarAvatar(null);
            
            // Rimuovi badge ruolo
            const userNameElement = document.getElementById('currentUsername');
            const existingBadge = userNameElement.querySelector('.user-role');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Reset notifiche
            updateNotificationBadge(0);
            
            // Aggiorna accesso clan e admin
            updateClanSectionsAccess();
            updateAdminSectionsAccess();
            
            // Se si è in una sezione clan o admin, torna alla home
            if (currentSection.startsWith('clan-') || currentSection.startsWith('admin-') || currentSection === 'private-messages') {
                switchSection('home');
            }
            
            // Torna al forum se si è in vista thread
            if (document.getElementById('thread-view').style.display === 'flex') {
                backToForum();
            }
            
            // Mostra modal login
            document.getElementById('loginModal').style.display = 'flex';
        }

        // Carica profilo utente con avatar
        async function loadUserProfile() {
            if (!currentUser) {
                // In modalità locale, aggiorna comunque l'accesso clan
                updateClanSectionsAccess();
                return;
            }

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && get) {
                try {
                    const userRef = ref(window.firebaseDatabase, `users/${currentUser.uid}`);
                    const snapshot = await get(userRef);
                    
                    if (snapshot.exists()) {
                        currentUserData = snapshot.val();
                        document.getElementById('currentUsername').textContent = currentUserData.username || 'Utente';
                        document.getElementById('currentClan').textContent = currentUserData.clan || 'Nessuno';
                        document.getElementById('sidebarClan').textContent = currentUserData.clan || 'Nessuno';
                        
                        // Carica avatar utente
                        loadUserAvatar();
                        
                        // Aggiorna badge ruolo
                        updateUserRoleBadge();
                        
                        // Aggiorna dashboard se è la sezione corrente
                        if (currentSection === 'home') {
                            loadDashboard();
                        }
                    }
                } catch (error) {
                    console.error('Errore caricamento profilo:', error);
                }
            } else {
                // Modalità locale - carica da localStorage
                loadLocalUserProfile();
            }
            
            // Carica utenti disponibili per tagging e messaggi privati
            loadAvailableUsers();
            
            // Carica notifiche non lette
            if (currentUser) {
                loadNotifications();
            }
            
            // Aggiorna accesso clan e admin in ogni caso
            updateClanSectionsAccess();
            updateAdminSectionsAccess();
        }

        // Carica avatar utente
        async function loadUserAvatar() {
            if (!currentUser) return;
            
            try {
                let avatarUrl = null;
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const profileRef = ref(window.firebaseDatabase, `userProfiles/${currentUser.uid}`);
                    const snapshot = await get(profileRef);
                    
                    if (snapshot.exists()) {
                        avatarUrl = snapshot.val().avatarUrl;
                    }
                } else {
                    // Modalità locale
                    const profiles = JSON.parse(localStorage.getItem('hc_user_profiles') || '{}');
                    avatarUrl = profiles[currentUser.uid]?.avatarUrl;
                }
                
                updateSidebarAvatar(avatarUrl);
                
            } catch (error) {
                console.error('Errore caricamento avatar:', error);
            }
        }

        // Carica profilo locale
        function loadLocalUserProfile() {
            const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
            const userData = users[currentUser.email];
            
            if (userData) {
                // Controlla se questo utente dovrebbe essere superuser
                const realUsers = Object.values(users).filter(user => 
                    !user.uid.startsWith('super_admin_') && 
                    !user.uid.startsWith('clan_mod_') && 
                    !user.uid.startsWith('user_')
                );
                
                // Se è il primo utente reale e non ha ruolo superuser, assegnaglielo
                if (realUsers.length > 0 && realUsers[0].uid === userData.uid) {
                    if (!userData.role || userData.role === USER_ROLES.USER) {
                        userData.role = USER_ROLES.SUPERUSER;
                        users[currentUser.email] = userData;
                        localStorage.setItem('hc_local_users', JSON.stringify(users));
                        console.log('🎉 Utente promosso a SUPERUSER:', currentUser.email);
                        
                        // Mostra notifica
                        setTimeout(() => {
                            alert('🎉 Congratulazioni! Sei stato promosso a SUPERUSER come primo utente registrato!');
                        }, 1000);
                    }
                }
                
                currentUserData = userData;
                document.getElementById('currentUsername').textContent = userData.username;
                document.getElementById('currentClan').textContent = userData.clan || 'Nessuno';
                document.getElementById('sidebarClan').textContent = userData.clan || 'Nessuno';
                updateUserRoleBadge();
                
                // Carica avatar locale
                const profiles = JSON.parse(localStorage.getItem('hc_user_profiles') || '{}');
                const avatarUrl = profiles[currentUser.uid]?.avatarUrl;
                updateSidebarAvatar(avatarUrl);
                
                // Aggiorna dashboard se è la sezione corrente
                if (currentSection === 'home') {
                    loadDashboard();
                }
            }
        }

        // Aggiorna badge ruolo utente
        function updateUserRoleBadge() {
            const userNameElement = document.getElementById('currentUsername');
            const existingBadge = userNameElement.querySelector('.user-role');
            
            if (existingBadge) {
                existingBadge.remove();
            }
            
            const role = getCurrentUserRole();
            const badge = document.createElement('span');
            badge.className = `user-role role-${role.replace('_', '-')}`;
            
            switch (role) {
                case USER_ROLES.SUPERUSER:
                    badge.textContent = 'SUPER';
                    badge.className = 'user-role role-superuser';
                    break;
                case USER_ROLES.CLAN_MOD:
                    badge.textContent = 'MOD';
                    badge.className = 'user-role role-moderator';
                    break;
                default:
                    badge.textContent = 'USER';
                    badge.className = 'user-role role-user';
                    break;
            }
            
            userNameElement.appendChild(badge);
        }

        // Aggiorna accesso alle sezioni admin
        function updateAdminSectionsAccess() {
            const adminSection = document.getElementById('adminSection');
            const clanModerationItem = document.getElementById('clanModerationItem');
            
            // Mostra sezioni admin globali solo al superuser
            const canAccessGlobalAdmin = getCurrentUserRole() === USER_ROLES.SUPERUSER;
            
            if (canAccessGlobalAdmin) {
                adminSection.style.display = 'block';
            } else {
                adminSection.style.display = 'none';
                // Se si è in una sezione admin, torna agli eventi
                if (currentSection.startsWith('admin-')) {
                    switchSection('eventi');
                }
            }
            
            // Mostra moderazione clan se è moderatore o superuser del clan
            const canModerateClan = isClanModerator();
            
            if (canModerateClan) {
                clanModerationItem.style.display = 'block';
            } else {
                clanModerationItem.style.display = 'none';
                // Se si è nella sezione moderazione, torna alla chat clan
                if (currentSection === 'clan-moderation') {
                    switchSection('clan-chat');
                }
            }
        }

        // Setup presenza utente
        function setupUserPresence() {
            if (!currentUser || !window.useFirebase || !window.firebaseDatabase || !firebaseReady || !ref || !onDisconnect || !set || !child || !serverTimestamp) return;
            
            try {
                const userStatusRef = ref(window.firebaseDatabase, `presence/${currentUser.uid}`);
                const userRef = ref(window.firebaseDatabase, `users/${currentUser.uid}`);
                
                // Quando l'utente si disconnette, imposta offline
                onDisconnect(userStatusRef).set({
                    state: 'offline',
                    lastSeen: serverTimestamp()
                });
                
                // Aggiorna ultima visita
                set(child(userRef, 'lastSeen'), serverTimestamp());
                
                // Imposta online
                set(userStatusRef, {
                    state: 'online',
                    lastSeen: serverTimestamp()
                });
            } catch (error) {
                console.error('Errore setup presenza:', error);
            }
        }

        // Aggiorna interfaccia utente
        function updateUserInterface() {
            if (currentUser) {
                document.getElementById('userStatus').className = 'online-indicator';
                document.getElementById('logoutBtn').style.display = 'inline-block';
            }
            updateClanSectionsAccess();
        }

        // Aggiorna accesso alle sezioni clan
        function updateClanSectionsAccess() {
            const userClan = getCurrentUserClan();
            const clanItems = document.querySelectorAll('.nav-item.clan-only');
            
            clanItems.forEach(item => {
                if (userClan === 'Nessuno') {
                    item.classList.add('disabled');
                    item.style.pointerEvents = 'none';
                } else {
                    item.classList.remove('disabled');
                    item.style.pointerEvents = 'auto';
                }
            });
        }

        // Aggiorna stato connessione
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (window.useFirebase) {
                if (isConnected) {
                    statusEl.className = 'connection-status online';
                    statusEl.textContent = '🟢 Firebase Connesso';
                } else {
                    statusEl.className = 'connection-status offline';
                    statusEl.textContent = '🔴 Firebase Disconnesso';
                }
            } else {
                statusEl.className = 'connection-status online';
                statusEl.textContent = '🟡 Modalità Demo Locale';
            }
        }

        // Aggiorna avatar sidebar
        function updateSidebarAvatar(avatarUrl) {
            const sidebarAvatar = document.getElementById('sidebarAvatar');
            
            if (avatarUrl) {
                sidebarAvatar.innerHTML = `<img src="${avatarUrl}" alt="Avatar" />`;
                sidebarAvatar.classList.add('has-image');
            } else {
                sidebarAvatar.innerHTML = '';
                sidebarAvatar.classList.remove('has-image');
            }
        }

        // ========================
        // SISTEMA NOTIFICHE
        // ========================

        // Toggle pannello notifiche
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            const isVisible = panel.style.display === 'block';
            
            if (isVisible) {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                loadNotifications();
                // Segna tutte come lette dopo un breve delay
                setTimeout(() => {
                    markAllNotificationsAsRead();
                }, 1000);
            }
        }

        // Carica notifiche
        async function loadNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            
            if (!currentUser) {
                notificationsList.innerHTML = `
                    <div class="notification-empty">
                        <div class="empty-icon">🔐</div>
                        <div>Effettua l'accesso per vedere le notifiche</div>
                    </div>
                `;
                return;
            }
            
            try {
                let notifications = [];
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const notificationsRef = ref(window.firebaseDatabase, `notifications/${currentUser.uid}`);
                    const snapshot = await get(notificationsRef);
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            notifications.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                    }
                } else {
                    // Modalità locale
                    const localNotifications = JSON.parse(localStorage.getItem(`hc_notifications_${currentUser.uid}`) || '[]');
                    notifications = localNotifications;
                }
                
                // Ordina per data (più recenti prima)
                notifications.sort((a, b) => b.timestamp - a.timestamp);
                
                displayNotifications(notifications);
                updateNotificationBadge(notifications.filter(n => !n.read).length);
                
            } catch (error) {
                console.error('Errore caricamento notifiche:', error);
                notificationsList.innerHTML = `
                    <div class="notification-empty">
                        <div class="empty-icon">❌</div>
                        <div>Errore nel caricamento delle notifiche</div>
                    </div>
                `;
            }
        }

        // Mostra notifiche
        function displayNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="notification-empty">
                        <div class="empty-icon">🔕</div>
                        <div>Nessuna notifica</div>
                    </div>
                `;
                return;
            }
            
            notificationsList.innerHTML = notifications.map(notification => {
                const unreadClass = notification.read ? '' : 'unread';
                const icon = getNotificationIcon(notification.type);
                
                return `
                    <div class="notification-item ${unreadClass}" onclick="handleNotificationClick('${notification.id}', '${notification.type}')">
                        <div class="notification-content">
                            <div class="notification-icon">${icon}</div>
                            <div class="notification-text">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-time">${formatTime(notification.timestamp)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Ottieni icona notifica
        function getNotificationIcon(type) {
            const icons = {
                'mention': '👋',
                'thread_approval': '📝',
                'thread_approved': '✅',
                'thread_rejected': '❌',
                'private_message': '📨',
                'clan_invite': '🏰',
                'role_change': '⭐',
                'system': '🔔'
            };
            return icons[type] || '🔔';
        }

        // Gestisci click notifica
        function handleNotificationClick(notificationId, type) {
            // Segna come letta
            markNotificationAsRead(notificationId);
            
            // Naviga alla sezione appropriata
            switch (type) {
                case 'thread_approval':
                    if (isClanModerator()) {
                        switchSection('clan-moderation');
                    }
                    break;
                case 'private_message':
                    openPrivateMessages();
                    break;
                case 'clan_invite':
                    switchSection('home');
                    break;
                default:
                    // Chiudi pannello notifiche
                    document.getElementById('notificationsPanel').style.display = 'none';
                    break;
            }
        }

        // Segna notifica come letta
        async function markNotificationAsRead(notificationId) {
            if (!currentUser) return;
            
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const notificationRef = ref(window.firebaseDatabase, `notifications/${currentUser.uid}/${notificationId}`);
                    await update(notificationRef, { read: true });
                } else {
                    // Modalità locale
                    const notifications = JSON.parse(localStorage.getItem(`hc_notifications_${currentUser.uid}`) || '[]');
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.read = true;
                        localStorage.setItem(`hc_notifications_${currentUser.uid}`, JSON.stringify(notifications));
                    }
                }
                
                // Ricarica notifiche
                loadNotifications();
            } catch (error) {
                console.error('Errore aggiornamento notifica:', error);
            }
        }

        // Segna tutte come lette
        async function markAllNotificationsAsRead() {
            if (!currentUser) return;
            
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const notificationsRef = ref(window.firebaseDatabase, `notifications/${currentUser.uid}`);
                    const snapshot = await get(notificationsRef);
                    
                    if (snapshot.exists()) {
                        const updates = {};
                        snapshot.forEach((childSnapshot) => {
                            updates[`notifications/${currentUser.uid}/${childSnapshot.key}/read`] = true;
                        });
                        await update(ref(window.firebaseDatabase), updates);
                    }
                } else {
                    // Modalità locale
                    const notifications = JSON.parse(localStorage.getItem(`hc_notifications_${currentUser.uid}`) || '[]');
                    notifications.forEach(n => n.read = true);
                    localStorage.setItem(`hc_notifications_${currentUser.uid}`, JSON.stringify(notifications));
                }
                
                updateNotificationBadge(0);
            } catch (error) {
                console.error('Errore aggiornamento notifiche:', error);
            }
        }

        // Pulisci tutte le notifiche
        function clearAllNotifications() {
            if (!confirm('Eliminare tutte le notifiche?')) return;
            
            if (!currentUser) return;
            
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const notificationsRef = ref(window.firebaseDatabase, `notifications/${currentUser.uid}`);
                    set(notificationsRef, null);
                } else {
                    // Modalità locale
                    localStorage.removeItem(`hc_notifications_${currentUser.uid}`);
                }
                
                loadNotifications();
                updateNotificationBadge(0);
            } catch (error) {
                console.error('Errore eliminazione notifiche:', error);
            }
        }

        // Aggiorna badge notifiche
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            const bell = document.getElementById('notificationsBell');
            
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'flex';
                bell.classList.add('has-notifications');
            } else {
                badge.style.display = 'none';
                bell.classList.remove('has-notifications');
            }
        }

        // Invia notifica
        async function sendNotification(targetUserId, type, title, message, data = {}) {
            if (!targetUserId) return;
            
            const notification = {
                type: type,
                title: title,
                message: message,
                timestamp: window.useFirebase ? serverTimestamp() : Date.now(),
                read: false,
                data: data
            };
            
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const notificationsRef = ref(window.firebaseDatabase, `notifications/${targetUserId}`);
                    await push(notificationsRef, notification);
                } else {
                    // Modalità locale
                    const notifications = JSON.parse(localStorage.getItem(`hc_notifications_${targetUserId}`) || '[]');
                    notification.id = 'notif_' + Date.now();
                    notification.timestamp = Date.now();
                    notifications.push(notification);
                    localStorage.setItem(`hc_notifications_${targetUserId}`, JSON.stringify(notifications));
                }
            } catch (error) {
                console.error('Errore invio notifica:', error);
            }
        }

        // ========================
        // GESTIONE PROFILI UTENTE
        // ========================

        // Apri modal profilo utente
        function openUserProfile() {
            if (!currentUser) {
                alert('Devi effettuare l\'accesso per modificare il profilo');
                return;
            }
            
            const modal = document.getElementById('userProfileModal');
            modal.style.display = 'flex';
            
            // Carica dati utente correnti
            loadCurrentUserProfile();
            loadUserStats();
        }

        // Carica profilo utente corrente
        async function loadCurrentUserProfile() {
            try {
                let userProfile = null;
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const profileRef = ref(window.firebaseDatabase, `userProfiles/${currentUser.uid}`);
                    const snapshot = await get(profileRef);
                    userProfile = snapshot.exists() ? snapshot.val() : {};
                } else {
                    // Modalità locale
                    const profiles = JSON.parse(localStorage.getItem('hc_user_profiles') || '{}');
                    userProfile = profiles[currentUser.uid] || {};
                }
                
                // Popola i campi
                document.getElementById('profileUsername').textContent = currentUserData.username || 'Username';
                document.getElementById('profileClanBadge').textContent = currentUserData.clan || 'Nessun Clan';
                document.getElementById('profileNickname').value = userProfile.nickname || '';
                document.getElementById('profileBio').value = userProfile.bio || '';
                document.getElementById('profileLocation').value = userProfile.location || '';
                
                // Aggiorna avatar
                updateProfileAvatar(userProfile.avatarUrl);
                
            } catch (error) {
                console.error('Errore caricamento profilo:', error);
            }
        }

        // Carica statistiche utente
        async function loadUserStats() {
            try {
                let threadsCount = 0;
                let commentsCount = 0;
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    // Conta thread dell'utente
                    const allSections = Object.keys(sectionConfig).filter(s => sectionConfig[s].type === 'forum');
                    for (const section of allSections) {
                        const dataPath = getDataPath(section, 'threads');
                        if (dataPath) {
                            const threadsRef = ref(window.firebaseDatabase, dataPath);
                            const snapshot = await get(threadsRef);
                            if (snapshot.exists()) {
                                snapshot.forEach((childSnapshot) => {
                                    const thread = childSnapshot.val();
                                    if (thread.authorId === currentUser.uid) {
                                        threadsCount++;
                                    }
                                });
                            }
                        }
                    }
                    
                    // Conta commenti dell'utente (implementazione semplificata)
                    const statsRef = ref(window.firebaseDatabase, `userStats/${currentUser.uid}`);
                    const statsSnapshot = await get(statsRef);
                    if (statsSnapshot.exists()) {
                        const stats = statsSnapshot.val();
                        commentsCount = stats.commentsCount || 0;
                    }
                } else {
                    // Modalità locale - conta da localStorage
                    const stats = JSON.parse(localStorage.getItem(`hc_user_stats_${currentUser.uid}`) || '{}');
                    threadsCount = stats.threadsCount || 0;
                    commentsCount = stats.commentsCount || 0;
                }
                
                document.getElementById('userThreadsCount').textContent = threadsCount;
                document.getElementById('userCommentsCount').textContent = commentsCount;
                
            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
            }
        }

        // Aggiorna avatar profilo
        function updateProfileAvatar(avatarUrl) {
            const avatar = document.getElementById('profileAvatar');
            const avatarImg = document.getElementById('profileAvatarImg');
            
            if (avatarUrl) {
                avatarImg.src = avatarUrl;
                avatarImg.style.display = 'block';
                avatar.classList.add('has-image');
            } else {
                avatarImg.style.display = 'none';
                avatar.classList.remove('has-image');
            }
            
            // Aggiorna anche avatar sidebar
            updateSidebarAvatar(avatarUrl);
        }

        // Cambia avatar
        function changeAvatar() {
            const avatarUpload = document.getElementById('avatarUpload');
            avatarUpload.click();
        }

        // Salva profilo utente
        async function saveUserProfile() {
            if (!currentUser) return;
            
            const nickname = document.getElementById('profileNickname').value.trim();
            const bio = document.getElementById('profileBio').value.trim();
            const location = document.getElementById('profileLocation').value.trim();
            const avatarFile = document.getElementById('avatarUpload').files[0];
            
            const saveBtn = document.querySelector('.btn-save-profile');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';
            
            try {
                const profileData = {
                    nickname: nickname,
                    bio: bio,
                    location: location,
                    updatedAt: window.useFirebase ? serverTimestamp() : Date.now()
                };
                
                // Upload avatar se presente
                if (avatarFile) {
                    saveBtn.textContent = 'Caricando avatar...';
                    const avatarUrl = await uploadAvatar(avatarFile);
                    if (avatarUrl) {
                        profileData.avatarUrl = avatarUrl;
                    }
                }
                
                // Salva profilo
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const profileRef = ref(window.firebaseDatabase, `userProfiles/${currentUser.uid}`);
                    await set(profileRef, profileData);
                } else {
                    // Modalità locale
                    const profiles = JSON.parse(localStorage.getItem('hc_user_profiles') || '{}');
                    profiles[currentUser.uid] = profileData;
                    localStorage.setItem('hc_user_profiles', JSON.stringify(profiles));
                }
                
                // Aggiorna avatar se cambiato
                if (profileData.avatarUrl) {
                    updateProfileAvatar(profileData.avatarUrl);
                }
                
                alert('Profilo salvato con successo!');
                closeUserProfile();
                
            } catch (error) {
                console.error('Errore salvataggio profilo:', error);
                alert('Errore nel salvataggio del profilo');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salva';
            }
        }

        // Upload avatar
        async function uploadAvatar(file) {
            try {
                if (window.useFirebase && window.firebaseStorage && firebaseReady) {
                    const timestamp = Date.now();
                    const filename = `avatars/${currentUser.uid}/${timestamp}_${file.name}`;
                    const imageRef = storageRef(window.firebaseStorage, filename);
                    
                    const snapshot = await uploadBytes(imageRef, file);
                    return await getDownloadURL(snapshot.ref);
                } else {
                    // Modalità locale - converte in base64
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            resolve(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    });
                }
            } catch (error) {
                console.error('Errore upload avatar:', error);
                return null;
            }
        }

        // Chiudi modal profilo
        function closeUserProfile() {
            const modal = document.getElementById('userProfileModal');
            modal.style.display = 'none';
            
            // Reset form
            document.getElementById('avatarUpload').value = '';
        }

        // ========================
        // MESSAGGI PRIVATI
        // ========================

        // Apri modal messaggi privati
        function openPrivateMessages() {
            if (!currentUser) {
                alert('Devi effettuare l\'accesso per utilizzare i messaggi privati');
                return;
            }
            
            const modal = document.getElementById('privateMessagesModal');
            modal.style.display = 'flex';
            
            loadConversations();
            loadAvailableUsers();
        }

        // Carica conversazioni
        async function loadConversations() {
            const conversationsList = document.getElementById('conversationsList');
            
            try {
                let conversations = [];
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const conversationsRef = ref(window.firebaseDatabase, `conversations/${currentUser.uid}`);
                    const snapshot = await get(conversationsRef);
                    
                    if (snapshot.exists()) {
                        for (const [conversationId, conversationData] of Object.entries(snapshot.val())) {
                            conversations.push({
                                id: conversationId,
                                ...conversationData
                            });
                        }
                    }
                } else {
                    // Modalità locale
                    const localConversations = JSON.parse(localStorage.getItem(`hc_conversations_${currentUser.uid}`) || '[]');
                    conversations = localConversations;
                }
                
                // Ordina per ultima attività
                conversations.sort((a, b) => (b.lastActivity || 0) - (a.lastActivity || 0));
                
                displayConversations(conversations);
                
            } catch (error) {
                console.error('Errore caricamento conversazioni:', error);
                conversationsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Errore nel caricamento delle conversazioni
                    </div>
                `;
            }
        }

        // Mostra conversazioni
        function displayConversations(conversations) {
            const conversationsList = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Nessuna conversazione.<br>
                        Inizia una nuova conversazione!
                    </div>
                `;
                return;
            }
            
            conversationsList.innerHTML = conversations.map(conversation => {
                const otherUser = conversation.otherUser;
                const unreadClass = conversation.hasUnread ? 'unread' : '';
                const avatarUrl = getUserAvatar(otherUser.id);
                
                return `
                    <div class="conversation-item ${unreadClass}" onclick="selectConversation('${conversation.id}')">
                        <div class="conversation-info">
                            <div class="conversation-avatar">
                                ${avatarUrl ? `<img src="${avatarUrl}" alt="Avatar" />` : getInitials(otherUser.username)}
                            </div>
                            <div class="conversation-details">
                                <div class="conversation-name">${otherUser.username}</div>
                                <div class="conversation-last-message">${conversation.lastMessage || 'Nessun messaggio'}</div>
                            </div>
                        </div>
                        <div class="conversation-time">${formatTime(conversation.lastActivity)}</div>
                    </div>
                `;
            }).join('');
        }

        // Seleziona conversazione
        async function selectConversation(conversationId) {
            currentConversation = conversationId;
            
            // Aggiorna UI
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Carica messaggi della conversazione
            await loadConversationMessages(conversationId);
        }

        // Carica messaggi conversazione
        async function loadConversationMessages(conversationId) {
            const conversationView = document.getElementById('conversationView');
            
            try {
                let conversation = null;
                let messages = [];
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    // Carica dati conversazione
                    const conversationRef = ref(window.firebaseDatabase, `conversations/${currentUser.uid}/${conversationId}`);
                    const convSnapshot = await get(conversationRef);
                    conversation = convSnapshot.val();
                    
                    // Carica messaggi
                    const messagesRef = ref(window.firebaseDatabase, `conversationMessages/${conversationId}`);
                    const messagesSnapshot = await get(messagesRef);
                    
                    if (messagesSnapshot.exists()) {
                        messagesSnapshot.forEach((childSnapshot) => {
                            messages.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                    }
                } else {
                    // Modalità locale
                    const conversations = JSON.parse(localStorage.getItem(`hc_conversations_${currentUser.uid}`) || '[]');
                    conversation = conversations.find(c => c.id === conversationId);
                    
                    messages = JSON.parse(localStorage.getItem(`hc_conversation_messages_${conversationId}`) || '[]');
                }
                
                if (!conversation) return;
                
                // Ordina messaggi per timestamp
                messages.sort((a, b) => a.timestamp - b.timestamp);
                
                // Mostra interfaccia conversazione
                const otherUser = conversation.otherUser;
                const avatarUrl = getUserAvatar(otherUser.id);
                
                conversationView.innerHTML = `
                    <div class="conversation-header">
                        <div class="conversation-header-avatar">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="Avatar" />` : getInitials(otherUser.username)}
                        </div>
                        <div class="conversation-header-info">
                            <h4>${otherUser.username}</h4>
                            <div class="user-clan-badge">${otherUser.clan || 'Nessun Clan'}</div>
                        </div>
                    </div>
                    <div class="conversation-messages" id="conversationMessages">
                        ${messages.map(message => {
                            const isOwn = message.senderId === currentUser.uid;
                            const messageAvatarUrl = isOwn ? getUserAvatar(currentUser.uid) : avatarUrl;
                            
                            return `
                                <div class="private-message ${isOwn ? 'own' : ''}">
                                    <div class="private-message-avatar">
                                        ${messageAvatarUrl ? `<img src="${messageAvatarUrl}" alt="Avatar" />` : getInitials(isOwn ? (currentUserData.username || 'Tu') : otherUser.username)}
                                    </div>
                                    <div class="private-message-content">
                                        <div class="private-message-text">${escapeHtml(message.content)}</div>
                                        <div class="private-message-time">${formatTime(message.timestamp)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="conversation-input">
                        <div class="conversation-input-container">
                            <textarea id="privateMessageInput" placeholder="Scrivi un messaggio..." rows="1"></textarea>
                            <button class="send-private-message-btn" onclick="sendPrivateMessage()">Invia</button>
                        </div>
                    </div>
                `;
                
                // Auto-resize textarea
                const textarea = document.getElementById('privateMessageInput');
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
                
                // Enter per inviare
                textarea.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendPrivateMessage();
                    }
                });
                
                // Scroll to bottom
                const messagesContainer = document.getElementById('conversationMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
            } catch (error) {
                console.error('Errore caricamento messaggi:', error);
                conversationView.innerHTML = `
                    <div class="conversation-empty">
                        <div class="conversation-empty-icon">❌</div>
                        <h3>Errore</h3>
                        <p>Impossibile caricare i messaggi</p>
                    </div>
                `;
            }
        }

        // Invia messaggio privato
        async function sendPrivateMessage() {
            if (!currentConversation) return;
            
            const textarea = document.getElementById('privateMessageInput');
            const content = textarea.value.trim();
            
            if (!content) return;
            
            const sendBtn = document.querySelector('.send-private-message-btn');
            sendBtn.disabled = true;
            textarea.disabled = true;
            
            try {
                const message = {
                    senderId: currentUser.uid,
                    content: content,
                    timestamp: window.useFirebase ? serverTimestamp() : Date.now()
                };
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    // Salva messaggio
                    const messagesRef = ref(window.firebaseDatabase, `conversationMessages/${currentConversation}`);
                    await push(messagesRef, message);
                    
                    // Aggiorna conversazione
                    const conversationRef = ref(window.firebaseDatabase, `conversations/${currentUser.uid}/${currentConversation}`);
                    await update(conversationRef, {
                        lastMessage: content.substring(0, 50) + (content.length > 50 ? '...' : ''),
                        lastActivity: serverTimestamp(),
                        hasUnread: false
                    });
                } else {
                    // Modalità locale
                    message.timestamp = Date.now();
                    message.id = 'msg_' + Date.now();
                    
                    // Salva messaggio
                    const messages = JSON.parse(localStorage.getItem(`hc_conversation_messages_${currentConversation}`) || '[]');
                    messages.push(message);
                    localStorage.setItem(`hc_conversation_messages_${currentConversation}`, JSON.stringify(messages));
                    
                    // Aggiorna conversazione
                    const conversations = JSON.parse(localStorage.getItem(`hc_conversations_${currentUser.uid}`) || '[]');
                    const conversation = conversations.find(c => c.id === currentConversation);
                    if (conversation) {
                        conversation.lastMessage = content.substring(0, 50) + (content.length > 50 ? '...' : '');
                        conversation.lastActivity = Date.now();
                        conversation.hasUnread = false;
                        localStorage.setItem(`hc_conversations_${currentUser.uid}`, JSON.stringify(conversations));
                    }
                }
                
                // Reset input
                textarea.value = '';
                textarea.style.height = 'auto';
                
                // Ricarica messaggi
                loadConversationMessages(currentConversation);
                
                // Invia notifica all'altro utente
                const conversations = JSON.parse(localStorage.getItem(`hc_conversations_${currentUser.uid}`) || '[]');
                const conversation = conversations.find(c => c.id === currentConversation);
                if (conversation) {
                    sendNotification(
                        conversation.otherUser.id,
                        'private_message',
                        'Nuovo messaggio privato',
                        `${currentUserData.username} ti ha inviato un messaggio`,
                        { conversationId: currentConversation }
                    );
                }
                
            } catch (error) {
                console.error('Errore invio messaggio:', error);
                alert('Errore nell\'invio del messaggio');
            } finally {
                sendBtn.disabled = false;
                textarea.disabled = false;
                textarea.focus();
            }
        }

        // Chiudi modal messaggi privati
        function closePrivateMessages() {
            const modal = document.getElementById('privateMessagesModal');
            modal.style.display = 'none';
            currentConversation = null;
        }

        // ========================
        // NUOVA CONVERSAZIONE
        // ========================

        // Mostra modal nuova conversazione
        function showNewConversationModal() {
            const modal = document.getElementById('newConversationModal');
            modal.style.display = 'flex';
            
            // Setup ricerca utenti
            setupUserSearch();
        }

        // Setup ricerca utenti
        function setupUserSearch() {
            const searchInput = document.getElementById('userSearchInput');
            const resultsContainer = document.getElementById('userSearchResults');
            const startBtn = document.querySelector('.btn-start-conversation');
            
            searchInput.value = '';
            selectedUserForConversation = null;
            startBtn.disabled = true;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                if (query.length < 2) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                // Filtra utenti disponibili
                const filteredUsers = availableUsers.filter(user => 
                    user.id !== currentUser.uid && // Escludi se stesso
                    (user.username.toLowerCase().includes(query) || 
                     (user.clan && user.clan.toLowerCase().includes(query)))
                );
                
                displayUserSearchResults(filteredUsers);
            });
        }

        // Mostra risultati ricerca utenti
        function displayUserSearchResults(users) {
            const resultsContainer = document.getElementById('userSearchResults');
            
            if (users.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 15px; color: #666;">
                        Nessun utente trovato
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = users.map(user => {
                const avatarUrl = getUserAvatar(user.id);
                
                return `
                    <div class="user-search-item" onclick="selectUserForConversation('${user.id}', '${user.username}', '${user.clan || ''}')">
                        <div class="user-search-avatar">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="Avatar" />` : getInitials(user.username)}
                        </div>
                        <div class="user-search-info">
                            <div class="user-search-name">${user.username}</div>
                            <div class="user-search-clan">${user.clan || 'Nessun Clan'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Seleziona utente per conversazione
        function selectUserForConversation(userId, username, clan) {
            selectedUserForConversation = {
                id: userId,
                username: username,
                clan: clan
            };
            
            // Aggiorna UI
            document.querySelectorAll('.user-search-item').forEach(item => {
                item.style.background = '';
            });
            event.currentTarget.style.background = 'var(--hover-bg)';
            
            // Abilita pulsante
            const startBtn = document.querySelector('.btn-start-conversation');
            startBtn.disabled = false;
        }

        // Inizia conversazione
        async function startConversation() {
            if (!selectedUserForConversation) return;
            
            const startBtn = document.querySelector('.btn-start-conversation');
            startBtn.disabled = true;
            startBtn.textContent = 'Creando...';
            
            try {
                const conversationId = `${currentUser.uid}_${selectedUserForConversation.id}_${Date.now()}`;
                
                const conversationData = {
                    id: conversationId,
                    otherUser: selectedUserForConversation,
                    lastMessage: '',
                    lastActivity: window.useFirebase ? serverTimestamp() : Date.now(),
                    hasUnread: false
                };
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const conversationRef = ref(window.firebaseDatabase, `conversations/${currentUser.uid}/${conversationId}`);
                    await set(conversationRef, conversationData);
                } else {
                    // Modalità locale
                    const conversations = JSON.parse(localStorage.getItem(`hc_conversations_${currentUser.uid}`) || '[]');
                    conversationData.lastActivity = Date.now();
                    conversations.push(conversationData);
                    localStorage.setItem(`hc_conversations_${currentUser.uid}`, JSON.stringify(conversations));
                }
                
                // Chiudi modal e ricarica conversazioni
                closeNewConversationModal();
                loadConversations();
                
                // Seleziona la nuova conversazione
                setTimeout(() => {
                    selectConversation(conversationId);
                }, 500);
                
            } catch (error) {
                console.error('Errore creazione conversazione:', error);
                alert('Errore nella creazione della conversazione');
            } finally {
                startBtn.disabled = false;
                startBtn.textContent = 'Inizia Chat';
            }
        }

        // Chiudi modal nuova conversazione
        function closeNewConversationModal() {
            const modal = document.getElementById('newConversationModal');
            modal.style.display = 'none';
            selectedUserForConversation = null;
        }

        // ========================
        // SISTEMA TAGGING UTENTI
        // ========================

        // Setup sistema di tagging per @ mentions
        function setupUserTagging(textarea) {
            if (!textarea) return;
            
            textarea.addEventListener('input', handleTaggingInput);
            textarea.addEventListener('keydown', handleTaggingKeydown);
        }

        // Gestisce input per tagging
        function handleTaggingInput(event) {
            const textarea = event.target;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            
            // Trova @ prima del cursore
            let atIndex = -1;
            for (let i = cursorPos - 1; i >= 0; i--) {
                if (text[i] === '@') {
                    atIndex = i;
                    break;
                } else if (text[i] === ' ' || text[i] === '\n') {
                    break;
                }
            }
            
            if (atIndex !== -1) {
                const query = text.substring(atIndex + 1, cursorPos);
                if (query.length >= 1) {
                    showUserSuggestions(textarea, query, atIndex);
                } else {
                    hideMentionSuggestions();
                }
            } else {
                hideMentionSuggestions();
            }
        }

        // Gestisce tasti per tagging
        function handleTaggingKeydown(event) {
            const suggestionBox = document.getElementById('mentionSuggestionBox');
            if (suggestionBox.style.display === 'none') return;
            
            const items = suggestionBox.querySelectorAll('.mention-suggestion-item');
            let selectedIndex = -1;
            
            items.forEach((item, index) => {
                if (item.classList.contains('selected')) {
                    selectedIndex = index;
                }
            });
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                const nextIndex = selectedIndex < items.length - 1 ? selectedIndex + 1 : 0;
                selectSuggestion(nextIndex);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                const prevIndex = selectedIndex > 0 ? selectedIndex - 1 : items.length - 1;
                selectSuggestion(prevIndex);
            } else if (event.key === 'Enter') {
                if (selectedIndex !== -1) {
                    event.preventDefault();
                    applySuggestion(selectedIndex);
                }
            } else if (event.key === 'Escape') {
                hideMentionSuggestions();
            }
        }

        // Mostra suggerimenti utenti
        function showUserSuggestions(textarea, query, atIndex) {
            const suggestionBox = document.getElementById('mentionSuggestionBox');
            
            // Filtra utenti per query
            const filteredUsers = availableUsers.filter(user => 
                user.id !== currentUser.uid &&
                user.username.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5);
            
            if (filteredUsers.length === 0) {
                hideMentionSuggestions();
                return;
            }
            
            // Calcola posizione
            const rect = textarea.getBoundingClientRect();
            const textareaStyle = window.getComputedStyle(textarea);
            const lineHeight = parseInt(textareaStyle.lineHeight) || 20;
            
            // Posiziona il box dei suggerimenti
            suggestionBox.style.display = 'block';
            suggestionBox.style.left = rect.left + 'px';
            suggestionBox.style.top = (rect.top - suggestionBox.offsetHeight - 5) + 'px';
            
            // Popola suggerimenti
            suggestionBox.innerHTML = filteredUsers.map((user, index) => {
                const avatarUrl = getUserAvatar(user.id);
                
                return `
                    <div class="mention-suggestion-item ${index === 0 ? 'selected' : ''}" 
                         onclick="applySuggestion(${index})" 
                         data-user-id="${user.id}"
                         data-username="${user.username}"
                         data-at-index="${atIndex}"
                         data-query="${query}">
                        <div class="mention-suggestion-avatar">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%;" />` : getInitials(user.username)}
                        </div>
                        <div class="mention-suggestion-info">
                            <div class="mention-suggestion-name">${user.username}</div>
                            <div class="mention-suggestion-clan">${user.clan || 'Nessun Clan'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            currentMentionInput = textarea;
        }

        // Seleziona suggerimento
        function selectSuggestion(index) {
            const items = document.querySelectorAll('.mention-suggestion-item');
            items.forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });
        }

        // Applica suggerimento
        function applySuggestion(index) {
            const items = document.querySelectorAll('.mention-suggestion-item');
            if (!items[index] || !currentMentionInput) return;
            
            const item = items[index];
            const username = item.dataset.username;
            const userId = item.dataset.userId;
            const atIndex = parseInt(item.dataset.atIndex);
            const query = item.dataset.query;
            
            const textarea = currentMentionInput;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            
            // Sostituisci @query con @username
            const newText = text.substring(0, atIndex) + `@${username} ` + text.substring(cursorPos);
            textarea.value = newText;
            
            // Posiziona cursore dopo il username
            const newCursorPos = atIndex + username.length + 2;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            hideMentionSuggestions();
            textarea.focus();
            
            // Salva mention per invio notifica successivo
            if (!textarea.mentions) textarea.mentions = [];
            textarea.mentions.push({ userId, username });
        }

        // Nascondi suggerimenti
        function hideMentionSuggestions() {
            const suggestionBox = document.getElementById('mentionSuggestionBox');
            suggestionBox.style.display = 'none';
            currentMentionInput = null;
        }

        // ========================
        // FUNZIONI DI SUPPORTO
        // ========================

        // Carica utenti disponibili
        async function loadAvailableUsers() {
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const usersRef = ref(window.firebaseDatabase, 'users');
                    const snapshot = await get(usersRef);
                    
                    if (snapshot.exists()) {
                        availableUsers = [];
                        snapshot.forEach((childSnapshot) => {
                            const userData = childSnapshot.val();
                            availableUsers.push({
                                id: childSnapshot.key,
                                username: userData.username,
                                clan: userData.clan
                            });
                        });
                    }
                } else {
                    // Modalità locale
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    availableUsers = Object.values(users).map(user => ({
                        id: user.uid,
                        username: user.username,
                        clan: user.clan
                    }));
                }
            } catch (error) {
                console.error('Errore caricamento utenti:', error);
            }
        }

        // Ottieni avatar utente
        function getUserAvatar(userId) {
            try {
                if (window.useFirebase) {
                    // In modalità Firebase, l'avatar sarebbe caricato dal database
                    return userProfiles[userId]?.avatarUrl || null;
                } else {
                    // Modalità locale
                    const profiles = JSON.parse(localStorage.getItem('hc_user_profiles') || '{}');
                    return profiles[userId]?.avatarUrl || null;
                }
            } catch (error) {
                return null;
            }
        }

        // Ottieni iniziali utente
        function getInitials(username) {
            if (!username) return '?';
            return username.charAt(0).toUpperCase();
        }

        // Ottieni dati utente completi
        async function getUserData(userId) {
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const userRef = ref(window.firebaseDatabase, `users/${userId}`);
                    const snapshot = await get(userRef);
                    return snapshot.exists() ? snapshot.val() : null;
                } else {
                    // Modalità locale
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    return Object.values(users).find(user => user.uid === userId) || null;
                }
            } catch (error) {
                console.error('Errore caricamento dati utente:', error);
                return null;
            }
        }

        // Ottieni badge clan
        function getClanBadgeClass(clanName) {
            if (!clanName || clanName === 'Nessuno') return 'clan-badge';
            
            const safeName = clanName.toLowerCase().replace(/\s+/g, '-');
            return `clan-badge clan-${safeName}`;
        }

        // Incrementa statistiche utente
        async function incrementUserStats(userId, statType) {
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const statsRef = ref(window.firebaseDatabase, `userStats/${userId}/${statType}`);
                    const snapshot = await get(statsRef);
                    const currentValue = snapshot.exists() ? snapshot.val() : 0;
                    await set(statsRef, currentValue + 1);
                } else {
                    // Modalità locale
                    const stats = JSON.parse(localStorage.getItem(`hc_user_stats_${userId}`) || '{}');
                    stats[statType] = (stats[statType] || 0) + 1;
                    localStorage.setItem(`hc_user_stats_${userId}`, JSON.stringify(stats));
                }
            } catch (error) {
                console.error('Errore aggiornamento statistiche:', error);
            }
        }

        // Gestione sezioni
        function switchSection(sectionKey) {
            const section = sectionConfig[sectionKey];
            if (!section) return;

            // Controlla accesso alla sezione
            if (!canAccessSection(sectionKey)) {
                if (sectionKey.startsWith('clan-')) {
                    if (sectionKey === 'clan-moderation' && !isClanModerator()) {
                        alert('Solo i moderatori del clan possono accedere a questa sezione!');
                    } else {
                        alert('Devi appartenere a un clan per accedere a questa sezione!');
                    }
                } else if (sectionKey.startsWith('admin-')) {
                    alert('Non hai i permessi per accedere a questa sezione!');
                }
                return;
            }

            // Pulisci listeners precedenti
            cleanupListeners();
			cleanupCommentImageUpload();

            currentSection = sectionKey;

            // Aggiorna header
            document.getElementById('section-title').textContent = section.title;
            document.getElementById('section-description').textContent = section.description;

            // Mostra contenuto appropriato
            const forumContent = document.getElementById('forum-content');
            const chatContent = document.getElementById('chat-content');
            const threadView = document.getElementById('thread-view');
            const newThreadBtn = document.getElementById('new-thread-btn');

            // Nascondi tutto inizialmente
            forumContent.style.display = 'none';
            chatContent.style.display = 'none';
            threadView.style.display = 'none';
            newThreadBtn.style.display = 'none';

            if (section.type === 'forum') {
                forumContent.style.display = 'block';
                newThreadBtn.style.display = 'block';
                loadThreads(sectionKey);
            } else if (section.type === 'chat') {
                chatContent.style.display = 'flex';
                loadMessages(sectionKey);
            } else if (section.type === 'admin') {
                forumContent.style.display = 'block';
                loadAdminContent(sectionKey);
            } else if (section.type === 'clan-admin') {
                forumContent.style.display = 'block';
                loadClanModerationContent();
            } else if (section.type === 'dashboard') {
                forumContent.style.display = 'block';
                loadDashboard();
            } else if (section.type === 'private-messages') {
                // Per i messaggi privati, apri il modal invece di cambiare sezione
                openPrivateMessages();
                return; // Non aggiornare la navigazione
            }

            // Chiudi menu mobile se aperto
            closeMobileMenu();

            // Aggiorna navigazione
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionKey}"]`).classList.add('active');
        }

        // Funzioni per la gestione mobile
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            if (sidebar.classList.contains('open')) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        function openMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.add('open');
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Carica dashboard
        function loadDashboard() {
            const threadList = document.getElementById('thread-list');
            
            // Se l'utente non è ancora loggato, mostra messaggio di caricamento
            if (!currentUser) {
                threadList.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #666;">
                        <div style="font-size: 64px; margin-bottom: 20px;">⏳</div>
                        <h2 style="color: #8B4513; margin-bottom: 10px;">Caricamento Dashboard...</h2>
                        <p>Preparazione della tua area personale</p>
                    </div>
                `;
                return;
            }
            
            const userName = currentUser.displayName || 'Guerriero';
            const userClan = getCurrentUserClan();
            const userRole = getCurrentUserRole();
            
            let welcomeMessage = '';
            const currentHour = new Date().getHours();
            if (currentHour < 12) {
                welcomeMessage = '🌅 Buongiorno';
            } else if (currentHour < 18) {
                welcomeMessage = '☀️ Buon pomeriggio';
            } else {
                welcomeMessage = '🌙 Buonasera';
            }

            let roleDisplay = '';
            switch (userRole) {
                case USER_ROLES.SUPERUSER:
                    roleDisplay = '<span class="user-role role-superuser">👑 SUPER ADMIN</span>';
                    break;
                case USER_ROLES.CLAN_MOD:
                    roleDisplay = '<span class="user-role role-moderator">🛡️ MODERATORE</span>';
                    break;
                default:
                    roleDisplay = '<span class="user-role role-user">⚔️ GUERRIERO</span>';
            }

            threadList.innerHTML = `
                <div style="display: grid; gap: 25px;">
                    <!-- Welcome Section -->
                    <div style="background: linear-gradient(135deg, rgba(218, 165, 32, 0.1) 0%, rgba(244, 164, 96, 0.1) 100%); border-radius: 15px; padding: 25px; border: 2px solid rgba(218, 165, 32, 0.3); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -20px; right: -20px; font-size: 80px; opacity: 0.1;">🏰</div>
                        <h2 style="color: #8B4513; margin-bottom: 15px; font-size: 28px;">
                            ${welcomeMessage}, ${userName}! ${roleDisplay}
                        </h2>
                        <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 15px;">
                            Benvenuto nel forum ufficiale di Hustle Castle Council! Qui puoi discutere strategie, 
                            condividere esperienze e rimanere aggiornato sugli ultimi eventi del gioco.
                        </p>
                        ${userClan !== 'Nessuno' ? `
                            <div style="background: rgba(52, 152, 219, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #3498db;">
                                <strong style="color: #3498db;">🏰 Clan: ${userClan}</strong>
                                <p style="color: #666; font-size: 14px; margin-top: 5px;">Accedi alle sezioni dedicate del tuo clan dal menu laterale</p>
                            </div>
                        ` : `
                            <div style="background: rgba(255, 193, 7, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <strong style="color: #e68900;">⚠️ Non hai un clan</strong>
                                <p style="color: #666; font-size: 14px; margin-top: 5px;">Unisciti a un clan per accedere a funzionalità esclusive!</p>
                            </div>
                        `}
                    </div>

                    <!-- Quick Navigation -->
                    <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                        <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>🧭</span> Navigazione Rapida
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="dashboard-card" onclick="switchSection('eventi')" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">📅</div>
                                <h4 style="margin-bottom: 8px;">Eventi</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Scopri eventi in corso</p>
                            </div>
                            <div class="dashboard-card" onclick="switchSection('oggetti')" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">⚔️</div>
                                <h4 style="margin-bottom: 8px;">Oggetti</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Guide su armi e armature</p>
                            </div>
                            <div class="dashboard-card" onclick="switchSection('novita')" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">🆕</div>
                                <h4 style="margin-bottom: 8px;">Novità</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Ultimi aggiornamenti</p>
                            </div>
							<div class="dashboard-card" onclick="switchSection('associa-clan')" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">🏠</div>
                                <h4 style="margin-bottom: 8px;">Associa Clan</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Richiedi di associarti ad un clan</p>
                            </div>
                            <div class="dashboard-card" onclick="switchSection('chat-generale')" style="background: linear-gradient(135deg, #27ae60, #229954); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">💬</div>
                                <h4 style="margin-bottom: 8px;">Chat Generale</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Chiacchiera con la community</p>
                            </div>
                            <div class="dashboard-card" onclick="openPrivateMessages()" style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">📨</div>
                                <h4 style="margin-bottom: 8px;">Messaggi Privati</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Conversazioni personali</p>
                            </div>
                        </div>
                    </div>

                    <!-- Stats and Tips Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Forum Stats -->
                        <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                            <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <span>📊</span> Statistiche Forum
                            </h3>
                            <div style="display: grid; gap: 15px;">
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(218, 165, 32, 0.1); border-radius: 8px;">
                                    <span style="color: #666;">📝 Thread Totali</span>
                                    <strong style="color: #8B4513;">${getForumStats().totalThreads}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(218, 165, 32, 0.1); border-radius: 8px;">
                                    <span style="color: #666;">💬 Messaggi Chat</span>
                                    <strong style="color: #8B4513;">${getForumStats().totalMessages}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(218, 165, 32, 0.1); border-radius: 8px;">
                                    <span style="color: #666;">👥 Utenti Registrati</span>
                                    <strong style="color: #8B4513;">${getForumStats().totalUsers}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(218, 165, 32, 0.1); border-radius: 8px;">
                                    <span style="color: #666;">🏰 Clan Attivi</span>
                                    <strong style="color: #8B4513;">${getForumStats().totalClans}</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Tips -->
                        <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                            <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <span>💡</span> Suggerimenti Rapidi
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="padding: 12px; background: rgba(46, 204, 113, 0.1); border-radius: 8px; border-left: 4px solid #2ecc71;">
                                    <strong style="color: #27ae60; font-size: 14px;">🎯 Partecipa alle Discussioni</strong>
                                    <p style="color: #666; font-size: 12px; margin-top: 4px;">Condividi le tue strategie nella sezione Eventi</p>
                                </div>
                                <div style="padding: 12px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; border-left: 4px solid #3498db;">
                                    <strong style="color: #2980b9; font-size: 14px;">🏰 Unisciti a un Clan</strong>
                                    <p style="color: #666; font-size: 12px; margin-top: 4px;">Accedi a chat e funzionalità esclusive</p>
                                </div>
                                <div style="padding: 12px; background: rgba(155, 89, 182, 0.1); border-radius: 8px; border-left: 4px solid #9b59b6;">
                                    <strong style="color: #8e44ad; font-size: 14px;">⚔️ Condividi Equipaggiamenti</strong>
                                    <p style="color: #666; font-size: 12px; margin-top: 4px;">Mostra le tue armi leggendarie!</p>
                                </div>
                                <div style="padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 8px; border-left: 4px solid #e67e22;">
                                    <strong style="color: #d68910; font-size: 14px;">📢 Rimani Aggiornato</strong>
                                    <p style="color: #666; font-size: 12px; margin-top: 4px;">Controlla regolarmente le Novità</p>
                                </div>
								<div style="padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 8px; border-left: 4px solid #e67e22;">
                                    <strong style="color: #d68910; font-size: 14px;">📢 Unisciti ad un clan</strong>
                                    <p style="color: #666; font-size: 12px; margin-top: 4px;">Cerca il tuo clan e unisciti al gruppo</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions & Tips -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Quick Actions -->
                        <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                            <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <span>⚡</span> Azioni Rapide
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <button onclick="switchSection('eventi')" class="quick-action-btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">📅</span>
                                    <span>Controlla Eventi Attuali</span>
                                </button>
                                <button onclick="switchSection('chat-generale')" class="quick-action-btn" style="background: linear-gradient(135deg, #27ae60, #229954); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">💬</span>
                                    <span>Inizia una Conversazione</span>
                                </button>
                                <button onclick="openPrivateMessages()" class="quick-action-btn" style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">📨</span>
                                    <span>Messaggi Privati</span>
                                </button>
                                <button onclick="showThreadCreationModal()" class="quick-action-btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">✍️</span>
                                    <span>Crea Nuovo Thread</span>
                                </button>
                                ${userClan !== 'Nessuno' ? `
                                    <button onclick="switchSection('clan-chat')" class="quick-action-btn" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 20px;">🏰</span>
                                        <span>Chat del Clan</span>
                                    </button>
                                ` : `
                                    <button onclick="alert('Unisciti a un clan per accedere a questa funzionalità!')" class="quick-action-btn" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px; opacity: 0.6;">
                                        <span style="font-size: 20px;">🔒</span>
                                        <span>Chat del Clan (Locked)</span>
                                    </button>
                                `}
                            </div>
                        </div>

                        <!-- Daily Tips -->
                        <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                            <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <span>🎯</span> Consiglio del Giorno
                            </h3>
                            <div id="daily-tip" style="padding: 20px; background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1)); border-radius: 10px; border-left: 4px solid #3498db;">
                                <!-- Il consiglio verrà inserito qui -->
                            </div>
                            <div style="margin-top: 15px; text-align: center;">
                                <button onclick="loadDailyTip()" style="background: rgba(52, 152, 219, 0.1); border: 1px solid #3498db; color: #3498db; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s ease;">
                                    🔄 Nuovo Consiglio
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Community Highlights -->
                    <div style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(39, 174, 96, 0.1)); border-radius: 15px; padding: 25px; border: 2px solid #27ae60;">
                        <h3 style="color: #27ae60; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>🌟</span> In Evidenza nella Community
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid rgba(39, 174, 96, 0.3);">
                                <div style="font-size: 48px; margin-bottom: 10px;">🔥</div>
                                <h4 style="color: #27ae60; margin-bottom: 8px;">Thread Più Visto</h4>
                                <p style="font-size: 12px; color: #666;">Guide alle Gemme Leggendarie</p>
                                <p style="font-size: 11px; color: #999;">445 visualizzazioni</p>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid rgba(39, 174, 96, 0.3);">
                                <div style="font-size: 48px; margin-bottom: 10px;">👑</div>
                                <h4 style="color: #27ae60; margin-bottom: 8px;">Utente del Mese</h4>
                                <p style="font-size: 12px; color: #666;">ProPlayer123</p>
                                <p style="font-size: 11px; color: #999;">67 contributi</p>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid rgba(39, 174, 96, 0.3);">
                                <div style="font-size: 48px; margin-bottom: 10px;">🏆</div>
                                <h4 style="color: #27ae60; margin-bottom: 8px;">Clan Più Attivo</h4>
                                <p style="font-size: 12px; color: #666;">Draghi Rossi</p>
                                <p style="font-size: 11px; color: #999;">25 membri attivi</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Aggiungi stili hover per le dashboard cards
            const style = document.createElement('style');
            style.textContent = `
                .dashboard-card:hover {
                    transform: translateY(-5px) scale(1.02);
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                }
            `;
            document.head.appendChild(style);

            // Carica consigli del giorno dopo un breve delay
            setTimeout(loadDailyTip, 300);
        }

        // Ottieni statistiche del forum
        function getForumStats() {
            let totalThreads = 0;
            let totalMessages = 0;
            let totalUsers = 0;
            let totalClans = 0;

            try {
                if (window.useFirebase) {
                    // In modalità Firebase, restituisci valori placeholder
                    return {
                        totalThreads: '50+',
                        totalMessages: '200+', 
                        totalUsers: '15+',
                        totalClans: '5+'
                    };
                } else {
                    // Modalità locale - conta i dati reali
                    const sections = ['eventi', 'oggetti', 'novita', 'associa-clan'];
                    sections.forEach(section => {
                        const threads = JSON.parse(localStorage.getItem(`hc_threads_${section}`) || '[]');
                        totalThreads += threads.length;
                    });

                    const messages = JSON.parse(localStorage.getItem(`hc_messages_chat-generale`) || '[]');
                    totalMessages += messages.length;

                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    totalUsers = Object.keys(users).length;

                    const clanSet = new Set();
                    Object.values(users).forEach(user => {
                        if (user.clan && user.clan !== 'Nessuno') {
                            clanSet.add(user.clan);
                        }
                    });
                    totalClans = clanSet.size;
                }
            } catch (error) {
                console.error('Errore calcolo statistiche:', error);
            }

            return {
                totalThreads: totalThreads || 0,
                totalMessages: totalMessages || 0,
                totalUsers: totalUsers || 0,
                totalClans: totalClans || 0
            };
        }

        // Carica consiglio del giorno
        function loadDailyTip() {
            const tipContainer = document.getElementById('daily-tip');
            if (!tipContainer) return;

            const tips = [
                {
                    icon: '⚔️',
                    title: 'Strategia di Combattimento',
                    content: 'Bilancia sempre la tua formazione: un tank robusto, DPS equilibrati e un supporto possono fare la differenza in arena!'
                },
                {
                    icon: '🏰',
                    title: 'Gestione del Castello',
                    content: 'Aggiorna sempre la sala del trono prima di potenziare altre stanze per massimizzare l\'efficienza delle risorse.'
                },
                {
                    icon: '💎',
                    title: 'Gemme e Equipaggiamento',
                    content: 'Non vendere mai le gemme leggendarie! Anche se sembrano deboli ora, potrebbero essere utili per upgrade futuri.'
                },
                {
                    icon: '🎯',
                    title: 'Eventi Speciali',
                    content: 'Partecipa sempre agli eventi temporanei: spesso offrono ricompense uniche che non puoi ottenere altrove!'
                },
                {
                    icon: '👥',
                    title: 'Vita di Clan',
                    content: 'Coordina sempre con il tuo clan prima delle guerre. La comunicazione è la chiave per la vittoria!'
                },
                {
                    icon: '📈',
                    title: 'Progressione Intelligente',
                    content: 'Non avere fretta di salire di Throne Room. Assicurati di avere equipaggiamento e truppe adeguate al tuo livello.'
                },
                {
                    icon: '🛡️',
                    title: 'Difesa del Castello',
                    content: 'Posiziona strategicamente le tue difese: mescola danni fisici e magici per contrastare diversi tipi di attacco.'
                },
                {
                    icon: '⏰',
                    title: 'Gestione del Tempo',
                    content: 'Ottimizza i tempi di training: inizia sempre con le truppe che richiedono più tempo prima di andare offline.'
                },
                {
                    icon: '🏆',
                    title: 'Arena e PvP',
                    content: 'Studia sempre gli avversari prima di attaccare. Una strategia ben pianificata vale più della forza bruta!'
                },
                {
                    icon: '💰',
                    title: 'Economia del Gioco',
                    content: 'Investi le gemme saggiamente: priorità a slot di barracks, mastro e velocizzazione di upgrade critici.'
                }
            ];

            // Seleziona un consiglio basato sul giorno corrente per consistenza
            const today = new Date().getDate();
            const selectedTip = tips[today % tips.length];

            tipContainer.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 32px; flex-shrink: 0;">${selectedTip.icon}</div>
                    <div>
                        <h4 style="color: #3498db; margin: 0 0 8px 0; font-size: 16px;">${selectedTip.title}</h4>
                        <p style="color: #666; margin: 0; line-height: 1.5; font-size: 14px;">${selectedTip.content}</p>
                    </div>
                </div>
            `;
        }

        // Rendi la funzione globale
        window.loadDailyTip = loadDailyTip;

        // Processa mentions nel testo
        function processMentions(text) {
            // Sostituisce @username con link cliccabili
            return text.replace(/@(\w+)/g, (match, username) => {
                return `<span class="user-mention" onclick="showUserInfo('${username}')">${match}</span>`;
            });
        }

        // Mostra info utente quando si clicca su mention
        function showUserInfo(username) {
            // Trova l'utente e mostra un tooltip o modal con info
            const user = availableUsers.find(u => u.username === username);
            if (user) {
                alert(`👤 ${user.username}\n🏰 Clan: ${user.clan || 'Nessuno'}\n\n💬 Clicca OK per inviare un messaggio privato`);
                // TODO: Implementare modal utente o apertura chat privata
            }
        }

        // Continua nel prossimo aggiornamento con le funzioni mancanti...
        
        // 🤖 GESTIONE INTERFACCIA LOGIN/REGISTRAZIONE CON reCAPTCHA
        function switchToLogin() {
            isLoginMode = true;
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('registrationFields').classList.remove('show');
            document.getElementById('submitBtn').textContent = 'Accedi';
            document.getElementById('googleBtnText').textContent = 'Continua con Google';
            
            // Pulisci campi opzionali
            document.getElementById('username').value = '';
            
            // Reset reCAPTCHA
            if (window.useFirebase && window.appCheckEnabled && typeof window.resetRecaptcha === 'function') {
                window.resetRecaptcha();
            }
            
            hideError();
        }

        function switchToRegister() {
            isLoginMode = false;
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registrationFields').classList.add('show');
            document.getElementById('submitBtn').textContent = 'Registrati';
            document.getElementById('googleBtnText').textContent = 'Registrati con Google';
            
            // Reset reCAPTCHA
            if (window.useFirebase && window.appCheckEnabled && typeof window.resetRecaptcha === 'function') {
                window.resetRecaptcha();
            }
            
            hideError();
        }

        // Gestione form submit
        function handleSubmit() {
            if (isLoginMode) {
                handleLogin();
            } else {
                handleRegister();
            }
        }

        // Login con Google
        async function handleGoogleLogin() {
            if (!window.useFirebase || !firebaseReady || !signInWithPopup || !window.googleProvider) {
                alert('Login con Google non disponibile in modalità demo');
                return;
            }

            const googleBtn = document.getElementById('googleLoginBtn');
            googleBtn.disabled = true;
            googleBtn.innerHTML = `
                <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                Connessione...
            `;

            try {
                const result = await signInWithPopup(window.firebaseAuth, window.googleProvider);
                const user = result.user;
                
                // Verifica se l'utente esiste già nel database
                const userRef = ref(window.firebaseDatabase, `users/${user.uid}`);
                const snapshot = await get(userRef);
                
                if (!snapshot.exists()) {
                    // Nuovo utente Google - chiedi dati aggiuntivi
                    const username = user.displayName || prompt('Inserisci il tuo username:');
                    const clan = prompt('Inserisci il tuo clan (opzionale):') || 'Nessuno';
                    
                    if (!username) {
                        throw new Error('Username richiesto');
                    }
                    
                    // Determina ruolo per nuovo utente
                    const userRole = await determineUserRole();
                    
                    // Salva i dati utente
                    await set(userRef, {
                        username: username,
                        email: user.email,
                        clan: clan,
                        role: userRole,
                        createdAt: serverTimestamp(),
                        lastSeen: serverTimestamp(),
                        provider: 'google'
                    });
                    
                    const roleMessage = userRole === USER_ROLES.SUPERUSER ? 
                        ' Ti sono stati assegnati i privilegi di SUPERUSER!' : '';
                    showSuccess(`Account Google creato con successo!${roleMessage}`);
                } else {
                    showSuccess('Login con Google effettuato con successo!');
                }
                
            } catch (error) {
                console.error('Errore login Google:', error);
                
                // Gestione errori specifici di Google Auth
                let errorMessage = 'Errore nel login con Google';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Login annullato dall\'utente';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Popup bloccato dal browser. Abilita i popup per questo sito.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Errore di connessione. Controlla la tua connessione internet.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
            } finally {
                googleBtn.disabled = false;
                googleBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>${isLoginMode ? 'Continua con Google' : 'Registrati con Google'}</span>
                `;
            }
        }

        // 🤖 GESTIONE AUTENTICAZIONE CON reCAPTCHA MIGLIORATA
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showError('Inserisci email e password');
                return;
            }

            // Verifica reCAPTCHA solo se App Check è attivo
            if (window.useFirebase && window.appCheckEnabled && typeof grecaptcha !== 'undefined') {
                if (!window.verifyRecaptcha()) {
                    showError('🤖 Completa la verifica reCAPTCHA');
                    return;
                }
            }

            showLoading(true);
            hideError();

            try {
                if (window.useFirebase && firebaseReady && signInWithEmailAndPassword) {
                    // Autenticazione Firebase
                    await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    showSuccess('Login effettuato con successo!');
                } else {
                    // Autenticazione locale (demo)
                    await simulateLogin(email, password);
                }
                
                // Reset reCAPTCHA dopo successo (solo se attivo)
                if (window.useFirebase && window.appCheckEnabled) {
                    window.resetRecaptcha();
                }
            } catch (error) {
                console.error('Errore login:', error);
                showError(getErrorMessage(error));
                
                // Reset reCAPTCHA in caso di errore (solo se attivo)
                if (window.useFirebase && window.appCheckEnabled) {
                    window.resetRecaptcha();
                }
            } finally {
                showLoading(false);
            }
        }

        async function handleRegister() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;

            if (!email || !password || !username) {
                showError('Inserisci email, password e username');
                return;
            }

            // Verifica reCAPTCHA solo se App Check è attivo
            if (window.useFirebase && window.appCheckEnabled && typeof grecaptcha !== 'undefined') {
                if (!window.verifyRecaptcha()) {
                    showError('🤖 Completa la verifica reCAPTCHA');
                    return;
                }
            }

            showLoading(true);
            hideError();

            try {
                // Determina il ruolo del nuovo utente
                const userRole = await determineUserRole();
                
                if (window.useFirebase && firebaseReady && createUserWithEmailAndPassword) {
                    // Registrazione Firebase
                    const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                    const user = userCredential.user;

                    await updateProfile(user, { displayName: username });

                    await set(ref(window.firebaseDatabase, `users/${user.uid}`), {
                        username: username,
                        email: email,
                        clan:  'Nessuno',
                        role: userRole,
                        createdAt: serverTimestamp(),
                        lastSeen: serverTimestamp(),
                        provider: 'email'
                    });
                } else {
                    // Registrazione locale (demo)
                    await simulateRegister(email, password, username, 'Nessuno', userRole);
                }
                
                const roleMessage = userRole === USER_ROLES.SUPERUSER ? 
                    '\n🎉 Sei il primo utente! Ti sono stati assegnati i privilegi di SUPERUSER.' : '';
                
                showSuccess(`Account creato con successo!${roleMessage}`);
                
                // Reset reCAPTCHA dopo successo (solo se attivo)
                if (window.useFirebase && window.appCheckEnabled) {
                    window.resetRecaptcha();
                }
            } catch (error) {
                console.error('Errore registrazione:', error);
                showError(getErrorMessage(error));
                
                // Reset reCAPTCHA in caso di errore (solo se attivo)
                if (window.useFirebase && window.appCheckEnabled) {
                    window.resetRecaptcha();
                }
            } finally {
                showLoading(false);
            }
        }

        // Determina il ruolo del nuovo utente
        async function determineUserRole() {
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    // In Firebase, per sicurezza, assumiamo sempre USER come ruolo di default
                    return USER_ROLES.USER;
                } else {
                    // Modalità locale - controlla se ci sono utenti reali (non di esempio)
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    
                    // Filtra solo utenti reali (non quelli di esempio)
                    const realUsers = Object.values(users).filter(user => 
                        !user.uid.startsWith('super_admin_') && 
                        !user.uid.startsWith('clan_mod_') && 
                        !user.uid.startsWith('user_')
                    );
                    
                    if (realUsers.length === 0) {
                        return USER_ROLES.SUPERUSER;
                    }
                }
                
                return USER_ROLES.USER;
            } catch (error) {
                console.error('Errore determinazione ruolo:', error);
                return USER_ROLES.USER;
            }
        }

        // Simulazione autenticazione locale
        async function simulateLogin(email, password) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    const user = users[email];
                    
                    if (user && user.password === password) {
                        currentUser = {
                            uid: user.uid,
                            email: email,
                            displayName: user.username
                        };
                        
                        // Salva i dati utente correnti
                        currentUserData = user;
                        
                        // Aggiorna UI con i dati del clan
                        document.getElementById('currentUsername').textContent = user.username;
                        document.getElementById('currentClan').textContent = user.clan || 'Nessuno';
                        document.getElementById('sidebarClan').textContent = user.clan || 'Nessuno';
                        
                        handleUserLogin(currentUser);
                        resolve();
                    } else {
                        reject(new Error('Email o password non validi'));
                    }
                }, 1000);
            });
        }

        async function simulateRegister(email, password, username, clan, role) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    
                    if (users[email]) {
                        reject(new Error('Utente già esistente'));
                        return;
                    }
                    
                    const userId = 'local_' + Date.now();
                    users[email] = {
                        uid: userId,
                        username: username,
                        email: email,
                        password: password,
                        clan: clan || 'Nessuno',
                        role: role || USER_ROLES.USER,
                        createdAt: Date.now()
                    };
                    
                    localStorage.setItem('hc_local_users', JSON.stringify(users));
                    
                    currentUser = {
                        uid: userId,
                        email: email,
                        displayName: username
                    };
                    
                    // Salva i dati utente correnti
                    currentUserData = users[email];
                    
                    // Aggiorna UI con i dati del clan
                    document.getElementById('currentUsername').textContent = username;
                    document.getElementById('currentClan').textContent = clan || 'Nessuno';
                    document.getElementById('sidebarClan').textContent = clan || 'Nessuno';
                    
                    handleUserLogin(currentUser);
                    resolve();
                }, 1000);
            });
        }

        async function handleLogout() {
            try {
                if (window.useFirebase && window.firebaseAuth && firebaseReady && signOut) {
                    await signOut(window.firebaseAuth);
                } else {
                    // Logout locale
                    currentUser = null;
                    handleUserLogout();
                }
            } catch (error) {
                console.error('Errore logout:', error);
            }
        }

        // Inizializza dati di esempio per modalità locale
        function initializeLocalData() {
            // Crea utenti di esempio se non esistono
            const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
            
            // Controlla se ci sono utenti reali
            const realUsers = Object.values(users).filter(user => 
                !user.uid.startsWith('super_admin_') && 
                !user.uid.startsWith('clan_mod_') && 
                !user.uid.startsWith('user_')
            );
            
            // Se c'è già un utente reale ma non ha ruolo superuser, assegnaglielo
            if (realUsers.length > 0) {
                const firstRealUser = realUsers[0];
                if (!firstRealUser.role || firstRealUser.role === USER_ROLES.USER) {
                    firstRealUser.role = USER_ROLES.SUPERUSER;
                    // Trova l'email corrispondente e aggiorna
                    for (const email in users) {
                        if (users[email].uid === firstRealUser.uid) {
                            users[email].role = USER_ROLES.SUPERUSER;
                            localStorage.setItem('hc_local_users', JSON.stringify(users));
                            console.log('🎉 Primo utente reale promosso a SUPERUSER:', email);
                            break;
                        }
                    }
                }
            }
            
            // Crea utenti di esempio solo se non ci sono utenti reali
            if (realUsers.length === 0) {
                // Superuser di default
                const defaultSuperUser = {
                    uid: 'super_admin_001',
                    username: 'SuperAdmin',
                    email: 'admin@hustlecastle.com',
                    password: 'admin123',
                    clan: 'Nessuno',
                    role: USER_ROLES.SUPERUSER,
                    createdAt: Date.now()
                };
                
                // Moderatore clan di esempio
                const clanMod = {
                    uid: 'clan_mod_001',
                    username: 'ModeratoreDraghi',
                    email: 'mod@draghi.com',
                    password: 'mod123',
                    clan: 'Draghi Rossi',
                    role: USER_ROLES.CLAN_MOD,
                    createdAt: Date.now()
                };
                
                // Utente normale di esempio
                const normalUser = {
                    uid: 'user_001',
                    username: 'GiocatoreLeoni',
                    email: 'player@leoni.com',
                    password: 'player123',
                    clan: 'Leoni Neri',
                    role: USER_ROLES.USER,
                    createdAt: Date.now()
                };
                
                users['admin@hustlecastle.com'] = defaultSuperUser;
                users['mod@draghi.com'] = clanMod;
                users['player@leoni.com'] = normalUser;
                
                localStorage.setItem('hc_local_users', JSON.stringify(users));
                
                console.log('🔧 Utenti di esempio creati:', {
                    superuser: { email: 'admin@hustlecastle.com', password: 'admin123' },
                    clanMod: { email: 'mod@draghi.com', password: 'mod123' },
                    user: { email: 'player@leoni.com', password: 'player123' }
                });
            }
            
            // Aggiungi thread di esempio per sezioni generali se non esistono
            const sections = ['eventi', 'oggetti', 'novita', 'associa-clan'];
            sections.forEach(section => {
                const threads = JSON.parse(localStorage.getItem(`hc_threads_${section}`) || '[]');
                if (threads.length === 0) {
                    const exampleThreads = getExampleThreads(section);
                    localStorage.setItem(`hc_threads_${section}`, JSON.stringify(exampleThreads));
                }
            });

            // Aggiungi messaggi di esempio per chat generale se non esistono
            const messages = JSON.parse(localStorage.getItem(`hc_messages_chat-generale`) || '[]');
            if (messages.length === 0) {
                const exampleMessages = getExampleMessages('chat-generale');
                localStorage.setItem(`hc_messages_chat-generale`, JSON.stringify(exampleMessages));
            }

            // Inizializza dati di esempio per clan specifici
            const exampleClans = ['Draghi Rossi', 'Leoni Neri', 'Aquile Bianche'];
            exampleClans.forEach(clan => {
                const safeClanName = clan.replace(/[.#$[\]]/g, '_');
                
                // Thread clan (alcuni pending per testare moderazione)
                const clanSections = ['clan-war', 'clan-premi', 'clan-consigli', 'clan-bacheca'];
                clanSections.forEach(section => {
                    const storageKey = `hc_threads_clan_${safeClanName}_${section}`;
                    const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    if (threads.length === 0) {
                        const exampleThreads = getExampleClanThreads(section, clan);
                        localStorage.setItem(storageKey, JSON.stringify(exampleThreads));
                    }
                });

                // Messaggi clan chat
                const chatStorageKey = `hc_messages_clan_${safeClanName}_clan-chat`;
                const chatMessages = JSON.parse(localStorage.getItem(chatStorageKey) || '[]');
                if (chatMessages.length === 0) {
                    const exampleMessages = getExampleClanMessages(clan);
                    localStorage.setItem(chatStorageKey, JSON.stringify(exampleMessages));
                }
            });
        }

        function getExampleThreads(section) {
            const examples = {
                'eventi': [
                    {
                        id: 'evt_demo_1',
                        title: '🎃 Evento Halloween - Strategie e Premi',
                        content: 'Discussione sulle migliori strategie per l\'evento Halloween! Condividete i vostri setup e le ricompense ottenute.',
                        author: 'EventMaster',
                        createdAt: Date.now() - 2*24*60*60*1000,
                        replies: 15,
                        views: 87,
                        status: 'approved',
                        imageUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmY2NjAwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPvCfjoMgRXZlbnRvIEhhbGxvd2VlbiDwn46DPC90ZXh0Pjwvc3ZnPg==',
                        imageName: 'halloween_event.jpg'
                    }
                ],
                'novita': [
                    {
                        id: 'news_demo_1',
                        title: '📢 Aggiornamento 1.58.0 - Nuove Features!',
                        content: 'Ecco tutte le novità dell\'ultimo aggiornamento: nuovi eroi, dungeon migliorati e molto altro!',
                        author: 'GameUpdater',
                        createdAt: Date.now() - 1*24*60*60*1000,
                        replies: 23,
                        views: 145,
                        status: 'approved',
                        imageUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMDA4OGNjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPvCfkKIgQWdnaW9ybmFtZW50byB2MS41OC4wIPCfkKI8L3RleHQ+PC9zdmc+',
                        imageName: 'update_158.jpg'
                    }
                ]
            };
            return examples[section] || [];
        }

        function getExampleClanThreads(section, clanName) {
            const examples = {
                'clan-war': [],
                'clan-premi': [],
                'clan-consigli': [],
				'clan-bacheca': []
            };
            return examples[section] || [];
        }

        function getExampleMessages(section) {
            const examples = {
                'chat-generale': []
            };
            return examples[section] || [];
        }

        function getExampleClanMessages(clanName) {
            return [
                {
                    id: 'cmsg1',
                    author: `Leader${clanName.replace(' ', '')}`,
                    message: `Benvenuti nel clan ${clanName}! Preparatevi per la guerra di domani!`,
                    timestamp: Date.now() - 15*60*1000
                },
                {
                    id: 'cmsg2',
                    author: 'WarriorClan',
                    message: 'Le mie truppe sono pronte! ⚔️',
                    timestamp: Date.now() - 10*60*1000
                },
                {
                    id: 'cmsg3',
                    author: 'DefenderMaster',
                    message: 'Chi ha bisogno di aiuto per il setup delle difese?',
                    timestamp: Date.now() - 5*60*1000
                }
            ];
        }

        // 🤖 GESTIONE MESSAGGI ERRORE CON reCAPTCHA
        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'Email non valida';
                case 'auth/user-disabled':
                    return 'Account disabilitato';
                case 'auth/user-not-found':
                    return 'Utente non trovato';
                case 'auth/wrong-password':
                    return 'Password errata';
                case 'auth/email-already-in-use':
                    return 'Email già in uso';
                case 'auth/weak-password':
                    return 'Password troppo debole';
                case 'auth/popup-closed-by-user':
                    return 'Login annullato dall\'utente';
                case 'auth/popup-blocked':
                    return 'Popup bloccato dal browser. Abilita i popup per questo sito.';
                case 'auth/cancelled-popup-request':
                    return 'Popup di login cancellato';
                case 'auth/network-request-failed':
                    return 'Errore di connessione. Controlla la tua connessione internet.';
                case 'auth/recaptcha-not-enabled':
                    return 'reCAPTCHA non abilitato. Contatta l\'amministratore.';
                case 'auth/too-many-requests':
                    return 'Troppi tentativi. Riprova più tardi o completa la verifica reCAPTCHA.';
                default:
                    if (error.message && error.message.includes('recaptcha')) {
                        return 'Errore nella verifica reCAPTCHA. Riprova.';
                    }
                    return error.message || 'Errore sconosciuto';
            }
        }

        // Utility UI
        function showError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('loginSuccess');
            successEl.textContent = message;
            successEl.classList.add('show');
            setTimeout(() => successEl.classList.remove('show'), 3000);
        }

        function hideError() {
            document.getElementById('loginError').classList.remove('show');
        }

        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            loadingEl.classList.toggle('show', show);
        }

        function cleanupListeners() {
            if (!window.useFirebase || !window.firebaseDatabase || !firebaseReady || !ref || !off) return;
            
            try {
                // Pulisci listeners messaggi
                Object.keys(messageListeners).forEach(section => {
                    const listener = messageListeners[section];
                    if (listener && listener.path && listener.callback) {
                        const messagesRef = ref(window.firebaseDatabase, listener.path);
                        off(messagesRef, listener.callback);
                    }
                });
                messageListeners = {};
                
                // Pulisci listeners thread
                Object.keys(threadListeners).forEach(section => {
                    const listener = threadListeners[section];
                    if (listener && listener.path && listener.callback) {
                        const threadsRef = ref(window.firebaseDatabase, listener.path);
                        off(threadsRef, listener.callback);
                    }
                });
                threadListeners = {};

				// Pulisci upload commenti
				cleanupCommentImageUpload();
				
				// Pulisci mention suggestions
				hideMentionSuggestions();
			} catch (error) {
				console.error('Errore pulizia listeners:', error);
			}
        }

        // Event listeners aggiornati
        function setupEventListeners() {
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    if (section) switchSection(section);
                });
            });

            // Chat input con tagging
            const messageInput = document.getElementById('message-input');
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            setupUserTagging(messageInput);

            // Comment input con tagging
            const commentTextarea = document.getElementById('comment-text');
            commentTextarea.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    addComment();
                }
            });
            setupUserTagging(commentTextarea);

            // Avatar upload
            document.getElementById('avatarUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Preview immediato
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        updateProfileAvatar(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Notifiche - click fuori per chiudere
            document.addEventListener('click', (e) => {
                const notificationsPanel = document.getElementById('notificationsPanel');
                const notificationsBell = document.getElementById('notificationsBell');
                
                if (!notificationsBell.contains(e.target) && !notificationsPanel.contains(e.target)) {
                    notificationsPanel.style.display = 'none';
                }
                
                // Nascondi mention suggestions se clicchi fuori
                if (!e.target.closest('.mention-suggestion-box') && !e.target.closest('textarea') && !e.target.closest('input')) {
                    hideMentionSuggestions();
                }
            });

            // Form inputs - Enter per submit
            ['email', 'password', 'username'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleSubmit();
                        }
                    });
                }
            });

            // Thread creation form - Enter per submit
            document.getElementById('thread-title-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('thread-content-input').focus();
                }
            });

            document.getElementById('thread-content-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    createThread();
                }
            });

            // Escape per chiudere modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (document.getElementById('threadCreationModal').style.display === 'flex') {
                        hideThreadCreationModal();
                    } else if (document.getElementById('imageModal').style.display === 'flex') {
                        closeImageModal();
                    } else if (document.getElementById('userProfileModal').style.display === 'flex') {
                        closeUserProfile();
                    } else if (document.getElementById('privateMessagesModal').style.display === 'flex') {
                        closePrivateMessages();
                    } else if (document.getElementById('newConversationModal').style.display === 'flex') {
                        closeNewConversationModal();
                    } else if (document.getElementById('notificationsPanel').style.display === 'block') {
                        document.getElementById('notificationsPanel').style.display = 'none';
                    }
                }
            });

            // Chiudi modal cliccando fuori
            document.getElementById('threadCreationModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('threadCreationModal')) {
                    hideThreadCreationModal();
                }
            });

            document.getElementById('userProfileModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('userProfileModal')) {
                    closeUserProfile();
                }
            });

            document.getElementById('privateMessagesModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('privateMessagesModal')) {
                    closePrivateMessages();
                }
            });

            document.getElementById('newConversationModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('newConversationModal')) {
                    closeNewConversationModal();
                }
            });

            // Previeni chiusura modal immagine cliccando sull'immagine
            document.getElementById('modalImage').addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // Carica contenuto amministrativo
        function loadAdminContent(sectionKey) {
            const threadList = document.getElementById('thread-list');
            
            switch (sectionKey) {
                case 'admin-users':
                    loadUsersManagement();
                    break;
                case 'admin-clans':
                    loadClansManagement();
                    break;
                default:
                    threadList.innerHTML = '<div style="text-align: center; padding: 40px;">Sezione non trovata</div>';
            }
        }

        // Carica contenuto moderazione clan
        function loadClanModerationContent() {
            const threadList = document.getElementById('thread-list');
            
            threadList.innerHTML = `
                <div class="admin-panel">
                    <h3>🛡️ Moderazione Clan ${getCurrentUserClan()}</h3>
                    <div id="moderation-content">
                        <div style="text-align: center; padding: 20px;">
                            <div>🔄 Caricamento contenuti da moderare...</div>
                        </div>
                    </div>
                </div>
            `;

            loadPendingThreads();
        }

        // Carica thread in attesa di approvazione
        async function loadPendingThreads() {
            const moderationContent = document.getElementById('moderation-content');
            
            try {
                const userClan = getCurrentUserClan();
                const pendingThreads = await getPendingThreadsForClan(userClan);
                
                if (pendingThreads.length === 0) {
                    moderationContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            ✅ Nessun contenuto in attesa di approvazione
                        </div>
                    `;
                    return;
                }

                moderationContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>📋 Thread in attesa di approvazione (${pendingThreads.length})</h4>
                    </div>
                    ${pendingThreads.map(thread => `
                        <div class="thread-item thread-pending" style="margin-bottom: 15px;">
                            <div class="thread-main">
                                <div class="thread-title">
                                    ${thread.title}
                                    <span class="pending-indicator">PENDING</span>
                                </div>
                                <div class="thread-author">
                                    da ${thread.author} • ${formatTime(thread.createdAt)}
                                </div>
                                <div class="moderation-actions">
                                    <button class="approve-btn" onclick="approveThread('${thread.id}', '${thread.section}')">
                                        ✅ Approva
                                    </button>
                                    <button class="reject-btn" onclick="rejectThread('${thread.id}', '${thread.section}')">
                                        ❌ Rifiuta
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                console.error('Errore caricamento thread pending:', error);
                moderationContent.innerHTML = `
                    <div style="text-align: center; color: red;">
                        Errore nel caricamento dei contenuti da moderare
                    </div>
                `;
            }
        }

        // Ottieni thread in attesa per un clan
        async function getPendingThreadsForClan(clanName) {
            const pendingThreads = [];
            const clanSections = ['clan-war', 'clan-premi', 'clan-consigli', 'clan-bacheca'];
            
            for (const section of clanSections) {
                try {
                    const dataPath = getDataPath(section, 'threads');
                    if (!dataPath) continue;
                    
                    let threads = [];
                    
                    if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                        const threadsRef = ref(window.firebaseDatabase, dataPath);
                        const snapshot = await get(threadsRef);
                        
                        if (snapshot.exists()) {
                            snapshot.forEach((childSnapshot) => {
                                const threadData = childSnapshot.val();
                                if (threadData.status === 'pending') {
                                    threads.push({
                                        id: childSnapshot.key,
                                        section: section,
                                        ...threadData
                                    });
                                }
                            });
                        }
                    } else {
                        // Modalità locale
                        const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                        const localThreads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                        threads = localThreads.filter(t => t.status === 'pending').map(t => ({
                            ...t,
                            section: section
                        }));
                    }
                    
                    pendingThreads.push(...threads);
                } catch (error) {
                    console.error(`Errore caricamento thread pending per ${section}:`, error);
                }
            }
            
            // Ordina per data (più recenti prima)
            return pendingThreads.sort((a, b) => b.createdAt - a.createdAt);
        }

        // Approva thread
        async function approveThread(threadId, section) {
            try {
                await updateThreadStatus(threadId, section, 'approved');
                alert('Thread approvato con successo!');
                loadPendingThreads(); // Ricarica lista
            } catch (error) {
                console.error('Errore approvazione thread:', error);
                alert('Errore nell\'approvazione del thread');
            }
        }

        // Rifiuta thread
        async function rejectThread(threadId, section) {
            const reason = prompt('Motivo del rifiuto (opzionale):');
            
            try {
                await updateThreadStatus(threadId, section, 'rejected', reason);
                alert('Thread rifiutato');
                loadPendingThreads(); // Ricarica lista
            } catch (error) {
                console.error('Errore rifiuto thread:', error);
                alert('Errore nel rifiuto del thread');
            }
        }

        // Aggiorna status thread
        async function updateThreadStatus(threadId, section, status, reason = null) {
            const dataPath = getDataPath(section, 'threads');
            if (!dataPath) return;

            const updateData = {
                status: status,
                moderatedAt: window.useFirebase ? serverTimestamp() : Date.now(),
                moderatedBy: currentUser.displayName || 'Moderatore'
            };

            if (reason) {
                updateData.rejectionReason = reason;
            }

            if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                // leggi i dati esistenti del thread
                const threadRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
                const snapshot = await get(threadRef);
                if (snapshot.exists()) {
                    const existingData = snapshot.val();
                    // mantieni tutti i campi, aggiungendo/modificando solo quelli di moderazione
                    const updatedThread = { ...existingData, ...updateData };
                    await set(threadRef, updatedThread);
                } else {
                    console.warn(`Thread con id ${threadId} non trovato in ${dataPath}`);
                }
            } else {
                // modalità locale
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const threadIndex = threads.findIndex(t => t.id === threadId);
                if (threadIndex !== -1) {
                    threads[threadIndex] = { ...threads[threadIndex], ...updateData };
                    localStorage.setItem(storageKey, JSON.stringify(threads));
                }
            }
        }

        // Carica gestione utenti
        async function loadUsersManagement() {
            const threadList = document.getElementById('thread-list');
            
            threadList.innerHTML = `
                <div class="admin-panel">
                    <h3>👥 Gestione Utenti</h3>
                    <div id="users-grid" class="users-grid">
                        <div style="text-align: center; padding: 20px;">
                            <div>🔄 Caricamento utenti...</div>
                        </div>
                    </div>
                </div>
            `;

            // Carica lista utenti
            loadUsersList();
        }

        // Carica lista utenti
        async function loadUsersList() {
            const usersGrid = document.getElementById('users-grid');
            
            try {
                let users = [];
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    // Carica da Firebase
                    const usersRef = ref(window.firebaseDatabase, 'users');
                    const snapshot = await get(usersRef);
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            users.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                    }
                } else {
                    // Carica da localStorage
                    const localUsers = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    users = Object.values(localUsers);
                }

                displayUsersList(users);
            } catch (error) {
                console.error('Errore caricamento utenti:', error);
                usersGrid.innerHTML = '<div style="text-align: center; color: red;">Errore nel caricamento degli utenti</div>';
            }
        }

        // Visualizza lista utenti
        function displayUsersList(users) {
            const usersGrid = document.getElementById('users-grid');
            
            if (users.length === 0) {
                usersGrid.innerHTML = '<div style="text-align: center; padding: 20px;">Nessun utente trovato</div>';
                return;
            }

            usersGrid.innerHTML = users.map(user => {
                const roleText = user.role === 'superuser' ? 'SUPER' : 
                                user.role === 'clan_mod' ? 'CLAN MOD' : 'USER';
                const roleClass = user.role === 'superuser' ? 'role-superuser' : 
                                 user.role === 'clan_mod' ? 'role-moderator' : 'role-user';
                
                return `
                    <div class="user-card">
                        <div class="user-card-header">
                            <div class="user-card-name">
                                ${user.username} 
                                <span class="user-role ${roleClass}">
                                    ${roleText}
                                </span>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ${formatTime(user.createdAt)}
                            </div>
                        </div>
                        <div class="user-card-info">
                            <div>📧 ${user.email}</div>
                            <div>🏰 Clan: ${user.clan || 'Nessuno'}</div>
                            <div>🔗 Provider: ${user.provider || 'email'}</div>
                        </div>
                        <div class="user-card-actions">
                            <button class="admin-btn btn-assign-clan" onclick="assignClan('${user.id || user.uid}', '${user.username}')">
                                Assegna Clan
                            </button>
                            ${getCurrentUserRole() === USER_ROLES.SUPERUSER ? `
                                <button class="admin-btn btn-change-role" onclick="changeUserRole('${user.id || user.uid}', '${user.username}', '${user.role || 'user'}')">
                                    Cambia Ruolo
                                </button>
                            ` : ''}
                            ${user.clan && user.clan !== 'Nessuno' ? `
                                <button class="admin-btn btn-remove-clan" onclick="removFromClan('${user.id || user.uid}', '${user.username}')">
                                    Rimuovi Clan
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Funzioni amministrative
        async function assignClan(userId, username) {
            const availableClans = await getAvailableClans();
            const clanList = availableClans.length > 0 ? availableClans.join('\n') : 'Nessun clan disponibile';
            
            const clanName = prompt(`Assegna un clan a ${username}:\n\nClan disponibili:\n${clanList}\n\nInserisci il nome del clan:`);
            if (!clanName || clanName.trim() === '') return;
            
            try {
                await updateUserClan(userId, clanName.trim());
                alert(`${username} è stato assegnato al clan "${clanName}"`);
                loadUsersList(); // Ricarica lista
            } catch (error) {
                console.error('Errore assegnazione clan:', error);
                alert('Errore nell\'assegnazione del clan');
            }
        }

        async function changeUserRole(userId, username, currentRole) {
            if (getCurrentUserRole() !== USER_ROLES.SUPERUSER) {
                alert('Solo i superuser possono modificare i ruoli');
                return;
            }
            
            const newRole = prompt(`Cambia il ruolo di ${username}:\n\nRuolo attuale: ${currentRole}\n\nOpzioni:\n- user (utente normale)\n- clan_mod (moderatore di clan)\n- superuser (super amministratore)\n\nInserisci il nuovo ruolo:`);
            
            if (!newRole || !Object.values(USER_ROLES).includes(newRole)) {
                alert('Ruolo non valido');
                return;
            }
            
            try {
                await updateUserRole(userId, newRole);
                alert(`Ruolo di ${username} cambiato in "${newRole}"`);
                loadUsersList(); // Ricarica lista
            } catch (error) {
                console.error('Errore cambio ruolo:', error);
                alert('Errore nel cambio del ruolo');
            }
        }

        async function removFromClan(userId, username) {
            if (confirm(`Rimuovere ${username} dal clan?`)) {
                try {
                    await updateUserClan(userId, 'Nessuno');
                    alert(`${username} è stato rimosso dal clan`);
                    loadUsersList(); // Ricarica lista
                } catch (error) {
                    console.error('Errore rimozione clan:', error);
                    alert('Errore nella rimozione dal clan');
                }
            }
        }

        // Funzioni di aggiornamento database
        async function updateUserClan(userId, clanName) {
            if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                const userRef = ref(window.firebaseDatabase, `users/${userId}/clan`);
                await set(userRef, clanName);
            } else {
                // Aggiorna localStorage
                const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                for (const email in users) {
                    if (users[email].uid === userId) {
                        users[email].clan = clanName;
                        localStorage.setItem('hc_local_users', JSON.stringify(users));
                        break;
                    }
                }
            }
        }

        async function updateUserRole(userId, newRole) {
            if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                const userRef = ref(window.firebaseDatabase, `users/${userId}/role`);
                await set(userRef, newRole);
            } else {
                // Aggiorna localStorage
                const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                for (const email in users) {
                    if (users[email].uid === userId) {
                        users[email].role = newRole;
                        localStorage.setItem('hc_local_users', JSON.stringify(users));
                        break;
                    }
                }
            }
        }

        // Gestione clan
        async function loadClansManagement() {
            const threadList = document.getElementById('thread-list');
            
            threadList.innerHTML = `
                <div class="clan-management">
                    <h3>🏰 Gestione Clan</h3>
                    <button class="create-clan-btn" onclick="createNewClan()">
                        + Crea Nuovo Clan
                    </button>
                    <div id="clans-grid" class="clan-list">
                        <div style="text-align: center; padding: 20px;">
                            <div>🔄 Caricamento clan...</div>
                        </div>
                    </div>
                </div>
            `;

            loadClansList();
        }

        async function loadClansList() {
            const clansGrid = document.getElementById('clans-grid');
            
            try {
                const clans = await getAvailableClans();
                const clanStats = await getClanStats(clans);
                
                if (clans.length === 0) {
                    clansGrid.innerHTML = '<div style="text-align: center; padding: 20px;">Nessun clan trovato</div>';
                    return;
                }

                clansGrid.innerHTML = clans.map(clan => `
                    <div class="clan-card">
                        <h4>${clan}</h4>
                        <div class="clan-members">
                            👥 ${clanStats[clan] || 0} membri
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="admin-btn btn-remove-clan" onclick="deleteClan('${clan}')">
                                Elimina Clan
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Errore caricamento clan:', error);
                clansGrid.innerHTML = '<div style="text-align: center; color: red;">Errore nel caricamento dei clan</div>';
            }
        }

        async function getAvailableClans() {
            let clans = [];
            
            if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                const usersRef = ref(window.firebaseDatabase, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const clanSet = new Set();
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        if (userData.clan && userData.clan !== 'Nessuno') {
                            clanSet.add(userData.clan);
                        }
                    });
                    clans = Array.from(clanSet);
                }
            } else {
                const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                const clanSet = new Set();
                Object.values(users).forEach(user => {
                    if (user.clan && user.clan !== 'Nessuno') {
                        clanSet.add(user.clan);
                    }
                });
                clans = Array.from(clanSet);
            }
            
            return clans.sort();
        }

        async function getClanStats(clans) {
            const stats = {};
            
            if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                const usersRef = ref(window.firebaseDatabase, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    clans.forEach(clan => stats[clan] = 0);
                    
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        if (userData.clan && stats.hasOwnProperty(userData.clan)) {
                            stats[userData.clan]++;
                        }
                    });
                }
            } else {
                const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                clans.forEach(clan => stats[clan] = 0);
                
                Object.values(users).forEach(user => {
                    if (user.clan && stats.hasOwnProperty(user.clan)) {
                        stats[user.clan]++;
                    }
                });
            }
            
            return stats;
        }

        async function createNewClan() {
            const clanName = prompt('Nome del nuovo clan:');
            if (!clanName || clanName.trim() === '') return;
            
            const trimmedName = clanName.trim();
            const existingClans = await getAvailableClans();
            
            if (existingClans.includes(trimmedName)) {
                alert('Questo clan esiste già!');
                return;
            }
            
            alert(`Clan "${trimmedName}" creato! Ora puoi assegnare utenti a questo clan.`);
            loadClansList();
        }

        async function deleteClan(clanName) {
            if (!confirm(`Sei sicuro di voler eliminare il clan "${clanName}"?\n\nTutti i membri verranno rimossi dal clan.`)) {
                return;
            }
            
            try {
                // Rimuovi tutti gli utenti dal clan
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const usersRef = ref(window.firebaseDatabase, 'users');
                    const snapshot = await get(usersRef);
                    
                    if (snapshot.exists()) {
                        const updates = {};
                        snapshot.forEach((childSnapshot) => {
                            const userData = childSnapshot.val();
                            if (userData.clan === clanName) {
                                updates[`users/${childSnapshot.key}/clan`] = 'Nessuno';
                            }
                        });
                        
                        await update(ref(window.firebaseDatabase), updates);
                    }
                } else {
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    Object.values(users).forEach(user => {
                        if (user.clan === clanName) {
                            user.clan = 'Nessuno';
                        }
                    });
                    localStorage.setItem('hc_local_users', JSON.stringify(users));
                }
                
                alert(`Clan "${clanName}" eliminato con successo`);
                loadClansList();
            } catch (error) {
                console.error('Errore eliminazione clan:', error);
                alert('Errore nell\'eliminazione del clan');
            }
        }

        // Genera il path corretto per messaggi/thread in base alla sezione e clan
        function getDataPath(sectionKey, dataType) {
            if (sectionKey.startsWith('clan-')) {
                const userClan = getCurrentUserClan();
                if (userClan === 'Nessuno') {
                    return null;
                }
                // Sostituisci caratteri speciali nel nome del clan per Firebase
                const safeClanName = userClan.replace(/[.#$[\]]/g, '_');
                return `${dataType}/clan/${safeClanName}/${sectionKey}`;
            } else {
                return `${dataType}/${sectionKey}`;
            }
        }

        // Upload immagine thread
        async function uploadThreadImage(file, progressCallback) {
            if (!file) return null;
            
            try {
                if (window.useFirebase && window.firebaseStorage && firebaseReady && storageRef && uploadBytes && getDownloadURL) {
                    try {
                        // Upload su Firebase Storage
                        const timestamp = Date.now();
                        const filename = `threads/${currentUser.uid}/${timestamp}_${file.name}`;
                        const imageRef = storageRef(window.firebaseStorage, filename);
                        
                        // Upload con progress tracking
                        const uploadTask = uploadBytes(imageRef, file);
                        
                        // Simula progress (Firebase v9 non ha onSnapshot per upload)
                        let progress = 0;
                        const progressInterval = setInterval(() => {
                            progress += Math.random() * 30;
                            if (progress > 90) progress = 90;
                            progressCallback(progress);
                        }, 200);
                        
                        const snapshot = await uploadTask;
                        clearInterval(progressInterval);
                        progressCallback(100);
                        
                        // Ottieni URL download
                        const downloadURL = await getDownloadURL(snapshot.ref);
                        return downloadURL;
                        
                    } catch (storageError) {
                        console.warn('⚠️ Errore Firebase Storage, uso fallback locale:', storageError.message);
                        
                        // Fallback: converte in base64 se Firebase Storage fallisce
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                progressCallback(100);
                                console.log('📷 Immagine convertita in base64 (fallback)');
                                resolve(e.target.result);
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                    
                } else {
                    // Modalità locale - converte in base64
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            progressCallback(100);
                            resolve(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    });
                }
            } catch (error) {
                console.error('Errore upload immagine:', error);
                
                // Ultimo tentativo: base64 fallback
                console.log('🔄 Tentativo fallback base64...');
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        progressCallback(100);
                        console.log('📷 Immagine salvata come base64 (fallback finale)');
                        resolve(e.target.result);
                    };
                    reader.onerror = function() {
                        reject(new Error('Errore nella conversione dell\'immagine'));
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // Update upload progress
        function updateUploadProgress(progress) {
            const progressContainer = document.getElementById('upload-progress');
            const progressPercent = Math.round(progress);
            
            progressContainer.innerHTML = `
                <div style="background: rgba(45, 130, 181, 0.2); border-radius: 10px; padding: 10px; margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 12px; color: #3498db; font-weight: 600;">Caricamento immagine...</span>
                        <span style="font-size: 12px; color: #3498db; font-weight: 600;">${progressPercent}%</span>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); border-radius: 5px; height: 6px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; width: ${progressPercent}%; transition: width 0.3s ease; border-radius: 5px;"></div>
                    </div>
                </div>
            `;
            progressContainer.style.display = 'block';
            
            // Nascondi il progresso quando completato
            if (progress >= 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1000);
            }
        }

        // Carica thread
        function loadThreads(sectionKey) {
            const dataPath = getDataPath(sectionKey, 'threads');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && onValue && off) {
                const threadsRef = ref(window.firebaseDatabase, dataPath);
                
                // Cleanup previous listener
                if (threadListeners[sectionKey]) {
                    const oldRef = ref(window.firebaseDatabase, threadListeners[sectionKey].path);
                    off(oldRef, threadListeners[sectionKey].callback);
                }
                
                // Listen for changes
                const callback = (snapshot) => {
                    const threads = [];
                    snapshot.forEach((childSnapshot) => {
                        threads.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Ordina per data (più recenti prima)
                    threads.sort((a, b) => b.createdAt - a.createdAt);
                    
                    displayThreads(threads);
                };

                threadListeners[sectionKey] = { path: dataPath, callback: callback };
                onValue(threadsRef, callback);
            } else {
                // Carica da localStorage (modalità locale)
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                threads.sort((a, b) => b.createdAt - a.createdAt);
                displayThreads(threads);
            }
        }

        // Mostra thread
        function displayThreads(threads) {
            const threadList = document.getElementById('thread-list');
            
            if (threads.length === 0) {
                threadList.innerHTML = `
                    <div class="forum-header">
                        <div>Discussione</div>
                        <div>Risposte</div>
                        <div>Visualizzazioni</div>
                        <div>Ultimo Messaggio</div>
                    </div>
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Nessun thread in questa sezione. Creane uno!
                    </div>
                `;
                return;
            }
            
            // Filtra thread approvati per utenti normali, mostra tutto per moderatori
            const visibleThreads = threads.filter(thread => {
                // Moderatori vedono tutto
                if (canModerateSection(currentSection)) {
                    return true;
                }
                // Utenti normali vedono solo thread approvati
                return !thread.status || thread.status === 'approved';
            });
            
            threadList.innerHTML = `
                <div class="forum-header">
                    <div>Discussione</div>
                    <div>Risposte</div>
                    <div>Visualizzazioni</div>
                    <div>Ultimo Messaggio</div>
                </div>
            ` + visibleThreads.map(thread => {
                const statusClass = thread.status === 'pending' ? 'thread-pending' : 
                                    thread.status === 'rejected' ? 'thread-rejected' : '';
                const statusIndicator = thread.status === 'pending' ? '<span class="pending-indicator">PENDING</span>' : 
                                        thread.status === 'rejected' ? '<span class="pending-indicator" style="background: rgba(231, 76, 60, 0.2); color: #e74c3c;">RIFIUTATO</span>' : '';
                
                return `
                    <div class="thread-item ${statusClass}">
                        <div class="thread-main">
                            <div class="thread-title" onclick="openThread('${thread.id}', '${currentSection}')">
                                ${thread.title}
                                ${statusIndicator}
                            </div>
                            <div class="thread-author">da ${thread.author}</div>
                            <div class="thread-stats-mobile">
                                <div class="stat">
                                    <span>💬</span>
                                    <span>${thread.replies || 0}</span>
                                </div>
                                <div class="stat">
                                    <span>👁️</span>
                                    <span>${thread.views || 0}</span>
                                </div>
                                <div class="stat">
                                    <span>🕐</span>
                                    <span>${formatTime(thread.createdAt)}</span>
                                </div>
                            </div>
                            ${thread.status === 'pending' && canModerateSection(currentSection) ? `
                                <div class="moderation-actions">
                                    <button class="approve-btn" onclick="approveThread('${thread.id}', '${currentSection}')">
                                        ✅ Approva
                                    </button>
                                    <button class="reject-btn" onclick="rejectThread('${thread.id}', '${currentSection}')">
                                        ❌ Rifiuta
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="thread-replies">${thread.replies || 0}</div>
                        <div class="thread-stats">${thread.views || 0}</div>
                        <div class="thread-last-post">
                            <div>${formatTime(thread.createdAt)}</div>
                            <div>da <strong>${thread.author}</strong></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mostra modal creazione thread
        function showThreadCreationModal() {
            if (!currentUser) {
                alert('Devi effettuare l\'accesso per creare thread');
                return;
            }

            // Controlla accesso clan
            if (currentSection.startsWith('clan-') && getCurrentUserClan() === 'Nessuno') {
                alert('Devi appartenere a un clan per creare thread qui!');
                return;
            }

            document.getElementById('threadCreationModal').style.display = 'flex';
            document.getElementById('thread-title-input').focus();
            
            // Setup image upload listener
            setupImageUpload();
        }

        // Setup image upload
        function setupImageUpload() {
            const imageInput = document.getElementById('thread-image-input');
            const imageLabel = document.querySelector('.image-upload-label');
            
            // Remove existing listeners
            imageInput.removeEventListener('change', handleImageSelect);
            imageLabel.removeEventListener('click', () => imageInput.click());
            
            // Add new listeners
            imageInput.addEventListener('change', handleImageSelect);
            imageLabel.addEventListener('click', () => imageInput.click());
        }

        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('image-preview');
            const progressContainer = document.getElementById('upload-progress');
            
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Seleziona solo file immagine (JPG, PNG, GIF, etc.)');
                return;
            }
            
            // Validate file size (max 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('L\'immagine è troppo grande. Massimo 5MB consentiti.');
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Anteprima immagine">
                    <button type="button" class="remove-image" onclick="removeSelectedImage()">
                        🗑️ Rimuovi Immagine
                    </button>
                `;
            };
            reader.readAsDataURL(file);
            
            // Hide progress initially
            progressContainer.style.display = 'none';
        }

        // Remove selected image
        function removeSelectedImage() {
            document.getElementById('thread-image-input').value = '';
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('upload-progress').style.display = 'none';
        }

        // Nascondi modal creazione thread
        function hideThreadCreationModal() {
            document.getElementById('threadCreationModal').style.display = 'none';
            document.getElementById('thread-title-input').value = '';
            document.getElementById('thread-content-input').value = '';
            removeSelectedImage(); // Pulisci anche l'immagine selezionata
        }

        // Crea thread dalla modal
        async function createThread() {
            const title = document.getElementById('thread-title-input').value.trim();
            const content = document.getElementById('thread-content-input').value.trim();
            const imageInput = document.getElementById('thread-image-input');
            const imageFile = imageInput.files[0];
            
            if (!title || !content) {
                alert('Inserisci sia il titolo che il contenuto del thread');
                return;
            }

            const createBtn = document.querySelector('.btn-create-thread');
            const progressContainer = document.getElementById('upload-progress');
            
            createBtn.disabled = true;
            createBtn.textContent = 'Creazione...';

            try {
                const threadData = {
                    title: title,
                    content: content,
                    author: currentUser.displayName || 'Utente',
                    authorId: currentUser.uid
                };

                // Upload immagine se presente
                if (imageFile) {
                    createBtn.textContent = 'Caricamento immagine...';
                    progressContainer.style.display = 'block';
                    
                    const imageUrl = await uploadThreadImage(imageFile, (progress) => {
                        updateUploadProgress(progress);
                    });
                    
                    if (imageUrl) {
                        threadData.imageUrl = imageUrl;
                        threadData.imageName = imageFile.name;
                    }
                }

                // Determina se il thread ha bisogno di approvazione
                const needsApproval = currentSection.startsWith('clan-') && !canModerateSection(currentSection);
                
                if (needsApproval) {
                    threadData.status = 'pending';
                    
                    // Invia notifica ai moderatori del clan
                    const clanModerators = await getClanModerators(getCurrentUserClan());
                    clanModerators.forEach(moderatorId => {
                        sendNotification(
                            moderatorId,
                            'thread_approval',
                            'Nuovo thread da approvare',
                            `${currentUserData.username} ha creato un nuovo thread: "${title}"`,
                            { threadId: '', section: currentSection }
                        );
                    });
                } else {
                    threadData.status = 'approved';
                }

                const dataPath = getDataPath(currentSection, 'threads');
                if (!dataPath) return;

                createBtn.textContent = 'Salvando thread...';

                if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && push && serverTimestamp) {
                    // Salva su Firebase
                    const threadsRef = ref(window.firebaseDatabase, dataPath);
                    threadData.createdAt = serverTimestamp();
                    threadData.replies = 0;
                    threadData.views = 0;
                    await push(threadsRef, threadData);
                } else {
                    // Salva in locale
                    saveLocalThread(currentSection, threadData);
                }

                // Incrementa statistiche utente
                await incrementUserStats(currentUser.uid, 'threadsCount');

                hideThreadCreationModal();
                
                if (needsApproval) {
                    alert('Thread creato! È in attesa di approvazione da parte del moderatore del clan.');
                } else {
                    alert('Thread creato con successo!');
                }
            } catch (error) {
                console.error('Errore creazione thread:', error);
                alert('Errore nella creazione del thread: ' + (error.message || error));
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Crea Thread';
                progressContainer.style.display = 'none';
            }
            loadThreads(currentSection); 
        }

        // Ottieni moderatori del clan
        async function getClanModerators(clanName) {
            const moderators = [];
            
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const usersRef = ref(window.firebaseDatabase, 'users');
                    const snapshot = await get(usersRef);
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const userData = childSnapshot.val();
                            if (userData.clan === clanName && 
                                (userData.role === USER_ROLES.CLAN_MOD || userData.role === USER_ROLES.SUPERUSER)) {
                                moderators.push(childSnapshot.key);
                            }
                        });
                    }
                } else {
                    // Modalità locale
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    Object.values(users).forEach(user => {
                        if (user.clan === clanName && 
                            (user.role === USER_ROLES.CLAN_MOD || user.role === USER_ROLES.SUPERUSER)) {
                            moderators.push(user.uid);
                        }
                    });
                }
            } catch (error) {
                console.error('Errore caricamento moderatori clan:', error);
            }
            
            return moderators;
        }

        // Apri thread per visualizzazione
        async function openThread(threadId, section) {
            if (!currentUser) {
                alert('Devi effettuare l\'accesso per visualizzare i thread');
                return;
            }

            try {
                // Trova il thread
                const thread = await getThread(threadId, section);
                if (!thread) {
                    alert('Thread non trovato');
                    return;
                }

                // Aggiorna visualizzazioni
                await incrementThreadViews(threadId, section);

                // Salva riferimenti
                currentThread = thread;
                currentThreadId = threadId;
                currentThreadSection = section;

                // Mostra vista thread
                document.getElementById('forum-content').style.display = 'none';
                document.getElementById('chat-content').style.display = 'none';
                document.getElementById('thread-view').style.display = 'flex';
                document.getElementById('new-thread-btn').style.display = 'none';

                // Popola dati thread
                document.getElementById('thread-title').textContent = thread.title;
                document.getElementById('thread-author').textContent = thread.author;
                document.getElementById('thread-date').textContent = formatTime(thread.createdAt);
                document.getElementById('thread-views').textContent = `${thread.views || 0} visualizzazioni`;
                
                // Contenuto del thread con immagine se presente
                const threadContentEl = document.getElementById('thread-content');
                let contentHtml = processMentions(escapeHtml(thread.content || 'Nessun contenuto disponibile'));
                
                if (thread.imageUrl) {
                    contentHtml += `
                        <div class="thread-image">
                            <img src="${thread.imageUrl}" 
                                 alt="${thread.imageName || 'Immagine del thread'}" 
                                 onclick="openImageModal('${thread.imageUrl}', '${thread.imageName || 'Immagine del thread'}')"
                                 title="Clicca per ingrandire">
                        </div>
                    `;
                }
                
                threadContentEl.innerHTML = contentHtml;

                // Carica commenti
				loadThreadComments(threadId, section);

				// Reset flag per permettere nuovo setup nei commenti
				commentImageUploadInitialized = false;

				// Chiudi menu mobile se aperto
				closeMobileMenu();

            } catch (error) {
                console.error('Errore apertura thread:', error);
                alert('Errore nell\'apertura del thread');
            }
        }

        // Torna al forum
        function backToForum() {
            document.getElementById('thread-view').style.display = 'none';
            document.getElementById('forum-content').style.display = 'block';
            document.getElementById('new-thread-btn').style.display = 'block';
            
            // Pulisci dati thread
            cleanupCommentImageUpload();

			// Pulisci dati thread
			currentThread = null;
			currentThreadId = null;
			currentThreadSection = null;
						
            // Ricarica contenuto se necessario
            if (currentSection && sectionConfig[currentSection]) {
                const section = sectionConfig[currentSection];
                if (section.type === 'forum') {
                    loadThreads(currentSection);
                } else if (section.type === 'dashboard') {
                    loadDashboard();
                }
            }
        }

        // Ottieni thread per ID
        async function getThread(threadId, section) {
            const dataPath = getDataPath(section, 'threads');
            if (!dataPath) return null;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && get) {
                const threadRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
                const snapshot = await get(threadRef);
                return snapshot.exists() ? { id: threadId, ...snapshot.val() } : null;
            } else {
                // Modalità locale
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                return threads.find(t => t.id === threadId) || null;
            }
        }

        // Incrementa visualizzazioni thread
        async function incrementThreadViews(threadId, section) {
            const dataPath = getDataPath(section, 'threads');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && update) {
                const threadRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
                await update(ref(window.firebaseDatabase), {
                    [`${dataPath}/${threadId}/views`]: (currentThread?.views || 0) + 1
                });
            } else {
                // Modalità locale
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const threadIndex = threads.findIndex(t => t.id === threadId);
                
                if (threadIndex !== -1) {
                    threads[threadIndex].views = (threads[threadIndex].views || 0) + 1;
                    localStorage.setItem(storageKey, JSON.stringify(threads));
                }
            }
        }

        // Carica commenti thread
        function loadThreadComments(threadId, section) {
            const dataPath = getDataPath(section, 'comments');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && onValue) {
                const commentsRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
                
                onValue(commentsRef, (snapshot) => {
                    const comments = [];
                    snapshot.forEach((childSnapshot) => {
                        comments.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Ordina per timestamp
                    comments.sort((a, b) => a.timestamp - b.timestamp);
                    
                    displayThreadComments(comments);
                });
            } else {
                // Modalità locale
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}_${threadId}`;
                const comments = JSON.parse(localStorage.getItem(storageKey) || '[]');
                comments.sort((a, b) => a.timestamp - b.timestamp);
                displayThreadComments(comments);
            }
        }

        // Mostra commenti thread
        function displayThreadComments(comments) {
            const commentsContainer = document.getElementById('thread-comments');
            
            if (comments.length === 0) {
                commentsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Nessun commento ancora. Sii il primo a commentare!
                    </div>
                `;
                return;
            }
            
            commentsContainer.innerHTML = comments.map(comment => {
                let commentContentHtml = '';
                
                // Aggiungi testo del commento se presente
                if (comment.content && comment.content.trim()) {
                    commentContentHtml += `<div class="comment-text">${processMentions(escapeHtml(comment.content))}</div>`;
                }
                
                // Aggiungi immagine se presente
                if (comment.imageUrl) {
                    commentContentHtml += `
                        <div class="comment-image">
                            <img src="${comment.imageUrl}" 
                                 alt="${comment.imageName || 'Immagine del commento'}" 
                                 onclick="openImageModal('${comment.imageUrl}', '${comment.imageName || 'Immagine del commento'}')"
                                 title="Clicca per ingrandire">
                        </div>
                    `;
                }
                
                return `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${comment.author}</span>
                            <span class="comment-time">${formatTime(comment.timestamp)}</span>
                        </div>
                        <div class="comment-content">${commentContentHtml}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            commentsContainer.scrollTop = commentsContainer.scrollHeight;
        }

        // Aggiungi commento
		async function addComment() {
			if (!currentUser) {
				alert('Devi effettuare l\'accesso per commentare');
				return;
			}

			const commentText = document.getElementById('comment-text').value.trim();
			const imageInput = document.getElementById('comment-image-input');
			const imageFile = imageInput.files[0];
			
			if (!commentText && !imageFile) {
				alert('Scrivi un commento o aggiungi un\'immagine prima di inviare');
				return;
			}

			const commentBtn = document.getElementById('submit-comment-btn');
			const progressContainer = document.getElementById('comment-upload-progress');
			
			commentBtn.disabled = true;
			commentBtn.textContent = 'Invio...';

			try {
				const commentData = {
					author: currentUser.displayName || 'Utente',
					authorId: currentUser.uid,
					content: commentText || '',
					threadId: currentThreadId
				};

				// Upload immagine se presente
				if (imageFile) {
					commentBtn.textContent = 'Caricamento immagine...';
					progressContainer.style.display = 'block';
					
					const imageUrl = await uploadThreadImage(imageFile, (progress) => {
						updateCommentUploadProgress(progress);
					});
					
					if (imageUrl) {
						commentData.imageUrl = imageUrl;
						commentData.imageName = imageFile.name;
					}
				}

				const dataPath = getDataPath(currentThreadSection, 'comments');
				if (!dataPath) return;

				commentBtn.textContent = 'Salvando commento...';

				if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && push && serverTimestamp) {
					// Salva su Firebase
					const commentsRef = ref(window.firebaseDatabase, `${dataPath}/${currentThreadId}`);
					commentData.timestamp = serverTimestamp();
					await push(commentsRef, commentData);
					
					// Aggiorna contatore risposte
					await incrementThreadReplies(currentThreadId, currentThreadSection);
				} else {
					// Salva in locale
					saveLocalComment(currentThreadSection, currentThreadId, commentData);
				}

				// Incrementa statistiche utente
				await incrementUserStats(currentUser.uid, 'commentsCount');

				// Invia notifiche per le mentions
				const textarea = document.getElementById('comment-text');
				if (textarea.mentions && textarea.mentions.length > 0) {
					textarea.mentions.forEach(mention => {
						sendNotification(
							mention.userId,
							'mention',
							'Sei stato menzionato',
							`${currentUserData.username} ti ha menzionato in un commento`,
							{ threadId: currentThreadId, section: currentThreadSection }
						);
					});
					textarea.mentions = []; // Reset mentions
				}

				// Pulisci input
				document.getElementById('comment-text').value = '';
				removeCommentSelectedImage();
				
				// Nascondi sezione upload se visibile
				const uploadSection = document.getElementById('comment-image-upload');
				uploadSection.classList.remove('show');
				
			} catch (error) {
				console.error('Errore invio commento:', error);
				alert('Errore nell\'invio del commento: ' + (error.message || error));
			} finally {
				commentBtn.disabled = false;
				commentBtn.textContent = 'Commenta';
				progressContainer.style.display = 'none';
			}
		}

        // Salva commento locale
        function saveLocalComment(section, threadId, commentData) {
            const dataPath = getDataPath(section, 'comments');
            if (!dataPath) return;

            const storageKey = `hc_${dataPath.replace(/\//g, '_')}_${threadId}`;
            const comments = JSON.parse(localStorage.getItem(storageKey) || '[]');
            commentData.timestamp = Date.now();
            commentData.id = 'comment_' + Date.now();
            comments.push(commentData);
            localStorage.setItem(storageKey, JSON.stringify(comments));
            
            // Aggiorna contatore risposte
            incrementThreadReplies(threadId, section);
            
            // Ricarica commenti
            loadThreadComments(threadId, section);
        }

        // Incrementa risposte thread
        async function incrementThreadReplies(threadId, section) {
            const dataPath = getDataPath(section, 'threads');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && update) {
                const threadRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
                await update(ref(window.firebaseDatabase), {
                    [`${dataPath}/${threadId}/replies`]: (currentThread?.replies || 0) + 1
                });
            } else {
                // Modalità locale
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const threadIndex = threads.findIndex(t => t.id === threadId);
                
                if (threadIndex !== -1) {
                    threads[threadIndex].replies = (threads[threadIndex].replies || 0) + 1;
                    localStorage.setItem(storageKey, JSON.stringify(threads));
                }
            }
        }

        // Gestione emoticon
        function toggleEmoticonPicker(type) {
            const panel = document.getElementById(`${type}-emoticon-panel`);
            const isVisible = panel.classList.contains('show');
            
            // Chiudi tutti i panel
            document.querySelectorAll('.emoticon-panel').forEach(p => {
                p.classList.remove('show');
            });
            
            // Mostra quello corrente se non era visibile
            if (!isVisible) {
                panel.classList.add('show');
            }
        }

        // Aggiungi emoticon
        function addEmoticon(type, emoticon) {
            const input = type === 'chat' ? 
                document.getElementById('message-input') : 
                document.getElementById('comment-text');
            
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + emoticon + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + emoticon.length, cursorPos + emoticon.length);
            
            // Chiudi picker
            document.getElementById(`${type}-emoticon-panel`).classList.remove('show');
        }

        // Apri modal immagine a schermo intero
        function openImageModal(imageUrl, imageName) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = imageUrl;
            modalImage.alt = imageName || 'Immagine';
            modal.style.display = 'flex';
            
            // Previeni scroll del body
            document.body.style.overflow = 'hidden';
        }

        // Chiudi modal immagine
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            
            // Ripristina scroll del body
            document.body.style.overflow = 'auto';
        }

        // Chiudi emoticon picker quando si clicca fuori
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.emoticon-picker')) {
                document.querySelectorAll('.emoticon-panel').forEach(panel => {
                    panel.classList.remove('show');
                });
            }
        });

        // Carica messaggi
        function loadMessages(sectionKey) {
            const dataPath = getDataPath(sectionKey, 'messages');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && onValue && off) {
                const messagesRef = ref(window.firebaseDatabase, dataPath);
                
                // Cleanup previous listener
                if (messageListeners[sectionKey]) {
                    const oldRef = ref(window.firebaseDatabase, messageListeners[sectionKey].path);
                    off(oldRef, messageListeners[sectionKey].callback);
                }
                
                // Listen for new messages
                const callback = (snapshot) => {
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Ordina per timestamp
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    
                    displayMessages(messages);
                    updateMessageCounter(messages.length);
                };

                messageListeners[sectionKey] = { path: dataPath, callback: callback };
                onValue(messagesRef, callback);
            } else {
                // Carica da localStorage (modalità locale)
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const messages = JSON.parse(localStorage.getItem(storageKey) || '[]');
                messages.sort((a, b) => a.timestamp - b.timestamp);
                displayMessages(messages);
                updateMessageCounter(messages.length);
            }
        }

        // Mostra messaggi
        function displayMessages(messages) {
            const chatMessages = document.getElementById('chat-messages');
            
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Nessun messaggio in questa chat. Inizia la conversazione!
                    </div>
                `;
                return;
            }
            
            chatMessages.innerHTML = messages.map(msg => `
                <div class="message">
                    <div class="message-author">
                        ${msg.author}
                        <span class="message-time">${formatTime(msg.timestamp)}</span>
                    </div>
                    <div>${processMentions(escapeHtml(msg.message))}</div>
                </div>
            `).join('');
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Salva messaggio locale
        function saveLocalMessage(section, messageData) {
            const dataPath = getDataPath(section, 'messages');
            if (!dataPath) return;

            const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
            const messages = JSON.parse(localStorage.getItem(storageKey) || '[]');
            messageData.timestamp = Date.now();
            messageData.id = 'msg_' + Date.now();
            messages.push(messageData);
            localStorage.setItem(storageKey, JSON.stringify(messages));
            
            // Ricarica messaggi
            loadMessages(section);
        }

        // Salva thread locale
        function saveLocalThread(section, threadData) {
            const dataPath = getDataPath(section, 'threads');
            if (!dataPath) return;

            const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
            const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
            threadData.createdAt = Date.now();
            threadData.id = 'thread_' + Date.now();
            threadData.replies = 0;
            threadData.views = 0;
            
            // Se non ha status, imposta come approved (per compatibilità con thread esistenti)
            if (!threadData.status) {
                threadData.status = 'approved';
            }
            
            // Assicurati che il contenuto sia salvato
            if (!threadData.content) {
                threadData.content = 'Nessun contenuto disponibile';
            }
            
            threads.push(threadData);
            localStorage.setItem(storageKey, JSON.stringify(threads));
            
            // Ricarica thread
            loadThreads(section);
        }

        // Invia messaggio (Firebase o locale)
        async function sendMessage() {
            if (!currentUser) {
                alert('Devi effettuare l\'accesso per inviare messaggi');
                return;
            }

            // Controlla accesso clan
            if (currentSection.startsWith('clan-') && getCurrentUserClan() === 'Nessuno') {
                alert('Devi appartenere a un clan per inviare messaggi qui!');
                return;
            }

            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-message-btn');
            const message = input.value.trim();
            
            if (!message) return;

            input.disabled = true;
            sendBtn.disabled = true;

            try {
                const messageData = {
                    author: currentUser.displayName || 'Utente',
                    authorId: currentUser.uid,
                    message: message
                };

                const dataPath = getDataPath(currentSection, 'messages');
                if (!dataPath) return;

                if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && push && serverTimestamp) {
                    // Invia a Firebase
                    const messagesRef = ref(window.firebaseDatabase, dataPath);
                    messageData.timestamp = serverTimestamp();
                    await push(messagesRef, messageData);
                } else {
                    // Salva in locale
                    saveLocalMessage(currentSection, messageData);
                }

                // Invia notifiche per le mentions
                if (input.mentions && input.mentions.length > 0) {
                    input.mentions.forEach(mention => {
                        sendNotification(
                            mention.userId,
                            'mention',
                            'Sei stato menzionato',
                            `${currentUserData.username} ti ha menzionato in chat`,
                            { section: currentSection }
                        );
                    });
                    input.mentions = []; // Reset mentions
                }

                input.value = '';
            } catch (error) {
                console.error('Errore invio messaggio:', error);
                alert('Errore nell\'invio del messaggio');
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Utility
        function formatTime(timestamp) {
            if (!timestamp) return 'ora';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'ora';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} min fa`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} ore fa`;
            if (diff < 2592000000) return `${Math.floor(diff / 86400000)} giorni fa`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateMessageCounter(count) {
            messageCount = count;
            document.getElementById('messageCounter').textContent = `💬 ${count} messaggi`;
        }

		// Toggle comment image upload section
		function toggleCommentImageUpload() {
			const uploadSection = document.getElementById('comment-image-upload');
			const isVisible = uploadSection.classList.contains('show');
			
			console.log('📷 Toggle upload commento, visibile:', isVisible);
			
			if (isVisible) {
				uploadSection.classList.remove('show');
				removeCommentSelectedImage();
				console.log('📷 Sezione upload nascosta');
			} else {
				uploadSection.classList.add('show');
				// Setup solo se non è già stato fatto
				if (!commentImageUploadInitialized) {
					setupCommentImageUploadSafe();
				}
				console.log('📷 Sezione upload mostrata');
			}
		}

		// Setup comment image upload SICURO (previene doppi listener)
		function setupCommentImageUploadSafe() {
			const imageInput = document.getElementById('comment-image-input');
			const imageLabel = document.querySelector('#comment-image-upload .image-upload-label');
			
			if (!imageInput || !imageLabel) {
				console.log('❌ Elementi upload commento non trovati');
				return;
			}
			
			// Rimuovi TUTTI i listener esistenti prima di aggiungerne di nuovi
			cleanupCommentImageListeners();
			
			console.log('🔧 Setup listener upload commento (SAFE)');
			
			// Aggiungi listener per il click sulla label
			const clickHandler = () => {
				console.log('🖱️ Click su label upload');
				imageInput.click();
			};
			
			// Aggiungi listener per la selezione file
			const changeHandler = (event) => {
				console.log('📁 File selezionato tramite input');
				handleCommentImageSelect(event);
			};
			
			// Salva riferimenti per cleanup futuro
			imageLabel._commentClickHandler = clickHandler;
			imageInput._commentChangeHandler = changeHandler;
			
			// Aggiungi listener
			imageLabel.addEventListener('click', clickHandler);
			imageInput.addEventListener('change', changeHandler);
			
			commentImageUploadInitialized = true;
			console.log('✅ Listener upload commento configurati');
		}

		// Pulisci tutti i listener per evitare duplicati
		function cleanupCommentImageListeners() {
			const imageInput = document.getElementById('comment-image-input');
			const imageLabel = document.querySelector('#comment-image-upload .image-upload-label');
			
			if (imageInput && imageInput._commentChangeHandler) {
				imageInput.removeEventListener('change', imageInput._commentChangeHandler);
				delete imageInput._commentChangeHandler;
				console.log('🧹 Rimosso listener change esistente');
			}
			
			if (imageLabel && imageLabel._commentClickHandler) {
				imageLabel.removeEventListener('click', imageLabel._commentClickHandler);
				delete imageLabel._commentClickHandler;
				console.log('🧹 Rimosso listener click esistente');
			}
		}

		// Pulisci tutto quando si chiude il thread o si cambia sezione
		function cleanupCommentImageUpload() {
			console.log('🧹 Cleanup completo upload commenti');
			cleanupCommentImageListeners();
			commentImageUploadInitialized = false;
			removeCommentSelectedImage();
			
			const uploadSection = document.getElementById('comment-image-upload');
			if (uploadSection) {
				uploadSection.classList.remove('show');
			}
		}

		// Handle comment image selection
		function handleCommentImageSelect(event) {
			console.log('🖼️ Selezione immagine commento avviata');
			
			const file = event.target.files[0];
			const preview = document.getElementById('comment-image-preview');
			const progressContainer = document.getElementById('comment-upload-progress');
			
			 if (!file) {
				console.log('❌ Nessun file selezionato');
				return;
			}
			
			console.log('📁 File selezionato:', file.name, 'Tipo:', file.type, 'Dimensione:', file.size);
			
			// Validate file type
			if (!file.type.startsWith('image/')) {
				alert('Seleziona solo file immagine (JPG, PNG, GIF, etc.)');
				return;
			}
			
			// Validate file size (max 5MB)
			const maxSize = 5 * 1024 * 1024; // 5MB
			if (file.size > maxSize) {
				alert('L\'immagine è troppo grande. Massimo 5MB consentiti.');
				return;
			}
			
			// Show preview
			const reader = new FileReader();
			reader.onload = function(e) {
				preview.innerHTML = `
					<img src="${e.target.result}" alt="Anteprima immagine commento">
					<button type="button" class="remove-image" onclick="removeCommentSelectedImage()">
						🗑️
					</button>
				`;
			};
			reader.readAsDataURL(file);
			
			// Hide progress initially
			progressContainer.style.display = 'none';
		}

		// Remove selected comment image
		function removeCommentSelectedImage() {
			document.getElementById('comment-image-input').value = '';
			document.getElementById('comment-image-preview').innerHTML = '';
			document.getElementById('comment-upload-progress').style.display = 'none';
		}

		// Update comment upload progress
		function updateCommentUploadProgress(progress) {
			const progressContainer = document.getElementById('comment-upload-progress');
			const progressPercent = Math.round(progress);
			
			progressContainer.innerHTML = `
				<div style="background: rgba(45, 130, 181, 0.2); border-radius: 10px; padding: 10px; margin-top: 10px;">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
						<span style="font-size: 12px; color: #3498db; font-weight: 600;">Caricamento immagine...</span>
						<span style="font-size: 12px; color: #3498db; font-weight: 600;">${progressPercent}%</span>
					</div>
					<div style="background: rgba(255, 255, 255, 0.1); border-radius: 5px; height: 6px; overflow: hidden;">
						<div style="background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; width: ${progressPercent}%; transition: width 0.3s ease; border-radius: 5px;"></div>
					</div>
				</div>
			`;
			progressContainer.style.display = 'block';
			
			// Nascondi il progresso quando completato
			if (progress >= 100) {
				setTimeout(() => {
					progressContainer.style.display = 'none';
				}, 1000);
			}
		}

    </script>

    <!-- Add CSS for new features -->
    <style>
        /* USER MENTION STYLES */
        .user-mention {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .user-mention:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
        }

        /* MENTION SUGGESTION BOX */
        .mention-suggestion-box {
            position: fixed;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            z-index: 2000;
            min-width: 200px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .mention-suggestion-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .mention-suggestion-item:hover,
        .mention-suggestion-item.selected {
            background: var(--hover-bg);
        }

        .mention-suggestion-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .mention-suggestion-info {
            flex: 1;
            min-width: 0;
        }

        .mention-suggestion-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .mention-suggestion-clan {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* NOTIFICATIONS STYLES */
        .notifications-bell {
            transition: all 0.3s ease;
        }

        .notifications-bell.has-notifications {
            animation: bellShake 2s ease-in-out infinite;
        }

        @keyframes bellShake {
            0%, 50%, 100% { transform: rotate(0deg); }
            10%, 30% { transform: rotate(-10deg); }
            20%, 40% { transform: rotate(10deg); }
        }

        .notification-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: var(--hover-bg);
        }

        .notification-item.unread {
            background: rgba(52, 152, 219, 0.1);
            border-left: 3px solid #3498db;
        }

        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .notification-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .notification-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .clear-all-btn {
            background: none;
            border: none;
            color: var(--accent-2);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .clear-all-btn:hover {
            background: var(--hover-bg);
        }

        /* USER PROFILE MODAL */
        .user-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }

        .user-profile-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            backdrop-filter: blur(15px);
            overflow: hidden;
        }

        .user-profile-header {
            background: var(--gradient-primary);
            padding: 30px 20px 20px;
            text-align: center;
            position: relative;
        }

        .close-profile-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .close-profile-btn:hover {
            opacity: 1;
        }

        .profile-avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 15px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .profile-avatar.has-image {
            background: none;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .change-avatar-btn {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: var(--accent-4);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .change-avatar-btn:hover {
            transform: scale(1.1);
        }

        .avatar-upload-input {
            display: none;
        }

        .profile-username {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .profile-clan-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .user-profile-body {
            padding: 20px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-stat {
            text-align: center;
            padding: 15px;
            background: var(--gradient-card);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .profile-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-4);
            margin-bottom: 5px;
        }

        .profile-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .profile-field {
            margin-bottom: 15px;
        }

        .profile-field label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 14px;
        }

        .profile-field input,
        .profile-field textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .profile-field input:focus,
        .profile-field textarea:focus {
            outline: none;
            border-color: var(--accent-2);
            box-shadow: 0 0 0 3px rgba(83, 52, 131, 0.2);
        }

        .profile-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .profile-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-save-profile,
        .btn-cancel-profile {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save-profile {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-cancel-profile {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-save-profile:hover,
        .btn-cancel-profile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* PRIVATE MESSAGES MODAL */
        .private-messages-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }

        .private-messages-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 95%;
            max-width: 900px;
            height: 80vh;
            backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .private-messages-header {
            background: var(--gradient-primary);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .private-messages-header h3 {
            color: white;
            margin: 0;
        }

        .close-messages-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .close-messages-btn:hover {
            opacity: 1;
        }

        .private-messages-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .conversations-list {
            width: 300px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .new-message-btn {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .new-message-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(45, 130, 181, 0.4);
        }

        .conversations-list-container {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .conversation-item:hover,
        .conversation-item.active {
            background: var(--hover-bg);
        }

        .conversation-item.unread {
            background: rgba(52, 152, 219, 0.1);
            border-left: 3px solid #3498db;
        }

        .conversation-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .conversation-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }

        .conversation-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .conversation-details {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .conversation-last-message {
            font-size: 12px;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--text-muted);
            align-self: flex-start;
            margin-top: 2px;
        }

        .conversation-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .conversation-empty {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-muted);
        }

        .conversation-empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .conversation-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .conversation-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
            overflow: hidden;
        }

        .conversation-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .conversation-header-info h4 {
            margin: 0 0 4px 0;
            color: var(--text-primary);
        }

        .user-clan-badge {
            font-size: 12px;
            color: var(--text-muted);
        }

        .conversation-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .private-message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 15px;
        }

        .private-message.own {
            flex-direction: row-reverse;
        }

        .private-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }

        .private-message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .private-message.own .private-message-avatar {
            background: var(--gradient-primary);
        }

        .private-message-content {
            flex: 1;
            min-width: 0;
        }

        .private-message-text {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 10px 15px;
            max-width: 70%;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .private-message.own .private-message-text {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
        }

        .private-message-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            text-align: right;
        }

        .private-message.own .private-message-time {
            text-align: left;
        }

        .conversation-input {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
        }

        .conversation-input-container {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .conversation-input textarea {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            resize: none;
            font-family: inherit;
        }

        .conversation-input textarea:focus {
            outline: none;
            border-color: var(--accent-2);
            box-shadow: 0 0 0 3px rgba(83, 52, 131, 0.2);
        }

        .send-private-message-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-private-message-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(83, 52, 131, 0.4);
        }

        .send-private-message-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* NEW CONVERSATION MODAL */
        .new-conversation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1600;
        }

        .new-conversation-form {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            backdrop-filter: blur(15px);
        }

        .new-conversation-form h3 {
            color: var(--accent-4);
            margin-bottom: 20px;
            text-align: center;
        }

        .user-search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .user-search-input:focus {
            outline: none;
            border-color: var(--accent-2);
            box-shadow: 0 0 0 3px rgba(83, 52, 131, 0.2);
        }

        .user-search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .user-search-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-search-item:hover {
            background: var(--hover-bg);
        }

        .user-search-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }

        .user-search-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-search-info {
            flex: 1;
            min-width: 0;
        }

        .user-search-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .user-search-clan {
            font-size: 12px;
            color: var(--text-muted);
        }

        .new-conversation-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-start-conversation,
        .btn-cancel-conversation {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-start-conversation {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-start-conversation:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        .btn-cancel-conversation {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-start-conversation:hover:not(:disabled),
        .btn-cancel-conversation:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* AVATAR IMPROVEMENTS */
        .sidebar .user-avatar {
            overflow: hidden;
            position: relative;
        }

        .sidebar .user-avatar.has-image {
            background: none;
        }

        .sidebar .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar .user-avatar::before {
            content: '👤';
        }

        .sidebar .user-avatar.has-image::before {
            display: none;
        }

        /* MOBILE IMPROVEMENTS */
        @media (max-width: 768px) {
            .private-messages-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .conversations-list {
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                background: var(--card-bg);
                z-index: 1;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .conversations-list.show {
                transform: translateX(0);
            }

            .conversation-view {
                width: 100%;
            }

            .user-profile-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .profile-stats {
                grid-template-columns: 1fr;
            }

            .new-conversation-form {
                width: 95%;
                margin: 10px;
            }

            .mention-suggestion-box {
                position: fixed;
                bottom: 80px;
                left: 10px;
                right: 10px;
                width: auto;
            }

            .private-message-text {
                max-width: 85%;
            }

            .notification-badge {
                width: 16px;
                height: 16px;
                font-size: 9px;
            }

            .notifications-panel {
                width: calc(100% - 20px);
                left: 10px;
                right: 10px;
            }
        }

        @media (max-width: 480px) {
            .user-profile-header {
                padding: 20px 15px 15px;
            }

            .profile-avatar {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }

            .profile-username {
                font-size: 20px;
            }

            .user-profile-body {
                padding: 15px;
            }

            .private-messages-header {
                padding: 15px;
            }

            .conversation-input {
                padding: 10px 15px;
            }

            .new-conversation-form {
                padding: 20px;
            }

            .mention-suggestion-item {
                padding: 10px;
            }

            .mention-suggestion-avatar {
                width: 20px;
                height: 20px;
                font-size: 10px;
            }
        }

        /* ENHANCED SCROLLBARS */
        .conversations-list-container::-webkit-scrollbar,
        .conversation-messages::-webkit-scrollbar,
        .user-search-results::-webkit-scrollbar,
        .notifications-list::-webkit-scrollbar {
            width: 6px;
        }

        .conversations-list-container::-webkit-scrollbar-track,
        .conversation-messages::-webkit-scrollbar-track,
        .user-search-results::-webkit-scrollbar-track,
        .notifications-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversations-list-container::-webkit-scrollbar-thumb,
        .conversation-messages::-webkit-scrollbar-thumb,
        .user-search-results::-webkit-scrollbar-thumb,
        .notifications-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .conversations-list-container::-webkit-scrollbar-thumb:hover,
        .conversation-messages::-webkit-scrollbar-thumb:hover,
        .user-search-results::-webkit-scrollbar-thumb:hover,
        .notifications-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ACCESSIBILITY IMPROVEMENTS */
        .notification-item:focus,
        .conversation-item:focus,
        .user-search-item:focus,
        .mention-suggestion-item:focus {
            outline: 2px solid var(--accent-4);
            outline-offset: -2px;
        }

        /* ANIMATION IMPROVEMENTS */
        .fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-item.unread {
            animation: slideInFromRight 0.3s ease-out;
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* LOADING STATES */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--accent-2);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ADDITIONAL IMPROVEMENTS */
        .user-card:hover,
        .clan-card:hover,
        .notification-item:hover,
        .conversation-item:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .mention-suggestion-box {
            animation: fadeInScale 0.2s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* CLAN BADGE COLORS */
        .clan-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .clan-draghi-rossi {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .clan-leoni-neri {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
        }

        .clan-aquile-bianche {
            background: linear-gradient(45deg, #ecf0f1, #bdc3c7);
            color: #2c3e50;
        }

        /* STATUS INDICATORS */
        .status-online {
            color: var(--success);
        }

        .status-offline {
            color: var(--text-muted);
        }

        .status-away {
            color: var(--warning);
        }

        /* ENHANCED BORDERS */
        .thread-item:hover,
        .message:hover,
        .comment:hover {
            border-color: var(--accent-2);
        }

        /* SMOOTH TRANSITIONS */
        * {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* FOCUS MANAGEMENT */
        .modal-open {
            overflow: hidden;
        }

        .modal-content:focus {
            outline: none;
        }

        /* PERFORMANCE OPTIMIZATIONS */
        .thread-image img,
        .comment-image img,
        .conversation-avatar img,
        .profile-avatar img {
            will-change: transform;
        }

        .dashboard-card,
        .nav-item,
        .thread-item {
            will-change: transform;
        }
    </style>

    <!-- Additional JavaScript for enhanced functionality -->
    <script>
        // Enhanced user interface interactions
        document.addEventListener('DOMContentLoaded', function() {
            // Prevent default drag behavior on images
            document.addEventListener('dragstart', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                }
            });

            // Add keyboard navigation support
            document.addEventListener('keydown', function(e) {
                // Alt + N per nuova conversazione
                if (e.altKey && e.key === 'n' && document.getElementById('privateMessagesModal').style.display === 'flex') {
                    e.preventDefault();
                    showNewConversationModal();
                }

                // Ctrl + Enter per inviare messaggi
                if (e.ctrlKey && e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement.id === 'privateMessageInput') {
                        sendPrivateMessage();
                    }
                }
            });

            // Auto-hide notifications panel when clicking outside
            document.addEventListener('click', function(e) {
                const panel = document.getElementById('notificationsPanel');
                const bell = document.getElementById('notificationsBell');
                
                if (panel.style.display === 'block' && 
                    !panel.contains(e.target) && 
                    !bell.contains(e.target)) {
                    panel.style.display = 'none';
                }
            });

            // Enhanced mobile menu handling
            let touchStartX = 0;
            let touchEndX = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            document.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipeGesture();
            });
            
            function handleSwipeGesture() {
                const swipeThreshold = 50;
                const swipeDistance = touchEndX - touchStartX;
                
                if (Math.abs(swipeDistance) > swipeThreshold) {
                    if (swipeDistance > 0 && touchStartX < 50) {
                        // Swipe right from left edge - open menu
                        openMobileMenu();
                    } else if (swipeDistance < 0 && document.querySelector('.sidebar').classList.contains('open')) {
                        // Swipe left when menu is open - close menu
                        closeMobileMenu();
                    }
                }
            }

            // Enhanced image loading with lazy loading effect
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        imageObserver.unobserve(img);
                    }
                });
            });

            images.forEach(img => imageObserver.observe(img));

            // Performance optimization: Throttle scroll events
            let scrollTimer = null;
            function throttleScroll(callback, time) {
                if (scrollTimer) return;
                scrollTimer = setTimeout(() => {
                    callback();
                    scrollTimer = null;
                }, time);
            }

            // Auto-scroll to bottom for chat messages
            const chatContainer = document.getElementById('chat-messages');
            if (chatContainer) {
                const observer = new MutationObserver(() => {
                    throttleScroll(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 100);
                });
                
                observer.observe(chatContainer, {
                    childList: true,
                    subtree: true
                });
            }

            // Enhanced focus management for modals
            function trapFocus(element) {
                const focusableElements = element.querySelectorAll(
                    'a[href], button, textarea, input[type="text"], input[type="radio"], input[type="checkbox"], select'
                );
                const firstFocusableElement = focusableElements[0];
                const lastFocusableElement = focusableElements[focusableElements.length - 1];

                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') {
                        if (e.shiftKey) {
                            if (document.activeElement === firstFocusableElement) {
                                lastFocusableElement.focus();
                                e.preventDefault();
                            }
                        } else {
                            if (document.activeElement === lastFocusableElement) {
                                firstFocusableElement.focus();
                                e.preventDefault();
                            }
                        }
                    }
                });
            }

            // Apply focus trapping to modals
            const modals = [
                'loginModal',
                'threadCreationModal',
                'userProfileModal',
                'privateMessagesModal',
                'newConversationModal'
            ];

            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    trapFocus(modal);
                }
            });

            // Enhanced error handling and user feedback
            window.addEventListener('error', function(e) {
                console.error('Errore JavaScript:', e.error);
                
                // Show user-friendly error message for critical errors
                if (e.error && e.error.message && !e.error.message.includes('Script error')) {
                    const errorNotification = document.createElement('div');
                    errorNotification.className = 'error-notification';
                    errorNotification.innerHTML = `
                        <div style="background: rgba(231, 76, 60, 0.9); color: white; padding: 10px 15px; border-radius: 8px; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; animation: slideInFromTop 0.3s ease;">
                            ⚠️ Si è verificato un errore imprevisto. Ricarica la pagina se il problema persiste.
                            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; margin-left: 10px; cursor: pointer;">✕</button>
                        </div>
                    `;
                    document.body.appendChild(errorNotification);
                    
                    setTimeout(() => {
                        if (errorNotification.parentElement) {
                            errorNotification.remove();
                        }
                    }, 5000);
                }
            });

            // Service Worker registration for PWA capabilities (if needed)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
            }

            // Enhanced accessibility announcements
            function announceToScreenReader(message) {
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', 'polite');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = message;
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    document.body.removeChild(announcement);
                }, 1000);
            }

            // Make announcement function globally available
            window.announceToScreenReader = announceToScreenReader;

            console.log('🎮 Hustle Castle Council Forum caricato completamente!');
            console.log('✨ Funzionalità attive: Notifiche, Messaggi Privati, Tagging Utenti, Avatar Personalizzati');
        });

        // Additional utility functions for enhanced user experience
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            const typeColors = {
                success: '#27ae60',
                error: '#e74c3c',
                warning: '#f39c12',
                info: '#3498db'
            };
            
            toast.innerHTML = `
                <div style="
                    background: ${typeColors[type] || typeColors.info}; 
                    color: white; 
                    padding: 12px 20px; 
                    border-radius: 8px; 
                    position: fixed; 
                    bottom: 20px; 
                    right: 20px; 
                    z-index: 10000; 
                    animation: slideInFromRight 0.3s ease;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    max-width: 300px;
                ">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutToRight 0.3s ease';
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }

        // Make utility functions globally available
        window.debounce = debounce;
        window.showToast = showToast;

        // CSS animations for toasts
        const toastStyles = document.createElement('style');
        toastStyles.textContent = `
            @keyframes slideInFromRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutToRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            @keyframes slideInFromTop {
                from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
            
            .sr-only {
                position: absolute !important;
                width: 1px !important;
                height: 1px !important;
                padding: 0 !important;
                margin: -1px !important;
                overflow: hidden !important;
                clip: rect(0, 0, 0, 0) !important;
                white-space: nowrap !important;
                border: 0 !important;
            }
        `;
        document.head.appendChild(toastStyles);
    </script>
</body>
</html>
   