<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hustle Castle Forum</title>
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getDatabase, ref, push, set, get, onValue, off, serverTimestamp, onDisconnect, child, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        
        // üî• CONFIGURAZIONE FIREBASE CORRETTA
       
		const firebaseConfig = {
		  apiKey: "AIzaSyDjHhviNJSn13Mz0XhoJ9hrjgdPz88fRJU",
		  authDomain: "hustlecastlecouncil.firebaseapp.com",
		  projectId: "hustlecastlecouncil",
		  storageBucket: "hustlecastlecouncil.firebasestorage.app",
		  messagingSenderId: "778970862600",
		  appId: "1:778970862600:web:ba81f607bb6792362eadbd",
		  measurementId: "G-N6XQ6W4PN7"
		};
  
        
        // Inizializza Firebase
        let useFirebase = true;
        let app = null;
        
        try {
            app = initializeApp(firebaseConfig);
            console.log('üî• Firebase inizializzato con successo');
        } catch (error) {
            console.error('‚ùå Errore inizializzazione Firebase:', error);
            useFirebase = false;
            alert('‚ö†Ô∏è Firebase non configurato. Il forum funzioner√† in modalit√† demo locale.');
        }
        
        const auth = useFirebase ? getAuth(app) : null;
        const database = useFirebase ? getDatabase(app) : null;
        const googleProvider = useFirebase ? new GoogleAuthProvider() : null;
        
        // Esponi Firebase globalmente per compatibilit√†
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.useFirebase = useFirebase;
        window.firebaseImports = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            signOut,
            updateProfile,
            GoogleAuthProvider,
            signInWithPopup,
            ref,
            push,
            set,
            get,
            onValue,
            off,
            serverTimestamp,
            onDisconnect,
            child,
            update
        };
        window.googleProvider = googleProvider;
    </script>
    
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button id="mobileMenuToggle" class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
    
    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay" onclick="closeMobileMenu()"></div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status offline">üî¥ Disconnesso</div>
    
    <!-- Message Counter -->
    <div id="messageCounter" class="message-counter">üí¨ 0 messaggi</div>

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-form">
            <h2>üè∞ Benvenuto nel Forum</h2>
            
            <!-- Tabs per Login/Registrazione -->
            <div class="login-tabs">
                <button id="loginTab" class="login-tab active" onclick="switchToLogin()">Accedi</button>
                <button id="registerTab" class="login-tab" onclick="switchToRegister()">Registrati</button>
            </div>
            
            <div id="firebase-status" style="text-align: center; margin-bottom: 15px; padding: 10px; border-radius: 8px; font-size: 12px;">
                <!-- Status will be updated by JavaScript -->
            </div>
            
            <!-- Login con Google -->
            <button id="googleLoginBtn" class="google-login-btn" onclick="handleGoogleLogin()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span id="googleBtnText">Continua con Google</span>
            </button>
            
            <div class="divider">
                <span>oppure</span>
            </div>
            
            <div id="loginError" class="error"></div>
            <div id="loginSuccess" class="success"></div>
            
            <!-- Campi per registrazione (nascosti inizialmente) -->
            <div id="registrationFields" class="registration-fields">
                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" placeholder="Scegli il tuo username">
                </div>
               <!-- <div class="form-group">
                    <label for="clan">Clan (opzionale)</label>
                    <input type="text" id="clan" placeholder="Nome del tuo clan">
                </div>-->
            </div>
            
            <!-- Campi comuni -->
            <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" placeholder="Inserisci la tua email">
            </div>
            <div class="form-group">
                <label for="password">Password *</label>
                <input type="password" id="password" placeholder="Inserisci la password">
            </div>
            
            <div class="form-buttons">
                <button id="submitBtn" class="btn-primary" onclick="handleSubmit()">Accedi</button>
            </div>
            
            <div id="loading" class="loading">
                <div>üîÑ Connessione in corso...</div>
            </div>
            
            <div style="text-align: center; margin-top: 15px; font-size: 11px; color: #666;">
                <p id="demo-hint">üí° Per testare: usa qualsiasi email/password per registrarti</p>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo">
            <h1>üè∞ Hustle Castle</h1>
        </div>
        
        <div class="user-info">
            <div class="user-avatar"></div>
            <div style="display: inline-block; vertical-align: middle;">
                <div class="user-name">
                    <span id="currentUsername">Ospite</span>
                    <span id="userStatus" class="offline-indicator"></span>
                </div>
                <div class="user-clan">Clan: <span id="currentClan">Nessuno</span></div>
                <button id="logoutBtn" class="logout-btn" style="display: none;">Logout</button>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">üè† Home</div>
            <div class="nav-item active" data-section="home">
                <span>üè† Dashboard</span>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">üåç Generale</div>
            <div class="nav-item" data-section="eventi">
                <span>üìÖ Eventi</span>
            </div>
            <div class="nav-item" data-section="oggetti">
                <span>‚öîÔ∏è Oggetti</span>
            </div>
            <div class="nav-item" data-section="novita">
                <span>üÜï Novit√†</span>
            </div>
            <div class="nav-item" data-section="chat-generale">
                <span>üí¨ Chat Generale</span>
            </div>
        </div>

        <div class="nav-section" id="adminSection" style="display: none;">
            <div class="nav-title">‚öôÔ∏è Amministrazione</div>
            <div class="nav-item" data-section="admin-users">
                <span>üë• Gestione Utenti</span>
            </div>
            <div class="nav-item" data-section="admin-clans">
                <span>üè∞ Gestione Clan</span>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">üõ°Ô∏è Clan: <span id="sidebarClan">Nessuno</span></div>
            <div class="nav-item clan-only" data-section="clan-moderation" id="clanModerationItem" style="display: none;">
                <span>üõ°Ô∏è Moderazione</span>
            </div>
            <div class="nav-item clan-only" data-section="clan-chat">
                <span>üí¨ Chat Clan</span>
            </div>
            <div class="nav-item clan-only" data-section="clan-war">
                <span>‚öîÔ∏è Guerra</span>
            </div>
            <div class="nav-item clan-only" data-section="clan-premi">
                <span>üèÜ Premi</span>
            </div>
            <div class="nav-item clan-only" data-section="clan-consigli">
                <span>üí° Consigli</span>
            </div>
			<div class="nav-item clan-only" data-section="clan-bacheca">
                <span>üè∞ Bacheca</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Banner Hero -->
        <div class="banner">
            <div class="banner-content">
                <div class="banner-title">‚öîÔ∏è Hustle Castle ‚öîÔ∏è</div>
                <div class="banner-subtitle">Il Forum Ufficiale della Community</div>
            </div>
        </div>

        <div class="header">
            <h2 id="section-title">üè† Dashboard</h2>
            <p id="section-description">Benvenuto nel Forum di Hustle Castle! Ecco le ultime novit√†</p>
        </div>

        <div class="content-area">
            <!-- Forum Layout -->
            <div class="forum-layout" id="forum-content">
                <div class="thread-list" id="thread-list">
                    <!-- I thread verranno generati dinamicamente -->
                </div>
            </div>

            <!-- Chat Layout -->
            <div class="chat-mode" id="chat-content">
                <div class="chat-messages" id="chat-messages">
                    <!-- I messaggi verranno generati dinamicamente -->
                </div>
                <div id="typingIndicator" class="typing-indicator"></div>
                <div class="chat-input">
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <div style="flex: 1;">
                            <input type="text" id="message-input" placeholder="Scrivi un messaggio..." />
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <div class="emoticon-picker">
                                <button class="emoticon-btn" onclick="toggleEmoticonPicker('chat')">üòä</button>
                                <div class="emoticon-panel" id="chat-emoticon-panel">
                                    <div class="emoticon-grid">
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üòä')">üòä</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üòÇ')">üòÇ</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üéâ')">üéâ</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üëç')">üëç</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üëé')">üëé</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üî•')">üî•</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üí™')">üí™</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üéØ')">üéØ</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '‚öîÔ∏è')">‚öîÔ∏è</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üè∞')">üè∞</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üõ°Ô∏è')">üõ°Ô∏è</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üèÜ')">üèÜ</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üíé')">üíé</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', '‚≠ê')">‚≠ê</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üöÄ')">üöÄ</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'üíØ')">üíØ</button>
                                        <button class="emoticon-item" onclick="addEmoticon('chat', 'ü§î')">ü§î</button>
                                    </div>
                                </div>
                            </div>
                            <button id="send-message-btn" onclick="sendMessage()">Invia</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thread View -->
            <div class="thread-view" id="thread-view">
                <div style="width: 100%; display: flex; flex-direction: column; height: 100%;">
                    <button class="back-btn" onclick="backToForum()">‚Üê Torna al Forum</button>
                    
                    <div class="thread-header">
                        <h1 id="thread-title">Titolo Thread</h1>
                        <div class="thread-meta">
                            <span id="thread-author">Autore</span> ‚Ä¢ 
                            <span id="thread-date">Data</span> ‚Ä¢ 
                            <span id="thread-views">0 visualizzazioni</span>
                        </div>
                        <div class="thread-content" id="thread-content">
                            Contenuto del thread...
                        </div>
                    </div>
                    
                    <div class="thread-comments" id="thread-comments">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Nessun commento ancora. Sii il primo a commentare!
                        </div>
                    </div>
                    
                    <div class="comment-input">
                        <div style="display: flex; align-items: flex-end; gap: 10px;">
                            <div style="flex: 1;">
                                <textarea id="comment-text" placeholder="Scrivi un commento..."></textarea>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <div class="emoticon-picker">
                                    <button class="emoticon-btn" onclick="toggleEmoticonPicker('comment')">üòä</button>
                                    <div class="emoticon-panel" id="comment-emoticon-panel">
                                        <div class="emoticon-grid">
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üòä')">üòä</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üòÇ')">üòÇ</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üéâ')">üéâ</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üëç')">üëç</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üëé')">üëé</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üî•')">üî•</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üí™')">üí™</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üéØ')">üéØ</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', '‚öîÔ∏è')">‚öîÔ∏è</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üè∞')">üè∞</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üõ°Ô∏è')">üõ°Ô∏è</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üèÜ')">üèÜ</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üíé')">üíé</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', '‚≠ê')">‚≠ê</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üöÄ')">üöÄ</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'üíØ')">üíØ</button>
                                            <button class="emoticon-item" onclick="addEmoticon('comment', 'ü§î')">ü§î</button>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="addComment()" style="padding: 10px 20px; background: linear-gradient(45deg, #DAA520, #B8860B); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Commenta</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="new-thread-btn" class="new-thread-btn" onclick="showThreadCreationModal()">+ Nuovo Thread</button>

    <!-- Thread Creation Modal -->
    <div id="threadCreationModal" class="thread-creation-modal">
        <div class="thread-creation-form">
            <h3>üè∞ Crea Nuovo Thread</h3>
            
            <input type="text" id="thread-title-input" placeholder="Titolo del thread *" />
            <textarea id="thread-content-input" placeholder="Contenuto del thread *"></textarea>
            
            <div class="thread-creation-buttons">
                <button class="btn-create-thread" onclick="createThread()">Crea Thread</button>
                <button class="btn-cancel-thread" onclick="hideThreadCreationModal()">Annulla</button>
            </div>
        </div>
    </div>

    <script>
	
	 // Aggiungi animazioni al caricamento
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
            });

            // Effetto hover per i nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });
	
	
        // Aspetta che Firebase sia caricato
        window.addEventListener('load', async () => {
            // Attendi che i moduli Firebase siano pronti
            await new Promise(resolve => {
                const checkFirebase = () => {
                    if (window.firebaseApp && window.firebaseAuth && window.firebaseDatabase) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });

            // Inizializza l'app
            initializeApp();
        });

        // Variabili globali
        let currentUser = null;
        let currentSection = 'home';
        let messageListeners = {};
        let threadListeners = {};
        let messageCount = 0;
        let isConnected = false;
        let firebaseReady = false;
        let isLoginMode = true; // true = login, false = register
        let currentUserData = null; // Dati completi dell'utente corrente
        let currentThread = null;
        let currentThreadId = null;
        let currentThreadSection = null;

        // Ruoli utente - DEVE essere definito prima di tutto
        const USER_ROLES = {
            SUPERUSER: 'superuser',
            CLAN_MOD: 'clan_mod',
            USER: 'user'
        };

        // Funzioni Firebase (saranno assegnate quando Firebase √® pronto)
        let signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, 
            signOut, updateProfile, GoogleAuthProvider, signInWithPopup, ref, push, set, get, onValue, off, serverTimestamp, 
            onDisconnect, child, update;

        // Rendi le funzioni globali per gli onclick
        window.switchToLogin = switchToLogin;
        window.switchToRegister = switchToRegister;
        window.handleSubmit = handleSubmit;
        window.handleGoogleLogin = handleGoogleLogin;
        window.sendMessage = sendMessage;
        window.showThreadCreationModal = showThreadCreationModal;
        window.hideThreadCreationModal = hideThreadCreationModal;
        window.createThread = createThread;
        window.openThread = openThread;
        window.backToForum = backToForum;
        window.addComment = addComment;
        window.toggleEmoticonPicker = toggleEmoticonPicker;
        window.addEmoticon = addEmoticon;
        window.toggleMobileMenu = toggleMobileMenu;
        window.closeMobileMenu = closeMobileMenu;
        window.approveThread = approveThread;
        window.rejectThread = rejectThread;
        window.assignClan = assignClan;
        window.changeUserRole = changeUserRole;
        window.removFromClan = removFromClan;
        window.createNewClan = createNewClan;
        window.deleteClan = deleteClan;
        window.switchSection = switchSection;

        // Funzioni per la gestione dei ruoli
        function getCurrentUserRole() {
            return currentUserData?.role || USER_ROLES.USER;
        }

        function getCurrentUserClan() {
            const clanElement = document.getElementById('currentClan');
            return clanElement ? clanElement.textContent : 'Nessuno';
        }

        function hasRole(requiredRole) {
            const currentRole = getCurrentUserRole();
            if (currentRole === USER_ROLES.SUPERUSER) return true;
            if (requiredRole === USER_ROLES.CLAN_MOD && currentRole === USER_ROLES.CLAN_MOD) return true;
            if (requiredRole === USER_ROLES.USER) return true;
            return false;
        }

        function isClanModerator() {
            const currentRole = getCurrentUserRole();
            const userClan = getCurrentUserClan();
            return (currentRole === USER_ROLES.CLAN_MOD || currentRole === USER_ROLES.SUPERUSER) && userClan !== 'Nessuno';
        }

        function canModerateSection(sectionKey) {
            const currentRole = getCurrentUserRole();
            const userClan = getCurrentUserClan();
            
            if (currentRole === USER_ROLES.SUPERUSER) return true;
            
            if (sectionKey.startsWith('clan-') && currentRole === USER_ROLES.CLAN_MOD) {
                return userClan !== 'Nessuno';
            }
            
            return false;
        }

        function canAccessSection(sectionKey) {
            const section = sectionConfig[sectionKey];
            if (!section) return false;
            
            // Controllo accesso clan
            if (sectionKey.startsWith('clan-') && getCurrentUserClan() === 'Nessuno') {
                return false;
            }
            
            // Controllo accesso admin (solo superuser)
            if (section.requiredRole === USER_ROLES.SUPERUSER && getCurrentUserRole() !== USER_ROLES.SUPERUSER) {
                return false;
            }
            
            return true;
        }

        // Configurazione sezioni - DEVE essere definito dopo USER_ROLES
        const sectionConfig = {
            'home': {
                title: 'üè† Dashboard',
                description: 'Benvenuto nel Forum di Hustle Castle! Ecco le ultime novit√†',
                type: 'dashboard'
            },
            'eventi': {
                title: 'üìÖ Eventi',
                description: 'Scopri tutti gli eventi in corso e futuri di Hustle Castle',
                type: 'forum'
            },
            'oggetti': {
                title: '‚öîÔ∏è Oggetti',
                description: 'Discussioni su armi, armature e oggetti del gioco',
                type: 'forum'
            },
            'novita': {
                title: 'üÜï Novit√†',
                description: 'Ultime notizie e aggiornamenti del gioco',
                type: 'forum'
            },
            'chat-generale': {
                title: 'üí¨ Chat Generale',
                description: 'Chiacchiere libere tra tutti i giocatori',
                type: 'chat'
            },
            'admin-users': {
                title: 'üë• Gestione Utenti',
                description: 'Pannello amministrativo per gestire utenti e clan',
                type: 'admin',
                requiredRole: USER_ROLES.SUPERUSER
            },
            'admin-clans': {
                title: 'üè∞ Gestione Clan',
                description: 'Creazione e gestione dei clan',
                type: 'admin',
                requiredRole: USER_ROLES.SUPERUSER
            },
            'clan-moderation': {
                title: 'üõ°Ô∏è Moderazione Clan',
                description: 'Gestione e approvazione contenuti del clan',
                type: 'clan-admin'
            },
            'clan-chat': {
                title: 'üí¨ Chat Clan',
                description: 'Chat privata del tuo clan',
                type: 'chat'
            },
            'clan-war': {
                title: '‚öîÔ∏è Guerra Clan',
                description: 'Strategie e coordinamento per le guerre tra clan',
                type: 'forum'
            },
            'clan-premi': {
                title: 'üèÜ Premi Clan',
                description: 'Ricompense e achievement del clan',
                type: 'forum'
            },
            'clan-consigli': {
                title: 'üí° Consigli Clan',
                description: 'Suggerimenti e guide per i membri del clan',
                type: 'forum'
            },
			'clan-bacheca': {
                title: 'üè∞ Bacheca Clan',
                description: 'Messaggi importati per i membri del clan',
                type: 'forum'
            }
        };

        // Inizializza l'applicazione
        function initializeApp() {
            console.log('üî• Inizializzazione applicazione...');
            
            // Assegna funzioni Firebase se disponibili
            if (window.firebaseImports) {
                ({
                    signInWithEmailAndPassword,
                    createUserWithEmailAndPassword,
                    onAuthStateChanged,
                    signOut,
                    updateProfile,
                    GoogleAuthProvider,
                    signInWithPopup,
                    ref,
                    push,
                    set,
                    get,
                    onValue,
                    off,
                    serverTimestamp,
                    onDisconnect,
                    child,
                    update
                } = window.firebaseImports);
                firebaseReady = true;
            }
            
            // Aggiorna status Firebase nella modal
            const statusEl = document.getElementById('firebase-status');
            const hintEl = document.getElementById('demo-hint');
            
            if (window.useFirebase && window.firebaseAuth && firebaseReady) {
                console.log('‚úÖ Modalit√† Firebase attiva');
                statusEl.style.background = 'rgba(0, 255, 0, 0.1)';
                statusEl.style.color = '#008800';
                statusEl.textContent = 'üî• Firebase connesso - Configurare regole database per primo superuser';
                hintEl.innerHTML = `üîê <strong>Primo accesso?</strong><br>
                    1. Registrati normalmente (sarai USER)<br>
                    2. Configura regole Firebase o usa admin@hustlecastle.com / admin123 (SUPER)<br>
                    3. Usa il pannello admin per promuovere il tuo account`;
                
                // Monitora stato autenticazione
                onAuthStateChanged(window.firebaseAuth, (user) => {
                    if (user) {
                        currentUser = user;
                        handleUserLogin(user);
                    } else {
                        currentUser = null;
                        handleUserLogout();
                    }
                });

                // Monitora connessione
                const connectedRef = ref(window.firebaseDatabase, '.info/connected');
                onValue(connectedRef, (snapshot) => {
                    isConnected = snapshot.val() === true;
                    updateConnectionStatus();
                });
            } else {
                console.log('‚ö†Ô∏è Modalit√† locale attiva');
                statusEl.style.background = 'rgba(255, 165, 0, 0.1)';
                statusEl.style.color = '#ff8800';
                statusEl.textContent = '‚ö†Ô∏è Modalit√† Demo - Login Google non disponibile';
                hintEl.textContent = 'üí° Demo: SuperUser (admin@hustlecastle.com / admin123), Clan Mod (mod@draghi.com / mod123), User (player@leoni.com / player123)';
                
                // Nascondi pulsante Google in modalit√† demo
                document.getElementById('googleLoginBtn').style.display = 'none';
                
                // Inizializza dati di esempio per la demo
                initializeLocalData();
                // In modalit√† locale, mostra sempre il login
                handleUserLogout();
                // Simula connessione locale
                isConnected = true;
                updateConnectionStatus();
            }

            // Setup UI
            setupEventListeners();
            switchSection('home');
        }

        // Gestione login utente
        function handleUserLogin(user) {
            console.log('üë§ Utente loggato:', user.email);
            
            // Nascondi modal login
            document.getElementById('loginModal').style.display = 'none';
            
            // Aggiorna UI
            updateUserInterface();
            
            // Setup presenza utente
            setupUserPresence();
            
            // Carica dati utente
            loadUserProfile();
            
            // Aggiorna dashboard se √® la sezione corrente
            if (currentSection === 'home') {
                setTimeout(() => {
                    loadDashboard();
                }, 500); // Piccolo delay per permettere il caricamento dei dati utente
            }
        }

        // Gestione logout utente
        function handleUserLogout() {
            console.log('üë§ Utente disconnesso');
            
            // Pulisci listeners
            cleanupListeners();
            
            // Reset dati utente
            currentUserData = null;
            
            // Reset UI
            document.getElementById('currentUsername').textContent = 'Ospite';
            document.getElementById('currentClan').textContent = 'Nessuno';
            document.getElementById('sidebarClan').textContent = 'Nessuno';
            document.getElementById('userStatus').className = 'offline-indicator';
            document.getElementById('logoutBtn').style.display = 'none';
            
            // Rimuovi badge ruolo
            const userNameElement = document.getElementById('currentUsername');
            const existingBadge = userNameElement.querySelector('.user-role');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Aggiorna accesso clan e admin
            updateClanSectionsAccess();
            updateAdminSectionsAccess();
            
            // Se si √® in una sezione clan o admin, torna alla home
            if (currentSection.startsWith('clan-') || currentSection.startsWith('admin-')) {
                switchSection('home');
            }
            
            // Torna al forum se si √® in vista thread
            if (document.getElementById('thread-view').style.display === 'flex') {
                backToForum();
            }
            
            // Mostra modal login
            document.getElementById('loginModal').style.display = 'flex';
        }

        // Carica profilo utente
        async function loadUserProfile() {
            if (!currentUser) {
                // In modalit√† locale, aggiorna comunque l'accesso clan
                updateClanSectionsAccess();
                return;
            }

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && get) {
                try {
                    const userRef = ref(window.firebaseDatabase, `users/${currentUser.uid}`);
                    const snapshot = await get(userRef);
                    
                    if (snapshot.exists()) {
                        currentUserData = snapshot.val();
                        document.getElementById('currentUsername').textContent = currentUserData.username || 'Utente';
                        document.getElementById('currentClan').textContent = currentUserData.clan || 'Nessuno';
                        document.getElementById('sidebarClan').textContent = currentUserData.clan || 'Nessuno';
                        
                        // Aggiorna badge ruolo
                        updateUserRoleBadge();
                        
                        // Aggiorna dashboard se √® la sezione corrente
                        if (currentSection === 'home') {
                            loadDashboard();
                        }
                    }
                } catch (error) {
                    console.error('Errore caricamento profilo:', error);
                }
            } else {
                // Modalit√† locale - carica da localStorage
                loadLocalUserProfile();
            }
            
            // Aggiorna accesso clan e admin in ogni caso
            updateClanSectionsAccess();
            updateAdminSectionsAccess();
        }

        // Carica profilo locale
        function loadLocalUserProfile() {
            const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
            const userData = users[currentUser.email];
            
            if (userData) {
                // Controlla se questo utente dovrebbe essere superuser
                const realUsers = Object.values(users).filter(user => 
                    !user.uid.startsWith('super_admin_') && 
                    !user.uid.startsWith('clan_mod_') && 
                    !user.uid.startsWith('user_')
                );
                
                // Se √® il primo utente reale e non ha ruolo superuser, assegnaglielo
                if (realUsers.length > 0 && realUsers[0].uid === userData.uid) {
                    if (!userData.role || userData.role === USER_ROLES.USER) {
                        userData.role = USER_ROLES.SUPERUSER;
                        users[currentUser.email] = userData;
                        localStorage.setItem('hc_local_users', JSON.stringify(users));
                        console.log('üéâ Utente promosso a SUPERUSER:', currentUser.email);
                        
                        // Mostra notifica
                        setTimeout(() => {
                            alert('üéâ Congratulazioni! Sei stato promosso a SUPERUSER come primo utente registrato!');
                        }, 1000);
                    }
                }
                
                currentUserData = userData;
                document.getElementById('currentUsername').textContent = userData.username;
                document.getElementById('currentClan').textContent = userData.clan || 'Nessuno';
                document.getElementById('sidebarClan').textContent = userData.clan || 'Nessuno';
                updateUserRoleBadge();
                
                // Aggiorna dashboard se √® la sezione corrente
                if (currentSection === 'home') {
                    loadDashboard();
                }
            }
        }

        // Aggiorna badge ruolo utente
        function updateUserRoleBadge() {
            const userNameElement = document.getElementById('currentUsername');
            const existingBadge = userNameElement.querySelector('.user-role');
            
            if (existingBadge) {
                existingBadge.remove();
            }
            
            const role = getCurrentUserRole();
            const badge = document.createElement('span');
            badge.className = `user-role role-${role.replace('_', '-')}`;
            
            switch (role) {
                case USER_ROLES.SUPERUSER:
                    badge.textContent = 'SUPER';
                    badge.className = 'user-role role-superuser';
                    break;
                case USER_ROLES.CLAN_MOD:
                    badge.textContent = 'MOD';
                    badge.className = 'user-role role-moderator';
                    break;
                default:
                    badge.textContent = 'USER';
                    badge.className = 'user-role role-user';
                    break;
            }
            
            userNameElement.appendChild(badge);
        }

        // Aggiorna accesso alle sezioni admin
        function updateAdminSectionsAccess() {
            const adminSection = document.getElementById('adminSection');
            const clanModerationItem = document.getElementById('clanModerationItem');
            
            // Mostra sezioni admin globali solo al superuser
            const canAccessGlobalAdmin = getCurrentUserRole() === USER_ROLES.SUPERUSER;
            
            if (canAccessGlobalAdmin) {
                adminSection.style.display = 'block';
            } else {
                adminSection.style.display = 'none';
                // Se si √® in una sezione admin, torna agli eventi
                if (currentSection.startsWith('admin-')) {
                    switchSection('eventi');
                }
            }
            
            // Mostra moderazione clan se √® moderatore o superuser del clan
            const canModerateClan = isClanModerator();
            
            if (canModerateClan) {
                clanModerationItem.style.display = 'block';
            } else {
                clanModerationItem.style.display = 'none';
                // Se si √® nella sezione moderazione, torna alla chat clan
                if (currentSection === 'clan-moderation') {
                    switchSection('clan-chat');
                }
            }
        }

        // Setup presenza utente
        function setupUserPresence() {
            if (!currentUser || !window.useFirebase || !window.firebaseDatabase || !firebaseReady || !ref || !onDisconnect || !set || !child || !serverTimestamp) return;
            
            try {
                const userStatusRef = ref(window.firebaseDatabase, `presence/${currentUser.uid}`);
                const userRef = ref(window.firebaseDatabase, `users/${currentUser.uid}`);
                
                // Quando l'utente si disconnette, imposta offline
                onDisconnect(userStatusRef).set({
                    state: 'offline',
                    lastSeen: serverTimestamp()
                });
                
                // Aggiorna ultima visita
                set(child(userRef, 'lastSeen'), serverTimestamp());
                
                // Imposta online
                set(userStatusRef, {
                    state: 'online',
                    lastSeen: serverTimestamp()
                });
            } catch (error) {
                console.error('Errore setup presenza:', error);
            }
        }

        // Aggiorna interfaccia utente
        function updateUserInterface() {
            if (currentUser) {
                document.getElementById('userStatus').className = 'online-indicator';
                document.getElementById('logoutBtn').style.display = 'inline-block';
            }
            updateClanSectionsAccess();
        }

        // Aggiorna accesso alle sezioni clan
        function updateClanSectionsAccess() {
            const userClan = getCurrentUserClan();
            const clanItems = document.querySelectorAll('.nav-item.clan-only');
            
            clanItems.forEach(item => {
                if (userClan === 'Nessuno') {
                    item.classList.add('disabled');
                    item.style.pointerEvents = 'none';
                } else {
                    item.classList.remove('disabled');
                    item.style.pointerEvents = 'auto';
                }
            });
        }

        // Aggiorna stato connessione
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (window.useFirebase) {
                if (isConnected) {
                    statusEl.className = 'connection-status online';
                    statusEl.textContent = 'üü¢ Firebase Connesso';
                } else {
                    statusEl.className = 'connection-status offline';
                    statusEl.textContent = 'üî¥ Firebase Disconnesso';
                }
            } else {
                statusEl.className = 'connection-status online';
                statusEl.textContent = 'üü° Modalit√† Demo Locale';
            }
        }

        // Gestione interfaccia Login/Registrazione
        function switchToLogin() {
            isLoginMode = true;
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('registrationFields').classList.remove('show');
            document.getElementById('submitBtn').textContent = 'Accedi';
            document.getElementById('googleBtnText').textContent = 'Continua con Google';
            
            // Pulisci campi opzionali
            document.getElementById('username').value = '';
            document.getElementById('clan').value = '';
        }

        function switchToRegister() {
            isLoginMode = false;
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registrationFields').classList.add('show');
            document.getElementById('submitBtn').textContent = 'Registrati';
            document.getElementById('googleBtnText').textContent = 'Registrati con Google';
        }

        // Gestione form submit
        function handleSubmit() {
            if (isLoginMode) {
                handleLogin();
            } else {
                handleRegister();
            }
        }

        // Login con Google
        async function handleGoogleLogin() {
            if (!window.useFirebase || !firebaseReady || !signInWithPopup || !window.googleProvider) {
                alert('Login con Google non disponibile in modalit√† demo');
                return;
            }

            const googleBtn = document.getElementById('googleLoginBtn');
            googleBtn.disabled = true;
            googleBtn.innerHTML = `
                <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                Connessione...
            `;

            try {
                const result = await signInWithPopup(window.firebaseAuth, window.googleProvider);
                const user = result.user;
                
                // Verifica se l'utente esiste gi√† nel database
                const userRef = ref(window.firebaseDatabase, `users/${user.uid}`);
                const snapshot = await get(userRef);
                
                if (!snapshot.exists()) {
                    // Nuovo utente Google - chiedi dati aggiuntivi
                    const username = user.displayName || prompt('Inserisci il tuo username:');
                    const clan = prompt('Inserisci il tuo clan (opzionale):') || 'Nessuno';
                    
                    if (!username) {
                        throw new Error('Username richiesto');
                    }
                    
                    // Salva i dati utente
                    await set(userRef, {
                        username: username,
                        email: user.email,
                        clan: clan,
                        createdAt: serverTimestamp(),
                        lastSeen: serverTimestamp(),
                        provider: 'google'
                    });
                }
                
                showSuccess('Login con Google effettuato con successo!');
            } catch (error) {
                console.error('Errore login Google:', error);
                showError(getErrorMessage(error));
            } finally {
                googleBtn.disabled = false;
                googleBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>${isLoginMode ? 'Continua con Google' : 'Registrati con Google'}</span>
                `;
            }
        }

        // Gestione autenticazione (Firebase o locale)
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showError('Inserisci email e password');
                return;
            }

            showLoading(true);
            hideError();

            try {
                if (window.useFirebase && firebaseReady && signInWithEmailAndPassword) {
                    // Autenticazione Firebase
                    await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    showSuccess('Login effettuato con successo!');
                } else {
                    // Autenticazione locale (demo)
                    await simulateLogin(email, password);
                }
            } catch (error) {
                console.error('Errore login:', error);
                showError(getErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        async function handleRegister() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            //const clan = document.getElementById('clan').value;

            if (!email || !password || !username) {
                showError('Inserisci email, password e username');
                return;
            }

            showLoading(true);
            hideError();

            try {
                // Determina il ruolo del nuovo utente
                const userRole = await determineUserRole();
                
                if (window.useFirebase && firebaseReady && createUserWithEmailAndPassword) {
                    // Registrazione Firebase
                    const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                    const user = userCredential.user;

                    await updateProfile(user, { displayName: username });

                    await set(ref(window.firebaseDatabase, `users/${user.uid}`), {
                        username: username,
                        email: email,
                        clan:  'Nessuno',
                        role: userRole,
                        createdAt: serverTimestamp(),
                        lastSeen: serverTimestamp(),
                        provider: 'email'
                    });
                } else {
                    // Registrazione locale (demo)
                    await simulateRegister(email, password, username, clan, userRole);
                }
                
                const roleMessage = userRole === USER_ROLES.SUPERUSER ? 
                    '\nüéâ Sei il primo utente! Ti sono stati assegnati i privilegi di SUPERUSER.' : '';
                
                showSuccess(`Account creato con successo!${roleMessage}`);
            } catch (error) {
                console.error('Errore registrazione:', error);
                showError(getErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        // Determina il ruolo del nuovo utente
        async function determineUserRole() {
            try {
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    // In Firebase, per sicurezza, assumiamo sempre USER come ruolo di default
                    return USER_ROLES.USER;
                } else {
                    // Modalit√† locale - controlla se ci sono utenti reali (non di esempio)
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    
                    // Filtra solo utenti reali (non quelli di esempio)
                    const realUsers = Object.values(users).filter(user => 
                        !user.uid.startsWith('super_admin_') && 
                        !user.uid.startsWith('clan_mod_') && 
                        !user.uid.startsWith('user_')
                    );
                    
                    if (realUsers.length === 0) {
                        return USER_ROLES.SUPERUSER;
                    }
                }
                
                return USER_ROLES.USER;
            } catch (error) {
                console.error('Errore determinazione ruolo:', error);
                return USER_ROLES.USER;
            }
        }

        // Simulazione autenticazione locale
        async function simulateLogin(email, password) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    const user = users[email];
                    
                    if (user && user.password === password) {
                        currentUser = {
                            uid: user.uid,
                            email: email,
                            displayName: user.username
                        };
                        
                        // Salva i dati utente correnti
                        currentUserData = user;
                        
                        // Aggiorna UI con i dati del clan
                        document.getElementById('currentUsername').textContent = user.username;
                        document.getElementById('currentClan').textContent = user.clan || 'Nessuno';
                        document.getElementById('sidebarClan').textContent = user.clan || 'Nessuno';
                        
                        handleUserLogin(currentUser);
                        resolve();
                    } else {
                        reject(new Error('Email o password non validi'));
                    }
                }, 1000);
            });
        }

        async function simulateRegister(email, password, username, clan, role) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    
                    if (users[email]) {
                        reject(new Error('Utente gi√† esistente'));
                        return;
                    }
                    
                    const userId = 'local_' + Date.now();
                    users[email] = {
                        uid: userId,
                        username: username,
                        email: email,
                        password: password,
                        clan: clan || 'Nessuno',
                        role: role || USER_ROLES.USER,
                        createdAt: Date.now()
                    };
                    
                    localStorage.setItem('hc_local_users', JSON.stringify(users));
                    
                    currentUser = {
                        uid: userId,
                        email: email,
                        displayName: username
                    };
                    
                    // Salva i dati utente correnti
                    currentUserData = users[email];
                    
                    // Aggiorna UI con i dati del clan
                    document.getElementById('currentUsername').textContent = username;
                    document.getElementById('currentClan').textContent = clan || 'Nessuno';
                    document.getElementById('sidebarClan').textContent = clan || 'Nessuno';
                    
                    handleUserLogin(currentUser);
                    resolve();
                }, 1000);
            });
        }

        async function handleLogout() {
            try {
                if (window.useFirebase && window.firebaseAuth && firebaseReady && signOut) {
                    await signOut(window.firebaseAuth);
                } else {
                    // Logout locale
                    currentUser = null;
                    handleUserLogout();
                }
            } catch (error) {
                console.error('Errore logout:', error);
            }
        }

        // Inizializza dati di esempio per modalit√† locale
        function initializeLocalData() {
            // Crea utenti di esempio se non esistono
            const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
            
            // Controlla se ci sono utenti reali
            const realUsers = Object.values(users).filter(user => 
                !user.uid.startsWith('super_admin_') && 
                !user.uid.startsWith('clan_mod_') && 
                !user.uid.startsWith('user_')
            );
            
            // Se c'√® gi√† un utente reale ma non ha ruolo superuser, assegnaglielo
            if (realUsers.length > 0) {
                const firstRealUser = realUsers[0];
                if (!firstRealUser.role || firstRealUser.role === USER_ROLES.USER) {
                    firstRealUser.role = USER_ROLES.SUPERUSER;
                    // Trova l'email corrispondente e aggiorna
                    for (const email in users) {
                        if (users[email].uid === firstRealUser.uid) {
                            users[email].role = USER_ROLES.SUPERUSER;
                            localStorage.setItem('hc_local_users', JSON.stringify(users));
                            console.log('üéâ Primo utente reale promosso a SUPERUSER:', email);
                            break;
                        }
                    }
                }
            }
            
            // Crea utenti di esempio solo se non ci sono utenti reali
            if (realUsers.length === 0) {
                // Superuser di default
                const defaultSuperUser = {
                    uid: 'super_admin_001',
                    username: 'SuperAdmin',
                    email: 'admin@hustlecastle.com',
                    password: 'admin123',
                    clan: 'Nessuno',
                    role: USER_ROLES.SUPERUSER,
                    createdAt: Date.now()
                };
                
                // Moderatore clan di esempio
                const clanMod = {
                    uid: 'clan_mod_001',
                    username: 'ModeratoreDraghi',
                    email: 'mod@draghi.com',
                    password: 'mod123',
                    clan: 'Draghi Rossi',
                    role: USER_ROLES.CLAN_MOD,
                    createdAt: Date.now()
                };
                
                // Utente normale di esempio
                const normalUser = {
                    uid: 'user_001',
                    username: 'GiocatoreLeoni',
                    email: 'player@leoni.com',
                    password: 'player123',
                    clan: 'Leoni Neri',
                    role: USER_ROLES.USER,
                    createdAt: Date.now()
                };
                
                users['admin@hustlecastle.com'] = defaultSuperUser;
                users['mod@draghi.com'] = clanMod;
                users['player@leoni.com'] = normalUser;
                
                localStorage.setItem('hc_local_users', JSON.stringify(users));
                
                console.log('üîß Utenti di esempio creati:', {
                    superuser: { email: 'admin@hustlecastle.com', password: 'admin123' },
                    clanMod: { email: 'mod@draghi.com', password: 'mod123' },
                    user: { email: 'player@leoni.com', password: 'player123' }
                });
            }
            
            // Aggiungi thread di esempio per sezioni generali se non esistono
            const sections = ['eventi', 'oggetti', 'novita'];
            sections.forEach(section => {
                const threads = JSON.parse(localStorage.getItem(`hc_threads_${section}`) || '[]');
                if (threads.length === 0) {
                    const exampleThreads = getExampleThreads(section);
                    localStorage.setItem(`hc_threads_${section}`, JSON.stringify(exampleThreads));
                }
            });

            // Aggiungi messaggi di esempio per chat generale se non esistono
            const messages = JSON.parse(localStorage.getItem(`hc_messages_chat-generale`) || '[]');
            if (messages.length === 0) {
                const exampleMessages = getExampleMessages('chat-generale');
                localStorage.setItem(`hc_messages_chat-generale`, JSON.stringify(exampleMessages));
            }

            // Inizializza dati di esempio per clan specifici
            const exampleClans = ['Draghi Rossi', 'Leoni Neri', 'Aquile Bianche'];
            exampleClans.forEach(clan => {
                const safeClanName = clan.replace(/[.#$[\]]/g, '_');
                
                // Thread clan (alcuni pending per testare moderazione)
                const clanSections = ['clan-war', 'clan-premi', 'clan-consigli', 'clan-bacheca'];
                clanSections.forEach(section => {
                    const storageKey = `hc_threads_clan_${safeClanName}_${section}`;
                    const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    if (threads.length === 0) {
                        const exampleThreads = getExampleClanThreads(section, clan);
                        localStorage.setItem(storageKey, JSON.stringify(exampleThreads));
                    }
                });

                // Messaggi clan chat
                const chatStorageKey = `hc_messages_clan_${safeClanName}_clan-chat`;
                const chatMessages = JSON.parse(localStorage.getItem(chatStorageKey) || '[]');
                if (chatMessages.length === 0) {
                    const exampleMessages = getExampleClanMessages(clan);
                    localStorage.setItem(chatStorageKey, JSON.stringify(exampleMessages));
                }
            });
        }

        function getExampleThreads(section) {
            const examples = {
                'eventi': [   
                ],
                'novita': [
                ]
            };
            return examples[section] || [];
        }

        function getExampleClanThreads(section, clanName) {
            const examples = {
                'clan-war': [
                ],
                'clan-premi': [
                   
                ],
                'clan-consigli': [
                
                ],
				'clan-bacheca': [
                
                ]
            };
            return examples[section] || [];
        }

        function getExampleMessages(section) {
            const examples = {
                'chat-generale': [
                   
                ]
            };
            return examples[section] || [];
        }

        function getExampleClanMessages(clanName) {
            return [
                {
                    id: 'cmsg1',
                    author: `Leader${clanName.replace(' ', '')}`,
                    message: `Benvenuti nel clan ${clanName}! Preparatevi per la guerra di domani!`,
                    timestamp: Date.now() - 15*60*1000
                },
                {
                    id: 'cmsg2',
                    author: 'WarriorClan',
                    message: 'Le mie truppe sono pronte! ‚öîÔ∏è',
                    timestamp: Date.now() - 10*60*1000
                },
                {
                    id: 'cmsg3',
                    author: 'DefenderMaster',
                    message: 'Chi ha bisogno di aiuto per il setup delle difese?',
                    timestamp: Date.now() - 5*60*1000
                }
            ];
        }

        // Gestione messaggi errore
        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'Email non valida';
                case 'auth/user-disabled':
                    return 'Account disabilitato';
                case 'auth/user-not-found':
                    return 'Utente non trovato';
                case 'auth/wrong-password':
                    return 'Password errata';
                case 'auth/email-already-in-use':
                    return 'Email gi√† in uso';
                case 'auth/weak-password':
                    return 'Password troppo debole';
                case 'auth/popup-closed-by-user':
                    return 'Login annullato dall\'utente';
                case 'auth/popup-blocked':
                    return 'Popup bloccato dal browser. Abilita i popup per questo sito.';
                case 'auth/cancelled-popup-request':
                    return 'Popup di login cancellato';
                case 'auth/network-request-failed':
                    return 'Errore di connessione. Controlla la tua connessione internet.';
                default:
                    return error.message || 'Errore sconosciuto';
            }
        }

        // Utility UI
        function showError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('loginSuccess');
            successEl.textContent = message;
            successEl.classList.add('show');
            setTimeout(() => successEl.classList.remove('show'), 3000);
        }

        function hideError() {
            document.getElementById('loginError').classList.remove('show');
        }

        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            loadingEl.classList.toggle('show', show);
        }

        // Gestione sezioni
        function switchSection(sectionKey) {
            const section = sectionConfig[sectionKey];
            if (!section) return;

            // Controlla accesso alla sezione
            if (!canAccessSection(sectionKey)) {
                if (sectionKey.startsWith('clan-')) {
                    if (sectionKey === 'clan-moderation' && !isClanModerator()) {
                        alert('Solo i moderatori del clan possono accedere a questa sezione!');
                    } else {
                        alert('Devi appartenere a un clan per accedere a questa sezione!');
                    }
                } else if (sectionKey.startsWith('admin-')) {
                    alert('Non hai i permessi per accedere a questa sezione!');
                }
                return;
            }

            // Pulisci listeners precedenti
            cleanupListeners();

            currentSection = sectionKey;

            // Aggiorna header
            document.getElementById('section-title').textContent = section.title;
            document.getElementById('section-description').textContent = section.description;

            // Mostra contenuto appropriato
            const forumContent = document.getElementById('forum-content');
            const chatContent = document.getElementById('chat-content');
            const threadView = document.getElementById('thread-view');
            const newThreadBtn = document.getElementById('new-thread-btn');

            // Nascondi tutto inizialmente
            forumContent.style.display = 'none';
            chatContent.style.display = 'none';
            threadView.style.display = 'none';
            newThreadBtn.style.display = 'none';

            if (section.type === 'forum') {
                forumContent.style.display = 'block';
                newThreadBtn.style.display = 'block';
                loadThreads(sectionKey);
            } else if (section.type === 'chat') {
                chatContent.style.display = 'flex';
                loadMessages(sectionKey);
            } else if (section.type === 'admin') {
                forumContent.style.display = 'block';
                loadAdminContent(sectionKey);
            } else if (section.type === 'clan-admin') {
                forumContent.style.display = 'block';
                loadClanModerationContent();
            } else if (section.type === 'dashboard') {
                forumContent.style.display = 'block';
                loadDashboard();
            }

            // Chiudi menu mobile se aperto
            closeMobileMenu();

            // Aggiorna navigazione
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionKey}"]`).classList.add('active');
        }

        // Funzioni per gestione mobile
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            if (sidebar.classList.contains('open')) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        function openMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.add('open');
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Carica dashboard
        function loadDashboard() {
            const threadList = document.getElementById('thread-list');
            
            // Se l'utente non √® ancora loggato, mostra messaggio di caricamento
            if (!currentUser) {
                threadList.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #666;">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚è≥</div>
                        <h2 style="color: #8B4513; margin-bottom: 10px;">Caricamento Dashboard...</h2>
                        <p>Preparazione della tua area personale</p>
                    </div>
                `;
                return;
            }
            
            const userName = currentUser.displayName || 'Guerriero';
            const userClan = getCurrentUserClan();
            const userRole = getCurrentUserRole();
            
            let welcomeMessage = '';
            const currentHour = new Date().getHours();
            if (currentHour < 12) {
                welcomeMessage = 'üåÖ Buongiorno';
            } else if (currentHour < 18) {
                welcomeMessage = '‚òÄÔ∏è Buon pomeriggio';
            } else {
                welcomeMessage = 'üåô Buonasera';
            }

            let roleDisplay = '';
            switch (userRole) {
                case USER_ROLES.SUPERUSER:
                    roleDisplay = '<span class="user-role role-superuser">üëë SUPER ADMIN</span>';
                    break;
                case USER_ROLES.CLAN_MOD:
                    roleDisplay = '<span class="user-role role-moderator">üõ°Ô∏è MODERATORE</span>';
                    break;
                default:
                    roleDisplay = '<span class="user-role role-user">‚öîÔ∏è GUERRIERO</span>';
            }

            threadList.innerHTML = `
                <div style="display: grid; gap: 25px;">
                    <!-- Welcome Section -->
                    <div style="background: linear-gradient(135deg, rgba(218, 165, 32, 0.1) 0%, rgba(244, 164, 96, 0.1) 100%); border-radius: 15px; padding: 25px; border: 2px solid rgba(218, 165, 32, 0.3); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -20px; right: -20px; font-size: 80px; opacity: 0.1;">üè∞</div>
                        <h2 style="color: #8B4513; margin-bottom: 15px; font-size: 28px;">
                            ${welcomeMessage}, ${userName}! ${roleDisplay}
                        </h2>
                        <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 15px;">
                            Benvenuto nel forum ufficiale di Hustle Castle! Qui puoi discutere strategie, 
                            condividere esperienze e rimanere aggiornato sugli ultimi eventi del gioco.
                        </p>
                        ${userClan !== 'Nessuno' ? `
                            <div style="background: rgba(52, 152, 219, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #3498db;">
                                <strong style="color: #3498db;">üè∞ Clan: ${userClan}</strong>
                                <p style="color: #666; font-size: 14px; margin-top: 5px;">Accedi alle sezioni dedicate del tuo clan dal menu laterale</p>
                            </div>
                        ` : `
                            <div style="background: rgba(255, 193, 7, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <strong style="color: #e68900;">‚ö†Ô∏è Non hai un clan</strong>
                                <p style="color: #666; font-size: 14px; margin-top: 5px;">Unisciti a un clan per accedere a funzionalit√† esclusive!</p>
                            </div>
                        `}
                    </div>

                    <!-- Quick Navigation -->
                    <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                        <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>üß≠</span> Navigazione Rapida
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="dashboard-card" onclick="switchSection('eventi')" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">üìÖ</div>
                                <h4 style="margin-bottom: 8px;">Eventi</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Scopri eventi in corso</p>
                            </div>
                            <div class="dashboard-card" onclick="switchSection('oggetti')" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">‚öîÔ∏è</div>
                                <h4 style="margin-bottom: 8px;">Oggetti</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Guide su armi e armature</p>
                            </div>
                            <div class="dashboard-card" onclick="switchSection('novita')" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">üÜï</div>
                                <h4 style="margin-bottom: 8px;">Novit√†</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Ultimi aggiornamenti</p>
                            </div>
                            <div class="dashboard-card" onclick="switchSection('chat-generale')" style="background: linear-gradient(135deg, #27ae60, #229954); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">üí¨</div>
                                <h4 style="margin-bottom: 8px;">Chat</h4>
                                <p style="font-size: 12px; opacity: 0.9;">Chiacchiera con la community</p>
                            </div>
                        </div>
                    </div>

                    <!-- Stats and Tips Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Forum Stats -->
                        <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                            <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <span>üìä</span> Statistiche Forum
                            </h3>
                            <div style="display: grid; gap: 15px;">
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(218, 165, 32, 0.1); border-radius: 8px;">
                                    <span style="color: #666;">üìù Thread Totali</span>
                                    <strong style="color: #8B4513;">${getForumStats().totalThreads}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(218, 165, 32, 0.1); border-radius: 8px;">
                                    <span style="color: #666;">üí¨ Messaggi Chat</span>
                                    <strong style="color: #8B4513;">${getForumStats().totalMessages}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(218, 165, 32, 0.1); border-radius: 8px;">
                                    <span style="color: #666;">üë• Utenti Registrati</span>
                                    <strong style="color: #8B4513;">${getForumStats().totalUsers}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(218, 165, 32, 0.1); border-radius: 8px;">
                                    <span style="color: #666;">üè∞ Clan Attivi</span>
                                    <strong style="color: #8B4513;">${getForumStats().totalClans}</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Tips -->
                        <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                            <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <span>üí°</span> Suggerimenti Rapidi
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="padding: 12px; background: rgba(46, 204, 113, 0.1); border-radius: 8px; border-left: 4px solid #2ecc71;">
                                    <strong style="color: #27ae60; font-size: 14px;">üéØ Partecipa alle Discussioni</strong>
                                    <p style="color: #666; font-size: 12px; margin-top: 4px;">Condividi le tue strategie nella sezione Eventi</p>
                                </div>
                                <div style="padding: 12px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; border-left: 4px solid #3498db;">
                                    <strong style="color: #2980b9; font-size: 14px;">üè∞ Unisciti a un Clan</strong>
                                    <p style="color: #666; font-size: 12px; margin-top: 4px;">Accedi a chat e funzionalit√† esclusive</p>
                                </div>
                                <div style="padding: 12px; background: rgba(155, 89, 182, 0.1); border-radius: 8px; border-left: 4px solid #9b59b6;">
                                    <strong style="color: #8e44ad; font-size: 14px;">‚öîÔ∏è Condividi Equipaggiamenti</strong>
                                    <p style="color: #666; font-size: 12px; margin-top: 4px;">Mostra le tue armi leggendarie!</p>
                                </div>
                                <div style="padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 8px; border-left: 4px solid #e67e22;">
                                    <strong style="color: #d68910; font-size: 14px;">üì¢ Rimani Aggiornato</strong>
                                    <p style="color: #666; font-size: 12px; margin-top: 4px;">Controlla regolarmente le Novit√†</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions & Tips -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Quick Actions -->
                        <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                            <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <span>‚ö°</span> Azioni Rapide
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <button onclick="switchSection('eventi')" class="quick-action-btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">üìÖ</span>
                                    <span>Controlla Eventi Attuali</span>
                                </button>
                                <button onclick="switchSection('chat-generale')" class="quick-action-btn" style="background: linear-gradient(135deg, #27ae60, #229954); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">üí¨</span>
                                    <span>Inizia una Conversazione</span>
                                </button>
                                <button onclick="showThreadCreationModal()" class="quick-action-btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">‚úçÔ∏è</span>
                                    <span>Crea Nuovo Thread</span>
                                </button>
                                ${userClan !== 'Nessuno' ? `
                                    <button onclick="switchSection('clan-chat')" class="quick-action-btn" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 20px;">üè∞</span>
                                        <span>Chat del Clan</span>
                                    </button>
                                ` : `
                                    <button onclick="alert('Unisciti a un clan per accedere a questa funzionalit√†!')" class="quick-action-btn" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px; opacity: 0.6;">
                                        <span style="font-size: 20px;">üîí</span>
                                        <span>Chat del Clan (Locked)</span>
                                    </button>
                                `}
                            </div>
                        </div>

                        <!-- Daily Tips -->
                        <div style="background: rgba(255, 255, 255, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(218, 165, 32, 0.3);">
                            <h3 style="color: #8B4513; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <span>üéØ</span> Consiglio del Giorno
                            </h3>
                            <div id="daily-tip" style="padding: 20px; background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1)); border-radius: 10px; border-left: 4px solid #3498db;">
                                <!-- Il consiglio verr√† inserito qui -->
                            </div>
                            <div style="margin-top: 15px; text-align: center;">
                                <button onclick="loadDailyTip()" style="background: rgba(52, 152, 219, 0.1); border: 1px solid #3498db; color: #3498db; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s ease;">
                                    üîÑ Nuovo Consiglio
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Community Highlights -->
                    <div style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(39, 174, 96, 0.1)); border-radius: 15px; padding: 25px; border: 2px solid #27ae60;">
                        <h3 style="color: #27ae60; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>üåü</span> In Evidenza nella Community
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid rgba(39, 174, 96, 0.3);">
                                <div style="font-size: 48px; margin-bottom: 10px;">üî•</div>
                                <h4 style="color: #27ae60; margin-bottom: 8px;">Thread Pi√π Visto</h4>
                                <p style="font-size: 12px; color: #666;">Guide alle Gemme Leggendarie</p>
                                <p style="font-size: 11px; color: #999;">445 visualizzazioni</p>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid rgba(39, 174, 96, 0.3);">
                                <div style="font-size: 48px; margin-bottom: 10px;">üëë</div>
                                <h4 style="color: #27ae60; margin-bottom: 8px;">Utente del Mese</h4>
                                <p style="font-size: 12px; color: #666;">ProPlayer123</p>
                                <p style="font-size: 11px; color: #999;">67 contributi</p>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; border: 1px solid rgba(39, 174, 96, 0.3);">
                                <div style="font-size: 48px; margin-bottom: 10px;">üèÜ</div>
                                <h4 style="color: #27ae60; margin-bottom: 8px;">Clan Pi√π Attivo</h4>
                                <p style="font-size: 12px; color: #666;">Draghi Rossi</p>
                                <p style="font-size: 11px; color: #999;">25 membri attivi</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Aggiungi stili hover per le dashboard cards
            const style = document.createElement('style');
            style.textContent = `
                .dashboard-card:hover {
                    transform: translateY(-5px) scale(1.02);
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                }
            `;
            document.head.appendChild(style);

            // Carica consigli del giorno dopo un breve delay
            setTimeout(loadDailyTip, 300);
        }

        // Ottieni statistiche del forum
        function getForumStats() {
            let totalThreads = 0;
            let totalMessages = 0;
            let totalUsers = 0;
            let totalClans = 0;

            try {
                if (window.useFirebase) {
                    // In modalit√† Firebase, restituisci valori placeholder
                    return {
                        totalThreads: '50+',
                        totalMessages: '200+', 
                        totalUsers: '15+',
                        totalClans: '5+'
                    };
                } else {
                    // Modalit√† locale - conta i dati reali
                    const sections = ['eventi', 'oggetti', 'novita'];
                    sections.forEach(section => {
                        const threads = JSON.parse(localStorage.getItem(`hc_threads_${section}`) || '[]');
                        totalThreads += threads.length;
                    });

                    const messages = JSON.parse(localStorage.getItem(`hc_messages_chat-generale`) || '[]');
                    totalMessages += messages.length;

                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    totalUsers = Object.keys(users).length;

                    const clanSet = new Set();
                    Object.values(users).forEach(user => {
                        if (user.clan && user.clan !== 'Nessuno') {
                            clanSet.add(user.clan);
                        }
                    });
                    totalClans = clanSet.size;
                }
            } catch (error) {
                console.error('Errore calcolo statistiche:', error);
            }

            return {
                totalThreads: totalThreads || 0,
                totalMessages: totalMessages || 0,
                totalUsers: totalUsers || 0,
                totalClans: totalClans || 0
            };
        }

        // Carica consiglio del giorno
        function loadDailyTip() {
            const tipContainer = document.getElementById('daily-tip');
            if (!tipContainer) return;

            const tips = [
                {
                    icon: '‚öîÔ∏è',
                    title: 'Strategia di Combattimento',
                    content: 'Bilancia sempre la tua formazione: un tank robusto, DPS equilibrati e un supporto possono fare la differenza in arena!'
                },
                {
                    icon: 'üè∞',
                    title: 'Gestione del Castello',
                    content: 'Aggiorna sempre la sala del trono prima di potenziare altre stanze per massimizzare l\'efficienza delle risorse.'
                },
                {
                    icon: 'üíé',
                    title: 'Gemme e Equipaggiamento',
                    content: 'Non vendere mai le gemme leggendarie! Anche se sembrano deboli ora, potrebbero essere utili per upgrade futuri.'
                },
                {
                    icon: 'üéØ',
                    title: 'Eventi Speciali',
                    content: 'Partecipa sempre agli eventi temporanei: spesso offrono ricompense uniche che non puoi ottenere altrove!'
                },
                {
                    icon: 'üë•',
                    title: 'Vita di Clan',
                    content: 'Coordina sempre con il tuo clan prima delle guerre. La comunicazione √® la chiave per la vittoria!'
                },
                {
                    icon: 'üìà',
                    title: 'Progressione Intelligente',
                    content: 'Non avere fretta di salire di Throne Room. Assicurati di avere equipaggiamento e truppe adeguate al tuo livello.'
                },
                {
                    icon: 'üõ°Ô∏è',
                    title: 'Difesa del Castello',
                    content: 'Posiziona strategicamente le tue difese: mescola danni fisici e magici per contrastare diversi tipi di attacco.'
                },
                {
                    icon: '‚è∞',
                    title: 'Gestione del Tempo',
                    content: 'Ottimizza i tempi di training: inizia sempre con le truppe che richiedono pi√π tempo prima di andare offline.'
                },
                {
                    icon: 'üèÜ',
                    title: 'Arena e PvP',
                    content: 'Studia sempre gli avversari prima di attaccare. Una strategia ben pianificata vale pi√π della forza bruta!'
                },
                {
                    icon: 'üí∞',
                    title: 'Economia del Gioco',
                    content: 'Investi le gemme saggiamente: priorit√† a slot di barracks, mastro e velocizzazione di upgrade critici.'
                }
            ];

            // Seleziona un consiglio basato sul giorno corrente per consistenza
            const today = new Date().getDate();
            const selectedTip = tips[today % tips.length];

            tipContainer.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="font-size: 32px; flex-shrink: 0;">${selectedTip.icon}</div>
                    <div>
                        <h4 style="color: #3498db; margin: 0 0 8px 0; font-size: 16px;">${selectedTip.title}</h4>
                        <p style="color: #666; margin: 0; line-height: 1.5; font-size: 14px;">${selectedTip.content}</p>
                    </div>
                </div>
            `;
        }

        // Rendi la funzione globale
        window.loadDailyTip = loadDailyTip;

        // Carica contenuto amministrativo
        function loadAdminContent(sectionKey) {
            const threadList = document.getElementById('thread-list');
            
            switch (sectionKey) {
                case 'admin-users':
                    loadUsersManagement();
                    break;
                case 'admin-clans':
                    loadClansManagement();
                    break;
                default:
                    threadList.innerHTML = '<div style="text-align: center; padding: 40px;">Sezione non trovata</div>';
            }
        }

        // Carica contenuto moderazione clan
        function loadClanModerationContent() {
            const threadList = document.getElementById('thread-list');
            
            threadList.innerHTML = `
                <div class="admin-panel">
                    <h3>üõ°Ô∏è Moderazione Clan ${getCurrentUserClan()}</h3>
                    <div id="moderation-content">
                        <div style="text-align: center; padding: 20px;">
                            <div>üîÑ Caricamento contenuti da moderare...</div>
                        </div>
                    </div>
                </div>
            `;

            loadPendingThreads();
        }

        // Carica thread in attesa di approvazione
        async function loadPendingThreads() {
            const moderationContent = document.getElementById('moderation-content');
            
            try {
                const userClan = getCurrentUserClan();
                const pendingThreads = await getPendingThreadsForClan(userClan);
                
                if (pendingThreads.length === 0) {
                    moderationContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            ‚úÖ Nessun contenuto in attesa di approvazione
                        </div>
                    `;
                    return;
                }

                moderationContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>üìã Thread in attesa di approvazione (${pendingThreads.length})</h4>
                    </div>
                    ${pendingThreads.map(thread => `
                        <div class="thread-item thread-pending" style="margin-bottom: 15px;">
                            <div class="thread-main">
                                <div class="thread-title">
                                    ${thread.title}
                                    <span class="pending-indicator">PENDING</span>
                                </div>
                                <div class="thread-author">
                                    da ${thread.author} ‚Ä¢ ${formatTime(thread.createdAt)}
                                </div>
                                <div class="moderation-actions">
                                    <button class="approve-btn" onclick="approveThread('${thread.id}', '${thread.section}')">
                                        ‚úÖ Approva
                                    </button>
                                    <button class="reject-btn" onclick="rejectThread('${thread.id}', '${thread.section}')">
                                        ‚ùå Rifiuta
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                console.error('Errore caricamento thread pending:', error);
                moderationContent.innerHTML = `
                    <div style="text-align: center; color: red;">
                        Errore nel caricamento dei contenuti da moderare
                    </div>
                `;
            }
        }

        // Ottieni thread in attesa per un clan
        async function getPendingThreadsForClan(clanName) {
            const pendingThreads = [];
            const clanSections = ['clan-war', 'clan-premi', 'clan-consigli', 'clan-bacheca'];
            
            for (const section of clanSections) {
                try {
                    const dataPath = getDataPath(section, 'threads');
                    if (!dataPath) continue;
                    
                    let threads = [];
                    
                    if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                        const threadsRef = ref(window.firebaseDatabase, dataPath);
                        const snapshot = await get(threadsRef);
                        
                        if (snapshot.exists()) {
                            snapshot.forEach((childSnapshot) => {
                                const threadData = childSnapshot.val();
                                if (threadData.status === 'pending') {
                                    threads.push({
                                        id: childSnapshot.key,
                                        section: section,
                                        ...threadData
                                    });
                                }
                            });
                        }
                    } else {
                        // Modalit√† locale
                        const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                        const localThreads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                        threads = localThreads.filter(t => t.status === 'pending').map(t => ({
                            ...t,
                            section: section
                        }));
                    }
                    
                    pendingThreads.push(...threads);
                } catch (error) {
                    console.error(`Errore caricamento thread pending per ${section}:`, error);
                }
            }
            
            // Ordina per data (pi√π recenti prima)
            return pendingThreads.sort((a, b) => b.createdAt - a.createdAt);
        }

        // Approva thread
        async function approveThread(threadId, section) {
            try {
                await updateThreadStatus(threadId, section, 'approved');
                alert('Thread approvato con successo!');
                loadPendingThreads(); // Ricarica lista
            } catch (error) {
                console.error('Errore approvazione thread:', error);
                alert('Errore nell\'approvazione del thread');
            }
        }

        // Rifiuta thread
        async function rejectThread(threadId, section) {
            const reason = prompt('Motivo del rifiuto (opzionale):');
            
            try {
                await updateThreadStatus(threadId, section, 'rejected', reason);
                alert('Thread rifiutato');
                loadPendingThreads(); // Ricarica lista
            } catch (error) {
                console.error('Errore rifiuto thread:', error);
                alert('Errore nel rifiuto del thread');
            }
        }

        // Aggiorna status thread
        async function updateThreadStatus(threadId, section, status, reason = null) {
			const dataPath = getDataPath(section, 'threads');
			if (!dataPath) return;

			const updateData = {
				status: status,
				moderatedAt: window.useFirebase ? serverTimestamp() : Date.now(),
				moderatedBy: currentUser.displayName || 'Moderatore'
			};

			if (reason) {
				updateData.rejectionReason = reason;
			}

			if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
				// leggi i dati esistenti del thread
				const threadRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
				const snapshot = await get(threadRef);
				if (snapshot.exists()) {
					const existingData = snapshot.val();
					// mantieni tutti i campi, aggiungendo/modificando solo quelli di moderazione
					const updatedThread = { ...existingData, ...updateData };
					await set(threadRef, updatedThread);
				} else {
					console.warn(`Thread con id ${threadId} non trovato in ${dataPath}`);
				}
			} else {
				// modalit√† locale
				const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
				const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
				const threadIndex = threads.findIndex(t => t.id === threadId);
				if (threadIndex !== -1) {
					threads[threadIndex] = { ...threads[threadIndex], ...updateData };
					localStorage.setItem(storageKey, JSON.stringify(threads));
				}
			}
		}


        // Carica gestione utenti
        async function loadUsersManagement() {
            const threadList = document.getElementById('thread-list');
            
            threadList.innerHTML = `
                <div class="admin-panel">
                    <h3>üë• Gestione Utenti</h3>
                    <div id="users-grid" class="users-grid">
                        <div style="text-align: center; padding: 20px;">
                            <div>üîÑ Caricamento utenti...</div>
                        </div>
                    </div>
                </div>
            `;

            // Carica lista utenti
            loadUsersList();
        }

        // Carica lista utenti
        async function loadUsersList() {
            const usersGrid = document.getElementById('users-grid');
            
            try {
                let users = [];
                
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    // Carica da Firebase
                    const usersRef = ref(window.firebaseDatabase, 'users');
                    const snapshot = await get(usersRef);
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            users.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                    }
                } else {
                    // Carica da localStorage
                    const localUsers = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    users = Object.values(localUsers);
                }

                displayUsersList(users);
            } catch (error) {
                console.error('Errore caricamento utenti:', error);
                usersGrid.innerHTML = '<div style="text-align: center; color: red;">Errore nel caricamento degli utenti</div>';
            }
        }

        // Visualizza lista utenti
        function displayUsersList(users) {
            const usersGrid = document.getElementById('users-grid');
            
            if (users.length === 0) {
                usersGrid.innerHTML = '<div style="text-align: center; padding: 20px;">Nessun utente trovato</div>';
                return;
            }

            usersGrid.innerHTML = users.map(user => {
                const roleText = user.role === 'superuser' ? 'SUPER' : 
                                user.role === 'clan_mod' ? 'CLAN MOD' : 'USER';
                const roleClass = user.role === 'superuser' ? 'role-superuser' : 
                                 user.role === 'clan_mod' ? 'role-moderator' : 'role-user';
                
                return `
                    <div class="user-card">
                        <div class="user-card-header">
                            <div class="user-card-name">
                                ${user.username} 
                                <span class="user-role ${roleClass}">
                                    ${roleText}
                                </span>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ${formatTime(user.createdAt)}
                            </div>
                        </div>
                        <div class="user-card-info">
                            <div>üìß ${user.email}</div>
                            <div>üè∞ Clan: ${user.clan || 'Nessuno'}</div>
                            <div>üîó Provider: ${user.provider || 'email'}</div>
                        </div>
                        <div class="user-card-actions">
                            <button class="admin-btn btn-assign-clan" onclick="assignClan('${user.id || user.uid}', '${user.username}')">
                                Assegna Clan
                            </button>
                            ${getCurrentUserRole() === USER_ROLES.SUPERUSER ? `
                                <button class="admin-btn btn-change-role" onclick="changeUserRole('${user.id || user.uid}', '${user.username}', '${user.role || 'user'}')">
                                    Cambia Ruolo
                                </button>
                            ` : ''}
                            ${user.clan && user.clan !== 'Nessuno' ? `
                                <button class="admin-btn btn-remove-clan" onclick="removFromClan('${user.id || user.uid}', '${user.username}')">
                                    Rimuovi Clan
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Funzioni amministrative
        async function assignClan(userId, username) {
            const availableClans = await getAvailableClans();
            const clanList = availableClans.length > 0 ? availableClans.join('\n') : 'Nessun clan disponibile';
            
            const clanName = prompt(`Assegna un clan a ${username}:\n\nClan disponibili:\n${clanList}\n\nInserisci il nome del clan:`);
            if (!clanName || clanName.trim() === '') return;
            
            try {
                await updateUserClan(userId, clanName.trim());
                alert(`${username} √® stato assegnato al clan "${clanName}"`);
                loadUsersList(); // Ricarica lista
            } catch (error) {
                console.error('Errore assegnazione clan:', error);
                alert('Errore nell\'assegnazione del clan');
            }
        }

        async function changeUserRole(userId, username, currentRole) {
            if (getCurrentUserRole() !== USER_ROLES.SUPERUSER) {
                alert('Solo i superuser possono modificare i ruoli');
                return;
            }
            
            const newRole = prompt(`Cambia il ruolo di ${username}:\n\nRuolo attuale: ${currentRole}\n\nOpzioni:\n- user (utente normale)\n- clan_mod (moderatore di clan)\n- superuser (super amministratore)\n\nInserisci il nuovo ruolo:`);
            
            if (!newRole || !Object.values(USER_ROLES).includes(newRole)) {
                alert('Ruolo non valido');
                return;
            }
            
            try {
                await updateUserRole(userId, newRole);
                alert(`Ruolo di ${username} cambiato in "${newRole}"`);
                loadUsersList(); // Ricarica lista
            } catch (error) {
                console.error('Errore cambio ruolo:', error);
                alert('Errore nel cambio del ruolo');
            }
        }

        async function removFromClan(userId, username) {
            if (confirm(`Rimuovere ${username} dal clan?`)) {
                try {
                    await updateUserClan(userId, 'Nessuno');
                    alert(`${username} √® stato rimosso dal clan`);
                    loadUsersList(); // Ricarica lista
                } catch (error) {
                    console.error('Errore rimozione clan:', error);
                    alert('Errore nella rimozione dal clan');
                }
            }
        }

        // Funzioni di aggiornamento database
        async function updateUserClan(userId, clanName) {
            if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                const userRef = ref(window.firebaseDatabase, `users/${userId}/clan`);
                await set(userRef, clanName);
            } else {
                // Aggiorna localStorage
                const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                for (const email in users) {
                    if (users[email].uid === userId) {
                        users[email].clan = clanName;
                        localStorage.setItem('hc_local_users', JSON.stringify(users));
                        break;
                    }
                }
            }
        }

        async function updateUserRole(userId, newRole) {
            if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                const userRef = ref(window.firebaseDatabase, `users/${userId}/role`);
                await set(userRef, newRole);
            } else {
                // Aggiorna localStorage
                const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                for (const email in users) {
                    if (users[email].uid === userId) {
                        users[email].role = newRole;
                        localStorage.setItem('hc_local_users', JSON.stringify(users));
                        break;
                    }
                }
            }
        }

        // Gestione clan
        async function loadClansManagement() {
            const threadList = document.getElementById('thread-list');
            
            threadList.innerHTML = `
                <div class="clan-management">
                    <h3>üè∞ Gestione Clan</h3>
                    <button class="create-clan-btn" onclick="createNewClan()">
                        + Crea Nuovo Clan
                    </button>
                    <div id="clans-grid" class="clan-list">
                        <div style="text-align: center; padding: 20px;">
                            <div>üîÑ Caricamento clan...</div>
                        </div>
                    </div>
                </div>
            `;

            loadClansList();
        }

        async function loadClansList() {
            const clansGrid = document.getElementById('clans-grid');
            
            try {
                const clans = await getAvailableClans();
                const clanStats = await getClanStats(clans);
                
                if (clans.length === 0) {
                    clansGrid.innerHTML = '<div style="text-align: center; padding: 20px;">Nessun clan trovato</div>';
                    return;
                }

                clansGrid.innerHTML = clans.map(clan => `
                    <div class="clan-card">
                        <h4>${clan}</h4>
                        <div class="clan-members">
                            üë• ${clanStats[clan] || 0} membri
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="admin-btn btn-remove-clan" onclick="deleteClan('${clan}')">
                                Elimina Clan
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Errore caricamento clan:', error);
                clansGrid.innerHTML = '<div style="text-align: center; color: red;">Errore nel caricamento dei clan</div>';
            }
        }

        async function getAvailableClans() {
            let clans = [];
            
            if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                const usersRef = ref(window.firebaseDatabase, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const clanSet = new Set();
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        if (userData.clan && userData.clan !== 'Nessuno') {
                            clanSet.add(userData.clan);
                        }
                    });
                    clans = Array.from(clanSet);
                }
            } else {
                const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                const clanSet = new Set();
                Object.values(users).forEach(user => {
                    if (user.clan && user.clan !== 'Nessuno') {
                        clanSet.add(user.clan);
                    }
                });
                clans = Array.from(clanSet);
            }
            
            return clans.sort();
        }

        async function getClanStats(clans) {
            const stats = {};
            
            if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                const usersRef = ref(window.firebaseDatabase, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    clans.forEach(clan => stats[clan] = 0);
                    
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        if (userData.clan && stats.hasOwnProperty(userData.clan)) {
                            stats[userData.clan]++;
                        }
                    });
                }
            } else {
                const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                clans.forEach(clan => stats[clan] = 0);
                
                Object.values(users).forEach(user => {
                    if (user.clan && stats.hasOwnProperty(user.clan)) {
                        stats[user.clan]++;
                    }
                });
            }
            
            return stats;
        }

        async function createNewClan() {
            const clanName = prompt('Nome del nuovo clan:');
            if (!clanName || clanName.trim() === '') return;
            
            const trimmedName = clanName.trim();
            const existingClans = await getAvailableClans();
            
            if (existingClans.includes(trimmedName)) {
                alert('Questo clan esiste gi√†!');
                return;
            }
            
            alert(`Clan "${trimmedName}" creato! Ora puoi assegnare utenti a questo clan.`);
            loadClansList();
        }

        async function deleteClan(clanName) {
            if (!confirm(`Sei sicuro di voler eliminare il clan "${clanName}"?\n\nTutti i membri verranno rimossi dal clan.`)) {
                return;
            }
            
            try {
                // Rimuovi tutti gli utenti dal clan
                if (window.useFirebase && window.firebaseDatabase && firebaseReady) {
                    const usersRef = ref(window.firebaseDatabase, 'users');
                    const snapshot = await get(usersRef);
                    
                    if (snapshot.exists()) {
                        const updates = {};
                        snapshot.forEach((childSnapshot) => {
                            const userData = childSnapshot.val();
                            if (userData.clan === clanName) {
                                updates[`users/${childSnapshot.key}/clan`] = 'Nessuno';
                            }
                        });
                        
                        await update(ref(window.firebaseDatabase), updates);
                    }
                } else {
                    const users = JSON.parse(localStorage.getItem('hc_local_users') || '{}');
                    Object.values(users).forEach(user => {
                        if (user.clan === clanName) {
                            user.clan = 'Nessuno';
                        }
                    });
                    localStorage.setItem('hc_local_users', JSON.stringify(users));
                }
                
                alert(`Clan "${clanName}" eliminato con successo`);
                loadClansList();
            } catch (error) {
                console.error('Errore eliminazione clan:', error);
                alert('Errore nell\'eliminazione del clan');
            }
        }

        // Genera il path corretto per messaggi/thread in base alla sezione e clan
        function getDataPath(sectionKey, dataType) {
            if (sectionKey.startsWith('clan-')) {
                const userClan = getCurrentUserClan();
                if (userClan === 'Nessuno') {
                    return null;
                }
                // Sostituisci caratteri speciali nel nome del clan per Firebase
                const safeClanName = userClan.replace(/[.#$[\]]/g, '_');
                return `${dataType}/clan/${safeClanName}/${sectionKey}`;
            } else {
                return `${dataType}/${sectionKey}`;
            }
        }

        // Carica thread
        function loadThreads(sectionKey) {
            const dataPath = getDataPath(sectionKey, 'threads');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && onValue && off) {
                const threadsRef = ref(window.firebaseDatabase, dataPath);
                
                // Cleanup previous listener
                if (threadListeners[sectionKey]) {
                    const oldRef = ref(window.firebaseDatabase, threadListeners[sectionKey].path);
                    off(oldRef, threadListeners[sectionKey].callback);
                }
                
                // Listen for changes
                const callback = (snapshot) => {
                    const threads = [];
                    snapshot.forEach((childSnapshot) => {
                        threads.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Ordina per data (pi√π recenti prima)
                    threads.sort((a, b) => b.createdAt - a.createdAt);
                    
                    displayThreads(threads);
                };

                threadListeners[sectionKey] = { path: dataPath, callback: callback };
                onValue(threadsRef, callback);
            } else {
                // Carica da localStorage (modalit√† locale)
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                threads.sort((a, b) => b.createdAt - a.createdAt);
                displayThreads(threads);
            }
        }

        // Mostra thread
        function displayThreads(threads) {
            const threadList = document.getElementById('thread-list');
            
            if (threads.length === 0) {
                threadList.innerHTML = `
                    <div class="forum-header">
                        <div>Discussione</div>
                        <div>Risposte</div>
                        <div>Visualizzazioni</div>
                        <div>Ultimo Messaggio</div>
                    </div>
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Nessun thread in questa sezione. Creane uno!
                    </div>
                `;
                return;
            }
            
            // Filtra thread approvati per utenti normali, mostra tutto per moderatori
            const visibleThreads = threads.filter(thread => {
                // Moderatori vedono tutto
                if (canModerateSection(currentSection)) {
                    return true;
                }
                // Utenti normali vedono solo thread approvati
                return !thread.status || thread.status === 'approved';
            });
            
            threadList.innerHTML = `
                <div class="forum-header">
                    <div>Discussione</div>
                    <div>Risposte</div>
                    <div>Visualizzazioni</div>
                    <div>Ultimo Messaggio</div>
                </div>
            ` + visibleThreads.map(thread => {
                const statusClass = thread.status === 'pending' ? 'thread-pending' : 
                                    thread.status === 'rejected' ? 'thread-rejected' : '';
                const statusIndicator = thread.status === 'pending' ? '<span class="pending-indicator">PENDING</span>' : 
                                        thread.status === 'rejected' ? '<span class="pending-indicator" style="background: rgba(231, 76, 60, 0.2); color: #e74c3c;">RIFIUTATO</span>' : '';
                
                return `
                    <div class="thread-item ${statusClass}">
                        <div class="thread-main">
                            <div class="thread-title" onclick="openThread('${thread.id}', '${currentSection}')">
                                ${thread.title}
                                ${statusIndicator}
                            </div>
                            <div class="thread-author">da ${thread.author}</div>
                            <div class="thread-stats-mobile">
                                <div class="stat">
                                    <span>üí¨</span>
                                    <span>${thread.replies || 0}</span>
                                </div>
                                <div class="stat">
                                    <span>üëÅÔ∏è</span>
                                    <span>${thread.views || 0}</span>
                                </div>
                                <div class="stat">
                                    <span>üïê</span>
                                    <span>${formatTime(thread.createdAt)}</span>
                                </div>
                            </div>
                            ${thread.status === 'pending' && canModerateSection(currentSection) ? `
                                <div class="moderation-actions">
                                    <button class="approve-btn" onclick="approveThread('${thread.id}', '${currentSection}')">
                                        ‚úÖ Approva
                                    </button>
                                    <button class="reject-btn" onclick="rejectThread('${thread.id}', '${currentSection}')">
                                        ‚ùå Rifiuta
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="thread-replies">${thread.replies || 0}</div>
                        <div class="thread-stats">${thread.views || 0}</div>
                        <div class="thread-last-post">
                            <div>${formatTime(thread.createdAt)}</div>
                            <div>da <strong>${thread.author}</strong></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mostra modal creazione thread
        function showThreadCreationModal() {
            if (!currentUser) {
                alert('Devi effettuare l\'accesso per creare thread');
                return;
            }

            // Controlla accesso clan
            if (currentSection.startsWith('clan-') && getCurrentUserClan() === 'Nessuno') {
                alert('Devi appartenere a un clan per creare thread qui!');
                return;
            }

            document.getElementById('threadCreationModal').style.display = 'flex';
            document.getElementById('thread-title-input').focus();
        }

        // Nascondi modal creazione thread
        function hideThreadCreationModal() {
            document.getElementById('threadCreationModal').style.display = 'none';
            document.getElementById('thread-title-input').value = '';
            document.getElementById('thread-content-input').value = '';
        }

        // Crea thread dalla modal
        async function createThread() {
            const title = document.getElementById('thread-title-input').value.trim();
            const content = document.getElementById('thread-content-input').value.trim();
            
            if (!title || !content) {
                alert('Inserisci sia il titolo che il contenuto del thread');
                return;
            }

            const createBtn = document.querySelector('.btn-create-thread');
            createBtn.disabled = true;
            createBtn.textContent = 'Creazione...';

            try {
                const threadData = {
                    title: title,
                    content: content,
                    author: currentUser.displayName || 'Utente',
                    authorId: currentUser.uid
                };

                // Determina se il thread ha bisogno di approvazione
                const needsApproval = currentSection.startsWith('clan-') && !canModerateSection(currentSection);
                
                if (needsApproval) {
                    threadData.status = 'pending';
                } else {
                    threadData.status = 'approved';
                }

                const dataPath = getDataPath(currentSection, 'threads');
                if (!dataPath) return;

                if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && push && serverTimestamp) {
                    // Salva su Firebase
                    const threadsRef = ref(window.firebaseDatabase, dataPath);
                    threadData.createdAt = serverTimestamp();
                    threadData.replies = 0;
                    threadData.views = 0;
                    await push(threadsRef, threadData);
                } else {
                    // Salva in locale
                    saveLocalThread(currentSection, threadData);
                }

                hideThreadCreationModal();
                
                if (needsApproval) {
                    alert('Thread creato! √à in attesa di approvazione da parte del moderatore del clan.');
                } else {
                    alert('Thread creato con successo!');
                }
            } catch (error) {
                console.error('Errore creazione thread:', error);
                alert('Errore nella creazione del thread');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Crea Thread';
            }
			  loadThreads(currentSection); 
			
        }
		
		async function handleGoogleLogin() {
    if (!window.useFirebase || !firebaseReady || !signInWithPopup || !window.googleProvider) {
        alert("‚ö†Ô∏è Login con Google non disponibile in modalit√† demo");
        return;
    }

    try {
        const result = await signInWithPopup(window.firebaseAuth, window.googleProvider);
        const user = result.user;

        console.log("üë§ Login Google OK:", user);

        // dopo login, salva (se nuovo utente)
        const userRef = ref(window.firebaseDatabase, `users/${user.uid}`);
        const snapshot = await get(userRef);

        if (!snapshot.exists()) {
            // chiedi extra info se vuoi, per esempio clan
            const username = user.displayName || prompt("Inserisci un username:");
            const clan = prompt("Inserisci il tuo clan (opzionale):") || "Nessuno";

            await set(userRef, {
                username: username,
                email: user.email,
                clan: clan,
                role: "user",
                createdAt: serverTimestamp(),
                lastSeen: serverTimestamp(),
                provider: "google"
            });
        }

        alert("‚úÖ Login con Google completato!");
        hideError();
        showSuccess("Login effettuato!");
    } catch (error) {
        console.error("Errore login con Google:", error);
        alert(error.message || "Errore login con Google");
    }
}


        // Apri thread per visualizzazione
        async function openThread(threadId, section) {
            if (!currentUser) {
                alert('Devi effettuare l\'accesso per visualizzare i thread');
                return;
            }

            try {
                // Trova il thread
                const thread = await getThread(threadId, section);
                if (!thread) {
                    alert('Thread non trovato');
                    return;
                }

                // Aggiorna visualizzazioni
                await incrementThreadViews(threadId, section);

                // Salva riferimenti
                currentThread = thread;
                currentThreadId = threadId;
                currentThreadSection = section;

                // Mostra vista thread
                document.getElementById('forum-content').style.display = 'none';
                document.getElementById('chat-content').style.display = 'none';
                document.getElementById('thread-view').style.display = 'flex';
                document.getElementById('new-thread-btn').style.display = 'none';

                // Popola dati thread
                document.getElementById('thread-title').textContent = thread.title;
                document.getElementById('thread-author').textContent = thread.author;
                document.getElementById('thread-date').textContent = formatTime(thread.createdAt);
                document.getElementById('thread-views').textContent = `${thread.views || 0} visualizzazioni`;
                document.getElementById('thread-content').textContent = thread.content || 'Nessun contenuto disponibile';

                // Carica commenti
                loadThreadComments(threadId, section);

                // Chiudi menu mobile se aperto
                closeMobileMenu();

            } catch (error) {
                console.error('Errore apertura thread:', error);
                alert('Errore nell\'apertura del thread');
            }
        }

        // Torna al forum
        function backToForum() {
            document.getElementById('thread-view').style.display = 'none';
            document.getElementById('forum-content').style.display = 'block';
            document.getElementById('new-thread-btn').style.display = 'block';
            
            // Pulisci dati thread
            currentThread = null;
            currentThreadId = null;
            currentThreadSection = null;
            
            // Ricarica contenuto se necessario
            if (currentSection && sectionConfig[currentSection]) {
                const section = sectionConfig[currentSection];
                if (section.type === 'forum') {
                    loadThreads(currentSection);
                } else if (section.type === 'dashboard') {
                    loadDashboard();
                }
            }
        }

        // Ottieni thread per ID
        async function getThread(threadId, section) {
            const dataPath = getDataPath(section, 'threads');
            if (!dataPath) return null;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && get) {
                const threadRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
                const snapshot = await get(threadRef);
                return snapshot.exists() ? { id: threadId, ...snapshot.val() } : null;
            } else {
                // Modalit√† locale
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                return threads.find(t => t.id === threadId) || null;
            }
        }

        // Incrementa visualizzazioni thread
        async function incrementThreadViews(threadId, section) {
            const dataPath = getDataPath(section, 'threads');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && update) {
                const threadRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
                await update(ref(window.firebaseDatabase), {
                    [`${dataPath}/${threadId}/views`]: (currentThread?.views || 0) + 1
                });
            } else {
                // Modalit√† locale
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const threadIndex = threads.findIndex(t => t.id === threadId);
                
                if (threadIndex !== -1) {
                    threads[threadIndex].views = (threads[threadIndex].views || 0) + 1;
                    localStorage.setItem(storageKey, JSON.stringify(threads));
                }
            }
        }

        // Carica commenti thread
        function loadThreadComments(threadId, section) {
            const dataPath = getDataPath(section, 'comments');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && onValue) {
                const commentsRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
                
                onValue(commentsRef, (snapshot) => {
                    const comments = [];
                    snapshot.forEach((childSnapshot) => {
                        comments.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Ordina per timestamp
                    comments.sort((a, b) => a.timestamp - b.timestamp);
                    
                    displayThreadComments(comments);
                });
            } else {
                // Modalit√† locale
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}_${threadId}`;
                const comments = JSON.parse(localStorage.getItem(storageKey) || '[]');
                comments.sort((a, b) => a.timestamp - b.timestamp);
                displayThreadComments(comments);
            }
        }

        // Mostra commenti thread
        function displayThreadComments(comments) {
            const commentsContainer = document.getElementById('thread-comments');
            
            if (comments.length === 0) {
                commentsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Nessun commento ancora. Sii il primo a commentare!
                    </div>
                `;
                return;
            }
            
            commentsContainer.innerHTML = comments.map(comment => `
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${formatTime(comment.timestamp)}</span>
                    </div>
                    <div class="comment-content">${escapeHtml(comment.content)}</div>
                </div>
            `).join('');
            
            // Scroll to bottom
            commentsContainer.scrollTop = commentsContainer.scrollHeight;
        }

        // Aggiungi commento
        async function addComment() {
            if (!currentUser) {
                alert('Devi effettuare l\'accesso per commentare');
                return;
            }

            const commentText = document.getElementById('comment-text').value.trim();
            if (!commentText) {
                alert('Scrivi un commento prima di inviare');
                return;
            }

            const commentBtn = document.querySelector('.comment-input button');
            commentBtn.disabled = true;
            commentBtn.textContent = 'Invio...';

            try {
                const commentData = {
                    author: currentUser.displayName || 'Utente',
                    authorId: currentUser.uid,
                    content: commentText,
                    threadId: currentThreadId
                };

                const dataPath = getDataPath(currentThreadSection, 'comments');
                if (!dataPath) return;

                if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && push && serverTimestamp) {
                    // Salva su Firebase
                    const commentsRef = ref(window.firebaseDatabase, `${dataPath}/${currentThreadId}`);
                    commentData.timestamp = serverTimestamp();
                    await push(commentsRef, commentData);
                    
                    // Aggiorna contatore risposte
                    await incrementThreadReplies(currentThreadId, currentThreadSection);
                } else {
                    // Salva in locale
                    saveLocalComment(currentThreadSection, currentThreadId, commentData);
                }

                // Pulisci input
                document.getElementById('comment-text').value = '';
                
            } catch (error) {
                console.error('Errore invio commento:', error);
                alert('Errore nell\'invio del commento');
            } finally {
                commentBtn.disabled = false;
                commentBtn.textContent = 'Commenta';
            }
        }

        // Salva commento locale
        function saveLocalComment(section, threadId, commentData) {
            const dataPath = getDataPath(section, 'comments');
            if (!dataPath) return;

            const storageKey = `hc_${dataPath.replace(/\//g, '_')}_${threadId}`;
            const comments = JSON.parse(localStorage.getItem(storageKey) || '[]');
            commentData.timestamp = Date.now();
            commentData.id = 'comment_' + Date.now();
            comments.push(commentData);
            localStorage.setItem(storageKey, JSON.stringify(comments));
            
            // Aggiorna contatore risposte
            incrementThreadReplies(threadId, section);
            
            // Ricarica commenti
            loadThreadComments(threadId, section);
        }

        // Incrementa risposte thread
        async function incrementThreadReplies(threadId, section) {
            const dataPath = getDataPath(section, 'threads');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && update) {
                const threadRef = ref(window.firebaseDatabase, `${dataPath}/${threadId}`);
                await update(ref(window.firebaseDatabase), {
                    [`${dataPath}/${threadId}/replies`]: (currentThread?.replies || 0) + 1
                });
            } else {
                // Modalit√† locale
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const threadIndex = threads.findIndex(t => t.id === threadId);
                
                if (threadIndex !== -1) {
                    threads[threadIndex].replies = (threads[threadIndex].replies || 0) + 1;
                    localStorage.setItem(storageKey, JSON.stringify(threads));
                }
            }
        }

        // Gestione emoticon
        function toggleEmoticonPicker(type) {
            const panel = document.getElementById(`${type}-emoticon-panel`);
            const isVisible = panel.classList.contains('show');
            
            // Chiudi tutti i panel
            document.querySelectorAll('.emoticon-panel').forEach(p => {
                p.classList.remove('show');
            });
            
            // Mostra quello corrente se non era visibile
            if (!isVisible) {
                panel.classList.add('show');
            }
        }

        // Aggiungi emoticon
        function addEmoticon(type, emoticon) {
            const input = type === 'chat' ? 
                document.getElementById('message-input') : 
                document.getElementById('comment-text');
            
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + emoticon + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + emoticon.length, cursorPos + emoticon.length);
            
            // Chiudi picker
            document.getElementById(`${type}-emoticon-panel`).classList.remove('show');
        }

        // Chiudi emoticon picker quando si clicca fuori
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.emoticon-picker')) {
                document.querySelectorAll('.emoticon-panel').forEach(panel => {
                    panel.classList.remove('show');
                });
            }
        });

        // Carica messaggi
        function loadMessages(sectionKey) {
            const dataPath = getDataPath(sectionKey, 'messages');
            if (!dataPath) return;

            if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && onValue && off) {
                const messagesRef = ref(window.firebaseDatabase, dataPath);
                
                // Cleanup previous listener
                if (messageListeners[sectionKey]) {
                    const oldRef = ref(window.firebaseDatabase, messageListeners[sectionKey].path);
                    off(oldRef, messageListeners[sectionKey].callback);
                }
                
                // Listen for new messages
                const callback = (snapshot) => {
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Ordina per timestamp
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    
                    displayMessages(messages);
                    updateMessageCounter(messages.length);
                };

                messageListeners[sectionKey] = { path: dataPath, callback: callback };
                onValue(messagesRef, callback);
            } else {
                // Carica da localStorage (modalit√† locale)
                const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
                const messages = JSON.parse(localStorage.getItem(storageKey) || '[]');
                messages.sort((a, b) => a.timestamp - b.timestamp);
                displayMessages(messages);
                updateMessageCounter(messages.length);
            }
        }

        // Mostra messaggi
        function displayMessages(messages) {
            const chatMessages = document.getElementById('chat-messages');
            
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Nessun messaggio in questa chat. Inizia la conversazione!
                    </div>
                `;
                return;
            }
            
            chatMessages.innerHTML = messages.map(msg => `
                <div class="message">
                    <div class="message-author">
                        ${msg.author}
                        <span class="message-time">${formatTime(msg.timestamp)}</span>
                    </div>
                    <div>${escapeHtml(msg.message)}</div>
                </div>
            `).join('');
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Salva messaggio locale
        function saveLocalMessage(section, messageData) {
            const dataPath = getDataPath(section, 'messages');
            if (!dataPath) return;

            const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
            const messages = JSON.parse(localStorage.getItem(storageKey) || '[]');
            messageData.timestamp = Date.now();
            messageData.id = 'msg_' + Date.now();
            messages.push(messageData);
            localStorage.setItem(storageKey, JSON.stringify(messages));
            
            // Ricarica messaggi
            loadMessages(section);
        }

        // Salva thread locale
        function saveLocalThread(section, threadData) {
            const dataPath = getDataPath(section, 'threads');
            if (!dataPath) return;

            const storageKey = `hc_${dataPath.replace(/\//g, '_')}`;
            const threads = JSON.parse(localStorage.getItem(storageKey) || '[]');
            threadData.createdAt = Date.now();
            threadData.id = 'thread_' + Date.now();
            threadData.replies = 0;
            threadData.views = 0;
            
            // Se non ha status, imposta come approved (per compatibilit√† con thread esistenti)
            if (!threadData.status) {
                threadData.status = 'approved';
            }
            
            // Assicurati che il contenuto sia salvato
            if (!threadData.content) {
                threadData.content = 'Nessun contenuto disponibile';
            }
            
            threads.push(threadData);
            localStorage.setItem(storageKey, JSON.stringify(threads));
            
            // Ricarica thread
            loadThreads(section);
        }

        // Invia messaggio (Firebase o locale)
        async function sendMessage() {
            if (!currentUser) {
                alert('Devi effettuare l\'accesso per inviare messaggi');
                return;
            }

            // Controlla accesso clan
            if (currentSection.startsWith('clan-') && getCurrentUserClan() === 'Nessuno') {
                alert('Devi appartenere a un clan per inviare messaggi qui!');
                return;
            }

            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-message-btn');
            const message = input.value.trim();
            
            if (!message) return;

            input.disabled = true;
            sendBtn.disabled = true;

            try {
                const messageData = {
                    author: currentUser.displayName || 'Utente',
                    authorId: currentUser.uid,
                    message: message
                };

                const dataPath = getDataPath(currentSection, 'messages');
                if (!dataPath) return;

                if (window.useFirebase && window.firebaseDatabase && firebaseReady && ref && push && serverTimestamp) {
                    // Invia a Firebase
                    const messagesRef = ref(window.firebaseDatabase, dataPath);
                    messageData.timestamp = serverTimestamp();
                    await push(messagesRef, messageData);
                } else {
                    // Salva in locale
                    saveLocalMessage(currentSection, messageData);
                }

                input.value = '';
            } catch (error) {
                console.error('Errore invio messaggio:', error);
                alert('Errore nell\'invio del messaggio');
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Utility
        function formatTime(timestamp) {
            if (!timestamp) return 'ora';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'ora';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} min fa`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} ore fa`;
            if (diff < 2592000000) return `${Math.floor(diff / 86400000)} giorni fa`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateMessageCounter(count) {
            messageCount = count;
            document.getElementById('messageCounter').textContent = `üí¨ ${count} messaggi`;
        }

        function cleanupListeners() {
            if (!window.useFirebase || !window.firebaseDatabase || !firebaseReady || !ref || !off) return;
            
            try {
                // Pulisci listeners messaggi
                Object.keys(messageListeners).forEach(section => {
                    const listener = messageListeners[section];
                    if (listener && listener.path && listener.callback) {
                        const messagesRef = ref(window.firebaseDatabase, listener.path);
                        off(messagesRef, listener.callback);
                    }
                });
                messageListeners = {};
                
                // Pulisci listeners thread
                Object.keys(threadListeners).forEach(section => {
                    const listener = threadListeners[section];
                    if (listener && listener.path && listener.callback) {
                        const threadsRef = ref(window.firebaseDatabase, listener.path);
                        off(threadsRef, listener.callback);
                    }
                });
                threadListeners = {};
            } catch (error) {
                console.error('Errore pulizia listeners:', error);
            }
        }

        // Event listeners
        function setupEventListeners() {
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    if (section) switchSection(section);
                });
            });

            // Chat input
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Comment input
            document.getElementById('comment-text').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    addComment();
                }
            });

            // Form inputs - Enter per submit
            ['email', 'password', 'username', 'clan'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleSubmit();
                        }
                    });
                }
            });

            // Thread creation form - Enter per submit
            document.getElementById('thread-title-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('thread-content-input').focus();
                }
            });

            document.getElementById('thread-content-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    createThread();
                }
            });

            // Escape per chiudere modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (document.getElementById('threadCreationModal').style.display === 'flex') {
                        hideThreadCreationModal();
                    }
                }
            });

            // Chiudi modal cliccando fuori
            document.getElementById('threadCreationModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('threadCreationModal')) {
                    hideThreadCreationModal();
                }
            });
        }
    </script>
</body>
</html>